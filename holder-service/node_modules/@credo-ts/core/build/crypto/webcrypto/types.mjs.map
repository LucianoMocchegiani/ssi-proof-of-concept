{"version":3,"file":"types.mjs","names":[],"sources":["../../../src/crypto/webcrypto/types.ts"],"sourcesContent":["/*\n *\n * Based on: https://www.w3.org/TR/WebCryptoAPI/\n */\n\nimport {\n  Ed25519PublicJwk,\n  type Jwk,\n  type KnownJwaSignatureAlgorithm,\n  P256PublicJwk,\n  P384PublicJwk,\n  P521PublicJwk,\n  RsaPublicJwk,\n  Secp256k1PublicJwk,\n} from '../../modules/kms'\nimport type { AnyUint8Array } from '../../types'\nimport { CredoWebCryptoError } from './CredoWebCryptoError'\nimport type { CredoWebCryptoKey } from './CredoWebCryptoKey'\n\nexport type CredoWebCryptoKeyPair = {\n  publicKey: CredoWebCryptoKey\n  privateKey: CredoWebCryptoKey\n}\n\ntype HashAlgorithmIdentifier = 'SHA-256' | 'SHA-384' | 'SHA-512'\n\n/*\n *\n * Sign and Verify Parameters\n *\n */\n\nexport type EcdsaParams = {\n  name: 'ECDSA'\n  hash: { name: HashAlgorithmIdentifier } | HashAlgorithmIdentifier\n}\n\nexport type Ed25519Params = { name: 'Ed25519' }\n\nexport type RsaSsaParams = {\n  name: 'RSASSA-PKCS1-v1_5' | 'RSA-PSS'\n  hash: { name: HashAlgorithmIdentifier } | HashAlgorithmIdentifier\n  saltLength?: number // Only for RSA-PSS\n}\n\n/*\n *\n * Key Generation Parameters\n *\n */\n\nexport type Ed25519KeyGenParams = { name: 'Ed25519' }\n\nexport type EcKeyGenParams = {\n  name: 'ECDSA'\n  namedCurve: 'P-256' | 'P-384' | 'P-521' | 'K-256'\n}\n\nexport type RsaHashedKeyGenParams = {\n  name: 'RSASSA-PKCS1-v1_5' | 'RSA-PSS'\n  modulusLength: number\n  publicExponent: AnyUint8Array\n  hash: { name: HashAlgorithmIdentifier }\n}\n\n/*\n *\n * Key Import Parameters\n *\n */\n\nexport type Ed25519KeyImportParams = { name: 'Ed25519' }\n\nexport type EcKeyImportParams = {\n  name: 'ECDSA'\n  namedCurve: 'P-256' | 'P-384' | 'K-256' | 'P-521'\n}\n\nexport type RsaHashedImportParams = {\n  name: 'RSASSA-PKCS1-v1_5' | 'RSA-PSS'\n  hash: { name: HashAlgorithmIdentifier }\n}\n\nexport type KeyUsage = 'sign' | 'verify' | 'encrypt' | 'decrypt' | 'wrapKey' | 'unwrapKey' | 'deriveKey' | 'deriveBits'\nexport type KeyFormat = 'jwk' | 'pkcs8' | 'spki' | 'raw'\nexport type KeyType = 'private' | 'public' | 'secret'\n\nexport type JsonWebKey = Jwk\n\nexport type HashAlgorithm = { name: HashAlgorithmIdentifier }\n\nexport type KeyImportParams = EcKeyImportParams | Ed25519KeyImportParams | RsaHashedImportParams\nexport type KeyGenAlgorithm = EcKeyGenParams | Ed25519KeyGenParams | RsaHashedKeyGenParams\nexport type KeySignParams = EcdsaParams | Ed25519Params | RsaSsaParams\nexport type KeyVerifyParams = EcdsaParams | Ed25519Params | RsaSsaParams\n\n/**\n * Derives the JWA algorithm name from KeySignParams or KeyVerifyParams\n * @param params - The signing or verification parameters\n * @returns The corresponding JWA algorithm string\n */\nexport function keyParamsToJwaAlgorithm(\n  params: KeySignParams | KeyVerifyParams,\n  key: CredoWebCryptoKey\n): KnownJwaSignatureAlgorithm {\n  if (params.name === 'Ed25519') {\n    if (!key.publicJwk.is(Ed25519PublicJwk)) {\n      throw new CredoWebCryptoError(\n        `Unsupported key for algorithm for Ed25519: ${key.publicJwk.jwkTypeHumanDescription}`\n      )\n    }\n\n    return 'EdDSA'\n  }\n\n  if (params.name === 'ECDSA') {\n    // Normalize hash parameter\n    const hashName = typeof params.hash === 'string' ? params.hash : params.hash.name\n\n    if (key.publicJwk.is(Secp256k1PublicJwk)) {\n      // Map ECDSA with different hash algorithms to JWA names\n      switch (hashName) {\n        case 'SHA-256':\n          return 'ES256K'\n        default:\n          throw new CredoWebCryptoError(`Unsupported hash algorithm for ECDSA with Secp255K1: ${hashName}`)\n      }\n    }\n\n    // Map ECDSA with different hash algorithms to JWA names\n    if (key.publicJwk.is(P256PublicJwk)) {\n      switch (hashName) {\n        case 'SHA-256':\n          return 'ES256'\n        default:\n          throw new CredoWebCryptoError(`Unsupported hash algorithm for ECDSA with P256: ${hashName}`)\n      }\n    }\n\n    // Map ECDSA with different hash algorithms to JWA names\n    if (key.publicJwk.is(P384PublicJwk)) {\n      switch (hashName) {\n        case 'SHA-384':\n          return 'ES384'\n        default:\n          throw new CredoWebCryptoError(`Unsupported hash algorithm for ECDSA with P384: ${hashName}`)\n      }\n    }\n\n    // Map ECDSA with different hash algorithms to JWA names\n    if (key.publicJwk.is(P521PublicJwk)) {\n      switch (hashName) {\n        case 'SHA-512':\n          return 'ES512'\n        default:\n          throw new CredoWebCryptoError(`Unsupported hash algorithm for ECDSA with P521: ${hashName}`)\n      }\n    }\n\n    throw new CredoWebCryptoError(\n      `Unsupported key ${key.publicJwk.jwkTypeHumanDescription} or hash algorithm '${hashName}' for ECDSA`\n    )\n  }\n\n  if (params.name === 'RSASSA-PKCS1-v1_5') {\n    // Normalize hash parameter\n    const hashName = typeof params.hash === 'string' ? params.hash : params.hash.name\n\n    if (!key.publicJwk.is(RsaPublicJwk)) {\n      throw new CredoWebCryptoError(\n        `Unsupported key for algorithm for RSASSA-PKCS1-v1_5: ${key.publicJwk.jwkTypeHumanDescription}`\n      )\n    }\n\n    // Map RSA-PKCS1 with different hash algorithms to JWA names\n    switch (hashName) {\n      case 'SHA-256':\n        return 'RS256'\n      case 'SHA-384':\n        return 'RS384'\n      case 'SHA-512':\n        return 'RS512'\n      default:\n        throw new CredoWebCryptoError(`Unsupported hash algorithm for RSASSA-PKCS1-v1_5: ${hashName}`)\n    }\n  }\n\n  if (params.name === 'RSA-PSS') {\n    // Normalize hash parameter\n    const hashName = typeof params.hash === 'string' ? params.hash : params.hash.name\n\n    if (!key.publicJwk.is(RsaPublicJwk)) {\n      throw new CredoWebCryptoError(\n        `Unsupported key for algorithm for RSA-PSS: ${key.publicJwk.jwkTypeHumanDescription}`\n      )\n    }\n\n    // Map RSA-PSS with different hash algorithms to JWA names\n    switch (hashName) {\n      case 'SHA-256':\n        return 'PS256'\n      case 'SHA-384':\n        return 'PS384'\n      case 'SHA-512':\n        return 'PS512'\n      default:\n        throw new CredoWebCryptoError(`Unsupported hash algorithm for RSA-PSS: ${hashName}`)\n    }\n  }\n\n  throw new CredoWebCryptoError(`Unsupported algorithm: ${params.name}`)\n}\n\n/**\n * Converts a JWA signature algorithm to the appropriate KeySignParams\n * This is the inverse of keyParamsToJwaAlgorithm\n * @param algorithm - The JWA signature algorithm (e.g., 'ES256', 'RS256', 'EdDSA')\n * @returns The signing parameters with the appropriate algorithm name and hash\n */\nexport function jwaAlgorithmToKeySignParams(algorithm: KnownJwaSignatureAlgorithm): KeySignParams {\n  switch (algorithm) {\n    // ECDSA algorithms\n    case 'ES256':\n    case 'ES256K':\n      return { name: 'ECDSA', hash: 'SHA-256' }\n    case 'ES384':\n      return { name: 'ECDSA', hash: 'SHA-384' }\n    case 'ES512':\n      return { name: 'ECDSA', hash: 'SHA-512' }\n\n    // EdDSA\n    case 'EdDSA':\n      return { name: 'Ed25519' }\n\n    // RSA PKCS1\n    case 'RS256':\n      return { name: 'RSASSA-PKCS1-v1_5', hash: 'SHA-256' }\n    case 'RS384':\n      return { name: 'RSASSA-PKCS1-v1_5', hash: 'SHA-384' }\n    case 'RS512':\n      return { name: 'RSASSA-PKCS1-v1_5', hash: 'SHA-512' }\n\n    // RSA PSS\n    case 'PS256':\n      return { name: 'RSA-PSS', hash: 'SHA-256' }\n    case 'PS384':\n      return { name: 'RSA-PSS', hash: 'SHA-384' }\n    case 'PS512':\n      return { name: 'RSA-PSS', hash: 'SHA-512' }\n\n    default:\n      throw new CredoWebCryptoError(`Unsupported JWA algorithm: ${algorithm}`)\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;AAqGA,SAAgB,wBACd,QACA,KAC4B;AAC5B,KAAI,OAAO,SAAS,WAAW;AAC7B,MAAI,CAAC,IAAI,UAAU,GAAG,iBAAiB,CACrC,OAAM,IAAI,oBACR,8CAA8C,IAAI,UAAU,0BAC7D;AAGH,SAAO;;AAGT,KAAI,OAAO,SAAS,SAAS;EAE3B,MAAM,WAAW,OAAO,OAAO,SAAS,WAAW,OAAO,OAAO,OAAO,KAAK;AAE7E,MAAI,IAAI,UAAU,GAAG,mBAAmB,CAEtC,SAAQ,UAAR;GACE,KAAK,UACH,QAAO;GACT,QACE,OAAM,IAAI,oBAAoB,wDAAwD,WAAW;;AAKvG,MAAI,IAAI,UAAU,GAAG,cAAc,CACjC,SAAQ,UAAR;GACE,KAAK,UACH,QAAO;GACT,QACE,OAAM,IAAI,oBAAoB,mDAAmD,WAAW;;AAKlG,MAAI,IAAI,UAAU,GAAG,cAAc,CACjC,SAAQ,UAAR;GACE,KAAK,UACH,QAAO;GACT,QACE,OAAM,IAAI,oBAAoB,mDAAmD,WAAW;;AAKlG,MAAI,IAAI,UAAU,GAAG,cAAc,CACjC,SAAQ,UAAR;GACE,KAAK,UACH,QAAO;GACT,QACE,OAAM,IAAI,oBAAoB,mDAAmD,WAAW;;AAIlG,QAAM,IAAI,oBACR,mBAAmB,IAAI,UAAU,wBAAwB,sBAAsB,SAAS,aACzF;;AAGH,KAAI,OAAO,SAAS,qBAAqB;EAEvC,MAAM,WAAW,OAAO,OAAO,SAAS,WAAW,OAAO,OAAO,OAAO,KAAK;AAE7E,MAAI,CAAC,IAAI,UAAU,GAAG,aAAa,CACjC,OAAM,IAAI,oBACR,wDAAwD,IAAI,UAAU,0BACvE;AAIH,UAAQ,UAAR;GACE,KAAK,UACH,QAAO;GACT,KAAK,UACH,QAAO;GACT,KAAK,UACH,QAAO;GACT,QACE,OAAM,IAAI,oBAAoB,qDAAqD,WAAW;;;AAIpG,KAAI,OAAO,SAAS,WAAW;EAE7B,MAAM,WAAW,OAAO,OAAO,SAAS,WAAW,OAAO,OAAO,OAAO,KAAK;AAE7E,MAAI,CAAC,IAAI,UAAU,GAAG,aAAa,CACjC,OAAM,IAAI,oBACR,8CAA8C,IAAI,UAAU,0BAC7D;AAIH,UAAQ,UAAR;GACE,KAAK,UACH,QAAO;GACT,KAAK,UACH,QAAO;GACT,KAAK,UACH,QAAO;GACT,QACE,OAAM,IAAI,oBAAoB,2CAA2C,WAAW;;;AAI1F,OAAM,IAAI,oBAAoB,0BAA0B,OAAO,OAAO;;;;;;;;AASxE,SAAgB,4BAA4B,WAAsD;AAChG,SAAQ,WAAR;EAEE,KAAK;EACL,KAAK,SACH,QAAO;GAAE,MAAM;GAAS,MAAM;GAAW;EAC3C,KAAK,QACH,QAAO;GAAE,MAAM;GAAS,MAAM;GAAW;EAC3C,KAAK,QACH,QAAO;GAAE,MAAM;GAAS,MAAM;GAAW;EAG3C,KAAK,QACH,QAAO,EAAE,MAAM,WAAW;EAG5B,KAAK,QACH,QAAO;GAAE,MAAM;GAAqB,MAAM;GAAW;EACvD,KAAK,QACH,QAAO;GAAE,MAAM;GAAqB,MAAM;GAAW;EACvD,KAAK,QACH,QAAO;GAAE,MAAM;GAAqB,MAAM;GAAW;EAGvD,KAAK,QACH,QAAO;GAAE,MAAM;GAAW,MAAM;GAAW;EAC7C,KAAK,QACH,QAAO;GAAE,MAAM;GAAW,MAAM;GAAW;EAC7C,KAAK,QACH,QAAO;GAAE,MAAM;GAAW,MAAM;GAAW;EAE7C,QACE,OAAM,IAAI,oBAAoB,8BAA8B,YAAY"}