{"version":3,"file":"Ed25519Signature2020.mjs","names":["jsonld"],"sources":["../../../../../../src/modules/vc/data-integrity/signature-suites/ed25519/Ed25519Signature2020.ts"],"sourcesContent":["import type { AnyUint8Array } from '../../../../../types'\nimport { MultiBaseEncoder, TypedArrayEncoder } from '../../../../../utils'\nimport { Ed25519PublicJwk, PublicJwk } from '../../../../kms'\nimport { CREDENTIALS_CONTEXT_V1_URL, SECURITY_CONTEXT_URL } from '../../../constants'\nimport type { DocumentLoader, JsonLdDoc, Proof, VerificationMethod } from '../../jsonldUtil'\nimport { _includesContext } from '../../jsonldUtil'\nimport jsonld from '../../libraries/jsonld'\nimport type { JwsLinkedDataSignatureOptions } from '../JwsLinkedDataSignature'\nimport { JwsLinkedDataSignature } from '../JwsLinkedDataSignature'\nimport { ED25519_SUITE_CONTEXT_URL_2020 } from './constants'\nimport { ed25519Signature2020Context } from './context2020'\n\ntype Ed25519Signature2020Options = Pick<\n  JwsLinkedDataSignatureOptions,\n  'key' | 'proof' | 'date' | 'useNativeCanonize' | 'LDKeyClass'\n>\n\nexport class Ed25519Signature2020 extends JwsLinkedDataSignature {\n  public static CONTEXT_URL = ED25519_SUITE_CONTEXT_URL_2020\n  public static CONTEXT = ed25519Signature2020Context.get(ED25519_SUITE_CONTEXT_URL_2020)\n\n  /**\n   * @param {object} options - Options hashmap.\n   *\n   * Either a `key` OR at least one of `signer`/`verifier` is required.\n   *\n   * @param {object} [options.key] - An optional key object (containing an\n   *   `id` property, and either `signer` or `verifier`, depending on the\n   *   intended operation. Useful for when the application is managing keys\n   *   itself (when using a KMS, you never have access to the private key,\n   *   and so should use the `signer` param instead).\n   * @param {Function} [options.signer] - Signer function that returns an\n   *   object with an async sign() method. This is useful when interfacing\n   *   with a KMS (since you don't get access to the private key and its\n   *   `signer()`, the KMS client gives you only the signer function to use).\n   * @param {Function} [options.verifier] - Verifier function that returns\n   *   an object with an async `verify()` method. Useful when working with a\n   *   KMS-provided verifier function.\n   *\n   * Advanced optional parameters and overrides.\n   *\n   * @param {object} [options.proof] - A JSON-LD document with options to use\n   *   for the `proof` node. Any other custom fields can be provided here\n   *   using a context different from security-v2).\n   * @param {string|Date} [options.date] - Signing date to use if not passed.\n   * @param {boolean} [options.useNativeCanonize] - Whether to use a native\n   *   canonize algorithm.\n   */\n  public constructor(options: Ed25519Signature2020Options) {\n    super({\n      type: 'Ed25519Signature2020',\n      algorithm: 'EdDSA',\n      LDKeyClass: options.LDKeyClass,\n      contextUrl: ED25519_SUITE_CONTEXT_URL_2020,\n      key: options.key,\n      proof: options.proof,\n      date: options.date,\n      useNativeCanonize: options.useNativeCanonize,\n    })\n    this.requiredKeyType = 'Ed25519VerificationKey2020'\n  }\n\n  public async assertVerificationMethod(document: JsonLdDoc) {\n    if (!_includesCompatibleContext({ document: document })) {\n      // For DID Documents, since keys do not have their own contexts,\n      // the suite context is usually provided by the documentLoader logic\n      throw new TypeError(\n        `The '@context' of the verification method (key) MUST contain the context url \"${this.contextUrl}\".`\n      )\n    }\n\n    if (!_isEd2020Key(document)) {\n      const verificationMethodType = jsonld.getValues(document, 'type')[0]\n      throw new Error(\n        `Unsupported verification method type '${verificationMethodType}'. Verification method type MUST be 'Ed25519VerificationKey2020'.`\n      )\n    }\n    if (_isEd2020Key(document) && !_includesEd2020Context(document)) {\n      throw new Error(\n        `For verification method type 'Ed25519VerificationKey2020' the '@context' MUST contain the context url \"${ED25519_SUITE_CONTEXT_URL_2020}\".`\n      )\n    }\n\n    // ensure verification method has not been revoked\n    if (document.revoked !== undefined) {\n      throw new Error('The verification method has been revoked.')\n    }\n  }\n\n  public async getVerificationMethod(options: { proof: Proof; documentLoader?: DocumentLoader }) {\n    let verificationMethod = await super.getVerificationMethod({\n      proof: options.proof,\n      documentLoader: options.documentLoader,\n    })\n\n    // convert Ed25519VerificationKey2020 to Ed25519VerificationKey2018\n    if (_isEd2020Key(verificationMethod) && _includesEd2020Context(verificationMethod)) {\n      // -- convert multibase to base58 --\n      const publicJwk = PublicJwk.fromFingerprint(verificationMethod.publicKeyMultibase)\n      if (!publicJwk.is(Ed25519PublicJwk)) {\n        throw new Error('Expected multibase key to be of type Ed25519.')\n      }\n\n      // -- update type\n      verificationMethod.type = 'Ed25519VerificationKey2018'\n\n      verificationMethod = {\n        ...verificationMethod,\n        publicKeyMultibase: undefined,\n        publicKeyBase58: TypedArrayEncoder.toBase58(publicJwk.publicKey.publicKey),\n      }\n    }\n\n    return verificationMethod\n  }\n\n  /**\n   * Ensures the document to be signed contains the required signature suite\n   * specific `@context`, by either adding it (if `addSuiteContext` is true),\n   * or throwing an error if it's missing.\n   *\n   * @override\n   *\n   * @param {object} options - Options hashmap.\n   * @param {object} options.document - JSON-LD document to be signed.\n   * @param {boolean} options.addSuiteContext - Add suite context?\n   */\n  public ensureSuiteContext(options: { document: JsonLdDoc; addSuiteContext: boolean }) {\n    if (_includesCompatibleContext({ document: options.document })) {\n      return\n    }\n\n    super.ensureSuiteContext({ document: options.document, addSuiteContext: options.addSuiteContext })\n  }\n\n  /**\n   * Checks whether a given proof exists in the document.\n   *\n   * @override\n   *\n   * @param {object} options - Options hashmap.\n   * @param {object} options.proof - A proof.\n   * @param {object} options.document - A JSON-LD document.\n   * @param {object} options.purpose - A jsonld-signatures ProofPurpose\n   *  instance (e.g. AssertionProofPurpose, AuthenticationProofPurpose, etc).\n   * @param {Function} options.documentLoader  - A secure document loader (it is\n   *   recommended to use one that provides static known documents, instead of\n   *   fetching from the web) for returning contexts, controller documents,\n   *   keys, and other relevant URLs needed for the proof.\n   *\n   * @returns {Promise<boolean>} Whether a match for the proof was found.\n   */\n  public async matchProof(options: {\n    proof: Proof\n    document: VerificationMethod\n    // biome-ignore lint/suspicious/noExplicitAny: no explanation\n    purpose: any\n    documentLoader?: DocumentLoader\n  }) {\n    if (!_includesCompatibleContext({ document: options.document })) {\n      return false\n    }\n    return super.matchProof({\n      proof: options.proof,\n      document: options.document,\n      purpose: options.purpose,\n      documentLoader: options.documentLoader,\n    })\n  }\n\n  /**\n   * @param options - Options hashmap.\n   * @param options.verifyData - The data to sign.\n   * @param options.proof - A JSON-LD document with options to use\n   *   for the `proof` node. Any other custom fields can be provided here\n   *   using a context different from `security-v2`.\n   *\n   * @returns The proof containing the signature value.\n   */\n  public async sign(options: { verifyData: AnyUint8Array; proof: Proof }) {\n    if (!(this.signer && typeof this.signer.sign === 'function')) {\n      throw new Error('A signer API has not been specified.')\n    }\n    const signature = await this.signer.sign({ data: options.verifyData })\n    const encodedSignature = MultiBaseEncoder.encode(signature, 'base58btc')\n\n    // create detached content signature\n    options.proof.proofValue = encodedSignature\n    return options.proof\n  }\n\n  /**\n   * @param options - Options hashmap.\n   * @param options.verifyData - The data to verify.\n   * @param options.verificationMethod - A verification method.\n   * @param options.proof - The proof to be verified.\n   *\n   * @returns Resolves with the verification result.\n   */\n  public async verifySignature(options: {\n    verifyData: AnyUint8Array\n    verificationMethod: VerificationMethod\n    proof: Proof\n  }) {\n    if (!(options.proof.proofValue && typeof options.proof.proofValue === 'string')) {\n      throw new TypeError('The proof does not include a valid \"proofValue\" property.')\n    }\n    const signature = MultiBaseEncoder.decode(options.proof.proofValue).data\n\n    let { verifier } = this\n    if (!verifier) {\n      const key = await this.LDKeyClass.from(options.verificationMethod)\n      verifier = key.verifier()\n    }\n    return verifier.verify({ data: options.verifyData, signature })\n  }\n}\n\nfunction _includesCompatibleContext(options: { document: JsonLdDoc }) {\n  // Handle the unfortunate Ed25519Signature2018 / credentials/v1 collision\n  const hasEd2020 = _includesContext({\n    document: options.document,\n    contextUrl: ED25519_SUITE_CONTEXT_URL_2020,\n  })\n  const hasCred = _includesContext({ document: options.document, contextUrl: CREDENTIALS_CONTEXT_V1_URL })\n  const hasSecV2 = _includesContext({ document: options.document, contextUrl: SECURITY_CONTEXT_URL })\n\n  // Either one by itself is fine, for this suite\n  return hasEd2020 || hasCred || hasSecV2\n}\n\nfunction _isEd2020Key(verificationMethod: JsonLdDoc) {\n  // @ts-expect-error - .hasValue is not part of the public API\n  return jsonld.hasValue(verificationMethod, 'type', 'Ed25519VerificationKey2020')\n}\n\nfunction _includesEd2020Context(document: JsonLdDoc) {\n  return _includesContext({ document, contextUrl: ED25519_SUITE_CONTEXT_URL_2020 })\n}\n"],"mappings":"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"}