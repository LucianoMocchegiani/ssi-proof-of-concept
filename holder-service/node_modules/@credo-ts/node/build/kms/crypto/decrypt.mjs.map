{"version":3,"file":"decrypt.mjs","names":[],"sources":["../../../src/kms/crypto/decrypt.ts"],"sourcesContent":["import { Buffer } from 'node:buffer'\nimport type { DecipherGCM } from 'node:crypto'\nimport { createDecipheriv, createSecretKey, timingSafeEqual } from 'node:crypto'\nimport { type AnyUint8Array, Kms, type Uint8ArrayBuffer } from '@credo-ts/core'\n\nimport { performSign } from './sign'\n\nexport async function performDecrypt(\n  key: Kms.KmsJwkPrivateOct,\n  dataDecryption: Kms.KmsDecryptDataDecryption,\n  encrypted: AnyUint8Array\n): Promise<{ data: Uint8ArrayBuffer }> {\n  const secretKeyBytes = Buffer.from(key.k, 'base64url')\n  const nodeKey = createSecretKey(secretKeyBytes)\n\n  // Create decipher with key and IV\n  if (dataDecryption.algorithm === 'A128CBC' || dataDecryption.algorithm === 'A256CBC') {\n    const nodeAlgorithm = dataDecryption.algorithm === 'A128CBC' ? 'aes-128-cbc' : 'aes-256-cbc'\n\n    const decipher = createDecipheriv(nodeAlgorithm, nodeKey, dataDecryption.iv)\n\n    // Get decrypted data\n    const data = Buffer.concat([decipher.update(encrypted), decipher.final()])\n\n    return { data }\n  }\n  if (\n    dataDecryption.algorithm === 'A128GCM' ||\n    dataDecryption.algorithm === 'A192GCM' ||\n    dataDecryption.algorithm === 'A256GCM'\n  ) {\n    const nodeAlgorithm =\n      dataDecryption.algorithm === 'A128GCM'\n        ? 'aes-128-gcm'\n        : dataDecryption.algorithm === 'A192GCM'\n          ? 'aes-192-gcm'\n          : 'aes-256-gcm'\n\n    const decipher = createDecipheriv(nodeAlgorithm, nodeKey, dataDecryption.iv)\n\n    // Set auth tag before decryption for authenticated modes\n    decipher.setAuthTag(dataDecryption.tag)\n\n    // If AAD was used during encryption, it must be provided for decryption\n    if (dataDecryption.aad) {\n      decipher.setAAD(dataDecryption.aad)\n    }\n\n    // Get decrypted data\n    const data = Buffer.concat([decipher.update(encrypted), decipher.final()])\n\n    return { data }\n  }\n  if (\n    dataDecryption.algorithm === 'A128CBC-HS256' ||\n    dataDecryption.algorithm === 'A192CBC-HS384' ||\n    dataDecryption.algorithm === 'A256CBC-HS512'\n  ) {\n    // Map algorithms to their corresponding CBC and HMAC settings\n    const algSettings = {\n      'A128CBC-HS256': { cbcAlg: 'aes-128-cbc', hmacAlg: 'HS256', keySize: 16 } as const,\n      'A192CBC-HS384': { cbcAlg: 'aes-192-cbc', hmacAlg: 'HS384', keySize: 24 } as const,\n      'A256CBC-HS512': { cbcAlg: 'aes-256-cbc', hmacAlg: 'HS512', keySize: 32 } as const,\n    }[dataDecryption.algorithm]\n\n    // Split the input key into MAC and ENC keys (MAC key is first half, ENC key is second half)\n    const macKey = secretKeyBytes.subarray(0, algSettings.keySize)\n    const encKey = createSecretKey(secretKeyBytes.subarray(algSettings.keySize))\n\n    // Calculate authentication tag for verification\n    // AL (Associated Length) is 64-bit big-endian length of AAD in bits\n    const al = Buffer.alloc(8)\n    const aadLength = dataDecryption.aad ? dataDecryption.aad.length * 8 : 0\n    al.writeBigUInt64BE(BigInt(aadLength))\n\n    // Create concatenated buffer for MAC verification\n    const macData = Buffer.concat([dataDecryption.aad ?? Buffer.alloc(0), dataDecryption.iv, encrypted, al])\n\n    // Verify the authentication tag\n    const hmac = await performSign({ kty: 'oct', k: macKey.toString('base64url') }, algSettings.hmacAlg, macData)\n    const calculatedTag = Buffer.from(hmac).subarray(0, algSettings.keySize) // Truncate to appropriate size\n\n    if (!timingSafeEqual(calculatedTag, dataDecryption.tag)) {\n      throw new Kms.KeyManagementError(\n        `Error during verification of authentication tag with decryption algorithm '${dataDecryption.algorithm}'`\n      )\n    }\n\n    // After verification, perform decryption\n    const decipher = createDecipheriv(algSettings.cbcAlg, encKey, dataDecryption.iv)\n    const data = Buffer.concat([decipher.update(encrypted), decipher.final()])\n\n    return { data }\n  }\n  if (dataDecryption.algorithm === 'C20P') {\n    const decipher: DecipherGCM = createDecipheriv('chacha20-poly1305', nodeKey, dataDecryption.iv, {\n      authTagLength: 16,\n    })\n\n    // Set auth tag before decryption\n    decipher.setAuthTag(dataDecryption.tag)\n\n    // If AAD was used during encryption, it must be provided for decryption\n    if (dataDecryption.aad) {\n      decipher.setAAD(dataDecryption.aad)\n    }\n\n    // Get decrypted data\n    const data = Buffer.concat([decipher.update(encrypted), decipher.final()])\n\n    return { data }\n  }\n\n  throw new Kms.KeyManagementAlgorithmNotSupportedError(\n    `JWA content decryption algorithm '${dataDecryption.algorithm}'`,\n    'node'\n  )\n}\n"],"mappings":";;;;;;AAOA,eAAsB,eACpB,KACA,gBACA,WACqC;CACrC,MAAM,iBAAiB,OAAO,KAAK,IAAI,GAAG,YAAY;CACtD,MAAM,UAAU,gBAAgB,eAAe;AAG/C,KAAI,eAAe,cAAc,aAAa,eAAe,cAAc,WAAW;EAGpF,MAAM,WAAW,iBAFK,eAAe,cAAc,YAAY,gBAAgB,eAE9B,SAAS,eAAe,GAAG;AAK5E,SAAO,EAAE,MAFI,OAAO,OAAO,CAAC,SAAS,OAAO,UAAU,EAAE,SAAS,OAAO,CAAC,CAAC,EAE3D;;AAEjB,KACE,eAAe,cAAc,aAC7B,eAAe,cAAc,aAC7B,eAAe,cAAc,WAC7B;EAQA,MAAM,WAAW,iBANf,eAAe,cAAc,YACzB,gBACA,eAAe,cAAc,YAC3B,gBACA,eAEyC,SAAS,eAAe,GAAG;AAG5E,WAAS,WAAW,eAAe,IAAI;AAGvC,MAAI,eAAe,IACjB,UAAS,OAAO,eAAe,IAAI;AAMrC,SAAO,EAAE,MAFI,OAAO,OAAO,CAAC,SAAS,OAAO,UAAU,EAAE,SAAS,OAAO,CAAC,CAAC,EAE3D;;AAEjB,KACE,eAAe,cAAc,mBAC7B,eAAe,cAAc,mBAC7B,eAAe,cAAc,iBAC7B;EAEA,MAAM,cAAc;GAClB,iBAAiB;IAAE,QAAQ;IAAe,SAAS;IAAS,SAAS;IAAI;GACzE,iBAAiB;IAAE,QAAQ;IAAe,SAAS;IAAS,SAAS;IAAI;GACzE,iBAAiB;IAAE,QAAQ;IAAe,SAAS;IAAS,SAAS;IAAI;GAC1E,CAAC,eAAe;EAGjB,MAAM,SAAS,eAAe,SAAS,GAAG,YAAY,QAAQ;EAC9D,MAAM,SAAS,gBAAgB,eAAe,SAAS,YAAY,QAAQ,CAAC;EAI5E,MAAM,KAAK,OAAO,MAAM,EAAE;EAC1B,MAAM,YAAY,eAAe,MAAM,eAAe,IAAI,SAAS,IAAI;AACvE,KAAG,iBAAiB,OAAO,UAAU,CAAC;EAGtC,MAAM,UAAU,OAAO,OAAO;GAAC,eAAe,OAAO,OAAO,MAAM,EAAE;GAAE,eAAe;GAAI;GAAW;GAAG,CAAC;EAGxG,MAAM,OAAO,MAAM,YAAY;GAAE,KAAK;GAAO,GAAG,OAAO,SAAS,YAAY;GAAE,EAAE,YAAY,SAAS,QAAQ;AAG7G,MAAI,CAAC,gBAFiB,OAAO,KAAK,KAAK,CAAC,SAAS,GAAG,YAAY,QAAQ,EAEpC,eAAe,IAAI,CACrD,OAAM,IAAI,IAAI,mBACZ,8EAA8E,eAAe,UAAU,GACxG;EAIH,MAAM,WAAW,iBAAiB,YAAY,QAAQ,QAAQ,eAAe,GAAG;AAGhF,SAAO,EAAE,MAFI,OAAO,OAAO,CAAC,SAAS,OAAO,UAAU,EAAE,SAAS,OAAO,CAAC,CAAC,EAE3D;;AAEjB,KAAI,eAAe,cAAc,QAAQ;EACvC,MAAM,WAAwB,iBAAiB,qBAAqB,SAAS,eAAe,IAAI,EAC9F,eAAe,IAChB,CAAC;AAGF,WAAS,WAAW,eAAe,IAAI;AAGvC,MAAI,eAAe,IACjB,UAAS,OAAO,eAAe,IAAI;AAMrC,SAAO,EAAE,MAFI,OAAO,OAAO,CAAC,SAAS,OAAO,UAAU,EAAE,SAAS,OAAO,CAAC,CAAC,EAE3D;;AAGjB,OAAM,IAAI,IAAI,wCACZ,qCAAqC,eAAe,UAAU,IAC9D,OACD"}