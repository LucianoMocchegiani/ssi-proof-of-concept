{"version":3,"file":"verify.mjs","names":["verify","_verify"],"sources":["../../../src/kms/crypto/verify.ts"],"sourcesContent":["import { Buffer } from 'node:buffer'\nimport {\n  verify as _verify,\n  constants,\n  createHmac,\n  createPublicKey,\n  createSecretKey,\n  timingSafeEqual,\n} from 'node:crypto'\nimport { promisify } from 'node:util'\nimport { type AnyUint8Array, type CanBePromise, Kms, TypedArrayEncoder } from '@credo-ts/core'\n\nimport { mapJwaSignatureAlgorithmToNode } from './sign'\n\nconst verify = promisify(_verify)\n\nexport function performVerify(\n  key: Kms.KmsJwkPrivate | Kms.KmsJwkPublicEc | Kms.KmsJwkPublicOkp | Kms.KmsJwkPublicRsa,\n  algorithm: Kms.KnownJwaSignatureAlgorithm,\n  data: AnyUint8Array,\n  signature: AnyUint8Array\n): CanBePromise<boolean> {\n  const nodeAlgorithm = mapJwaSignatureAlgorithmToNode(algorithm)\n  const nodeKey =\n    key.kty === 'oct' ? createSecretKey(TypedArrayEncoder.fromBase64(key.k)) : createPublicKey({ format: 'jwk', key })\n\n  switch (key.kty) {\n    case 'RSA':\n    case 'OKP': {\n      const nodeKeyInput = algorithm.startsWith('PS')\n        ? // For RSA-PSS, we need to set padding\n          {\n            key: nodeKey,\n            padding: constants.RSA_PKCS1_PSS_PADDING,\n            saltLength: Number.parseInt(algorithm.slice(2), 10) / 8,\n          }\n        : nodeKey\n\n      return verify(nodeAlgorithm, data, nodeKeyInput, signature)\n    }\n    case 'EC': {\n      // Node expects DER encoded signature, but we input raw\n      return verify(nodeAlgorithm, data, nodeKey, Kms.rawEcSignatureToDer(signature, key.crv))\n    }\n    case 'oct': {\n      const expectedHmac = createHmac(nodeAlgorithm as string, nodeKey)\n        .update(data)\n        .digest()\n\n      return timingSafeEqual(expectedHmac, Buffer.from(signature))\n    }\n    default:\n      // @ts-expect-error\n      throw new Kms.KeyManagementAlgorithmNotSupportedError(`kty '${key.kty}'`, 'node')\n  }\n}\n"],"mappings":";;;;;;;AAcA,MAAMA,WAAS,UAAUC,OAAQ;AAEjC,SAAgB,cACd,KACA,WACA,MACA,WACuB;CACvB,MAAM,gBAAgB,+BAA+B,UAAU;CAC/D,MAAM,UACJ,IAAI,QAAQ,QAAQ,gBAAgB,kBAAkB,WAAW,IAAI,EAAE,CAAC,GAAG,gBAAgB;EAAE,QAAQ;EAAO;EAAK,CAAC;AAEpH,SAAQ,IAAI,KAAZ;EACE,KAAK;EACL,KAAK,MAUH,QAAOD,SAAO,eAAe,MATR,UAAU,WAAW,KAAK,GAE3C;GACE,KAAK;GACL,SAAS,UAAU;GACnB,YAAY,OAAO,SAAS,UAAU,MAAM,EAAE,EAAE,GAAG,GAAG;GACvD,GACD,SAE6C,UAAU;EAE7D,KAAK,KAEH,QAAOA,SAAO,eAAe,MAAM,SAAS,IAAI,oBAAoB,WAAW,IAAI,IAAI,CAAC;EAE1F,KAAK,MAKH,QAAO,gBAJc,WAAW,eAAyB,QAAQ,CAC9D,OAAO,KAAK,CACZ,QAAQ,EAE0B,OAAO,KAAK,UAAU,CAAC;EAE9D,QAEE,OAAM,IAAI,IAAI,wCAAwC,QAAQ,IAAI,IAAI,IAAI,OAAO"}