{"version":3,"file":"createKey.mjs","names":["generateKeyPair","_generateKeyPair"],"sources":["../../../src/kms/crypto/createKey.ts"],"sourcesContent":["import { generateKeyPair as _generateKeyPair, randomBytes } from 'node:crypto'\nimport { promisify } from 'node:util'\nimport { Kms } from '@credo-ts/core'\n\nconst generateKeyPair = promisify(_generateKeyPair)\n\nconst nodeSupportedEcCrvs = ['P-256', 'P-384', 'P-521', 'secp256k1'] satisfies Kms.KmsJwkPublicEc['crv'][]\nexport type NodeKmsSupportedEcCrvs = (typeof nodeSupportedEcCrvs)[number]\nexport function assertNodeSupportedEcCrv(\n  options: Kms.KmsCreateKeyTypeEc\n): asserts options is Kms.KmsCreateKeyTypeEc & { crv: NodeKmsSupportedEcCrvs } {\n  if (!nodeSupportedEcCrvs.includes(options.crv as NodeKmsSupportedEcCrvs)) {\n    throw new Kms.KeyManagementAlgorithmNotSupportedError(`crv '${options.crv}' for kty '${options.kty}'`, 'node')\n  }\n}\n\nexport async function createEcKey({ crv }: Kms.KmsCreateKeyTypeEc & { crv: NodeKmsSupportedEcCrvs }) {\n  const { publicKey, privateKey } = await generateKeyPair('ec', {\n    namedCurve: crv,\n  })\n\n  const privateJwk = privateKey.export({\n    format: 'jwk',\n  })\n\n  const publicJwk = publicKey.export({\n    format: 'jwk',\n  })\n\n  return {\n    privateJwk: privateJwk as Kms.KmsJwkPrivateEc,\n    publicJwk: publicJwk as Kms.KmsJwkPublicEc,\n  }\n}\n\nexport async function createRsaKey({ modulusLength }: Kms.KmsCreateKeyTypeRsa) {\n  const { publicKey, privateKey } = await generateKeyPair('rsa', {\n    modulusLength,\n  })\n\n  const privateJwk = privateKey.export({\n    format: 'jwk',\n  })\n\n  const publicJwk = publicKey.export({\n    format: 'jwk',\n  })\n\n  return {\n    privateJwk: privateJwk as Kms.KmsJwkPrivateRsa,\n    publicJwk: publicJwk as Kms.KmsJwkPublicRsa,\n  }\n}\n\nconst nodeSupportedOkpCrvs = ['Ed25519', 'X25519'] satisfies Kms.KmsJwkPublicOkp['crv'][]\ntype NodeKmsSupportedOkpCrvs = (typeof nodeSupportedOkpCrvs)[number]\nexport function assertNodeSupportedOkpCrv(\n  options: Kms.KmsCreateKeyTypeOkp\n): asserts options is Kms.KmsCreateKeyTypeOkp & { crv: NodeKmsSupportedOkpCrvs } {\n  if (!nodeSupportedOkpCrvs.includes(options.crv as NodeKmsSupportedOkpCrvs)) {\n    throw new Kms.KeyManagementAlgorithmNotSupportedError(`crv '${options.crv}' for kty '${options.kty}'`, 'node')\n  }\n}\n\nexport async function createOkpKey({ crv }: Kms.KmsCreateKeyTypeOkp & { crv: NodeKmsSupportedOkpCrvs }) {\n  const { publicKey, privateKey } =\n    crv === 'Ed25519' ? await generateKeyPair('ed25519') : await generateKeyPair('x25519')\n\n  const privateJwk = privateKey.export({\n    format: 'jwk',\n  })\n\n  const publicJwk = publicKey.export({\n    format: 'jwk',\n  })\n\n  return {\n    privateJwk: privateJwk as Kms.KmsJwkPrivateOkp,\n    publicJwk: publicJwk as Kms.KmsJwkPublicOkp,\n  }\n}\n\nconst nodeSupportedOctAlgorithms = ['aes', 'hmac'] satisfies Kms.KmsCreateKeyTypeOct['algorithm'][]\ntype NodeSupportedOctAlgorithms = (typeof nodeSupportedOctAlgorithms)[number]\nexport function assertNodeSupportedOctAlgorithm(\n  options: Kms.KmsCreateKeyTypeOct\n): asserts options is Kms.KmsCreateKeyTypeOct & { algorithm: NodeSupportedOctAlgorithms } {\n  if (!nodeSupportedOctAlgorithms.includes(options.algorithm as NodeSupportedOctAlgorithms)) {\n    throw new Kms.KeyManagementAlgorithmNotSupportedError(\n      `algorithm '${options.algorithm}' for kty '${options.kty}'`,\n      'node'\n    )\n  }\n}\n\nexport async function createOctKey(options: Kms.KmsCreateKeyTypeOct & { algorithm: NodeSupportedOctAlgorithms }) {\n  const secretBytes = randomBytes(options.length >> 3)\n\n  const privateJwk = {\n    kty: 'oct',\n    k: secretBytes.toString('base64url'),\n  }\n\n  const { k, ...publicJwk } = privateJwk\n\n  return {\n    privateJwk: privateJwk as Kms.KmsJwkPrivateOct,\n    publicJwk: publicJwk as Kms.KmsJwkPublicOct,\n  }\n}\n"],"mappings":";;;;;AAIA,MAAMA,oBAAkB,UAAUC,gBAAiB;AAEnD,MAAM,sBAAsB;CAAC;CAAS;CAAS;CAAS;CAAY;AAEpE,SAAgB,yBACd,SAC6E;AAC7E,KAAI,CAAC,oBAAoB,SAAS,QAAQ,IAA8B,CACtE,OAAM,IAAI,IAAI,wCAAwC,QAAQ,QAAQ,IAAI,aAAa,QAAQ,IAAI,IAAI,OAAO;;AAIlH,eAAsB,YAAY,EAAE,OAAiE;CACnG,MAAM,EAAE,WAAW,eAAe,MAAMD,kBAAgB,MAAM,EAC5D,YAAY,KACb,CAAC;AAUF,QAAO;EACL,YATiB,WAAW,OAAO,EACnC,QAAQ,OACT,CAAC;EAQA,WANgB,UAAU,OAAO,EACjC,QAAQ,OACT,CAAC;EAKD;;AAGH,eAAsB,aAAa,EAAE,iBAA0C;CAC7E,MAAM,EAAE,WAAW,eAAe,MAAMA,kBAAgB,OAAO,EAC7D,eACD,CAAC;AAUF,QAAO;EACL,YATiB,WAAW,OAAO,EACnC,QAAQ,OACT,CAAC;EAQA,WANgB,UAAU,OAAO,EACjC,QAAQ,OACT,CAAC;EAKD;;AAGH,MAAM,uBAAuB,CAAC,WAAW,SAAS;AAElD,SAAgB,0BACd,SAC+E;AAC/E,KAAI,CAAC,qBAAqB,SAAS,QAAQ,IAA+B,CACxE,OAAM,IAAI,IAAI,wCAAwC,QAAQ,QAAQ,IAAI,aAAa,QAAQ,IAAI,IAAI,OAAO;;AAIlH,eAAsB,aAAa,EAAE,OAAmE;CACtG,MAAM,EAAE,WAAW,eACjB,QAAQ,YAAY,MAAMA,kBAAgB,UAAU,GAAG,MAAMA,kBAAgB,SAAS;AAUxF,QAAO;EACL,YATiB,WAAW,OAAO,EACnC,QAAQ,OACT,CAAC;EAQA,WANgB,UAAU,OAAO,EACjC,QAAQ,OACT,CAAC;EAKD;;AAGH,MAAM,6BAA6B,CAAC,OAAO,OAAO;AAElD,SAAgB,gCACd,SACwF;AACxF,KAAI,CAAC,2BAA2B,SAAS,QAAQ,UAAwC,CACvF,OAAM,IAAI,IAAI,wCACZ,cAAc,QAAQ,UAAU,aAAa,QAAQ,IAAI,IACzD,OACD;;AAIL,eAAsB,aAAa,SAA8E;CAG/G,MAAM,aAAa;EACjB,KAAK;EACL,GAJkB,YAAY,QAAQ,UAAU,EAAE,CAInC,SAAS,YAAY;EACrC;CAED,MAAM,EAAE,GAAG,GAAG,cAAc;AAE5B,QAAO;EACO;EACD;EACZ"}