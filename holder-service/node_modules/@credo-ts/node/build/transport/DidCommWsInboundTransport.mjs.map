{"version":3,"file":"DidCommWsInboundTransport.mjs","names":[],"sources":["../../src/transport/DidCommWsInboundTransport.ts"],"sourcesContent":["import type { AgentContext, Logger } from '@credo-ts/core'\nimport { CredoError, EventEmitter, utils } from '@credo-ts/core'\nimport type {\n  DidCommEncryptedMessage,\n  DidCommInboundTransport,\n  DidCommMessageReceivedEvent,\n  DidCommTransportSession,\n} from '@credo-ts/didcomm'\nimport { DidCommEventTypes, DidCommModuleConfig, DidCommTransportService } from '@credo-ts/didcomm'\nimport WebSocket, { WebSocketServer } from 'ws'\n\nexport class DidCommWsInboundTransport implements DidCommInboundTransport {\n  private socketServer: WebSocketServer\n  private logger!: Logger\n\n  // We're using a `socketId` just for the prevention of calling the connection handler twice.\n  private socketIds: Record<string, unknown> = {}\n\n  public constructor({\n    server,\n    port,\n  }: { server: WebSocketServer; port?: undefined } | { server?: undefined; port: number }) {\n    this.socketServer = server ?? new WebSocketServer({ port })\n  }\n\n  public async start(agentContext: AgentContext) {\n    const transportService = agentContext.dependencyManager.resolve(DidCommTransportService)\n\n    this.logger = agentContext.config.logger\n\n    const didcommConfig = agentContext.dependencyManager.resolve(DidCommModuleConfig)\n    const wsEndpoint = didcommConfig.endpoints.find((e) => e.startsWith('ws'))\n    this.logger.debug('Starting WS inbound transport', {\n      endpoint: wsEndpoint,\n    })\n\n    this.socketServer.on('connection', (socket: WebSocket) => {\n      const socketId = utils.uuid()\n      this.logger.debug('Socket connected.')\n\n      if (!this.socketIds[socketId]) {\n        this.logger.debug(`Saving new socket with id ${socketId}.`)\n        this.socketIds[socketId] = socket\n        const session = new WebSocketTransportSession(socketId, socket, this.logger)\n        this.listenOnWebSocketMessages(agentContext, socket, session)\n        socket.on('close', () => {\n          this.logger.debug('Socket closed.')\n          transportService.removeSession(session)\n        })\n      } else {\n        this.logger.debug(`Socket with id ${socketId} already exists.`)\n      }\n    })\n  }\n\n  public async stop() {\n    this.logger.debug('Closing WebSocket Server')\n\n    return new Promise<void>((resolve, reject) => {\n      this.socketServer.close((error) => {\n        if (error) {\n          reject(error)\n        }\n        resolve()\n      })\n    })\n  }\n\n  private listenOnWebSocketMessages(agentContext: AgentContext, socket: WebSocket, session: DidCommTransportSession) {\n    // biome-ignore lint/suspicious/noExplicitAny: no explanation\n    socket.addEventListener('message', async (event: any) => {\n      this.logger.debug('WebSocket message event received.', { url: event.target.url })\n      try {\n        const encryptedMessage = JSON.parse(event.data) as DidCommEncryptedMessage\n\n        const eventEmitter = agentContext.dependencyManager.resolve(EventEmitter)\n        eventEmitter.emit<DidCommMessageReceivedEvent>(agentContext, {\n          type: DidCommEventTypes.DidCommMessageReceived,\n          payload: {\n            message: encryptedMessage,\n            session: session,\n          },\n        })\n      } catch (error) {\n        this.logger.error(`Error processing message: ${error}`)\n      }\n    })\n  }\n}\n\nexport class WebSocketTransportSession implements DidCommTransportSession {\n  public id: string\n  public readonly type = 'WebSocket'\n  public socket: WebSocket\n  private logger: Logger\n\n  public constructor(id: string, socket: WebSocket, logger: Logger) {\n    this.id = id\n    this.socket = socket\n    this.logger = logger\n  }\n\n  public async send(_agentContext: AgentContext, encryptedMessage: DidCommEncryptedMessage): Promise<void> {\n    if (this.socket.readyState !== WebSocket.OPEN) {\n      throw new CredoError(`${this.type} transport session has been closed.`)\n    }\n    this.socket.send(JSON.stringify(encryptedMessage), (error?) => {\n      // biome-ignore lint/suspicious/noDoubleEquals: If error check is added as '!==' it fails the check\n      if (error != undefined) {\n        this.logger.debug(`Error sending message: ${error}`)\n        throw new CredoError(`${this.type} send message failed.`, { cause: error })\n      }\n      this.logger.debug(`${this.type} sent message successfully.`)\n    })\n  }\n\n  public async close(): Promise<void> {\n    if (this.socket.readyState === WebSocket.OPEN) {\n      this.socket.close()\n    }\n  }\n}\n"],"mappings":";;;;;AAWA,IAAa,4BAAb,MAA0E;CAOxE,AAAO,YAAY,EACjB,QACA,QACuF;OALjF,YAAqC,EAAE;AAM7C,OAAK,eAAe,UAAU,IAAI,gBAAgB,EAAE,MAAM,CAAC;;CAG7D,MAAa,MAAM,cAA4B;EAC7C,MAAM,mBAAmB,aAAa,kBAAkB,QAAQ,wBAAwB;AAExF,OAAK,SAAS,aAAa,OAAO;EAGlC,MAAM,aADgB,aAAa,kBAAkB,QAAQ,oBAAoB,CAChD,UAAU,MAAM,MAAM,EAAE,WAAW,KAAK,CAAC;AAC1E,OAAK,OAAO,MAAM,iCAAiC,EACjD,UAAU,YACX,CAAC;AAEF,OAAK,aAAa,GAAG,eAAe,WAAsB;GACxD,MAAM,WAAW,MAAM,MAAM;AAC7B,QAAK,OAAO,MAAM,oBAAoB;AAEtC,OAAI,CAAC,KAAK,UAAU,WAAW;AAC7B,SAAK,OAAO,MAAM,6BAA6B,SAAS,GAAG;AAC3D,SAAK,UAAU,YAAY;IAC3B,MAAM,UAAU,IAAI,0BAA0B,UAAU,QAAQ,KAAK,OAAO;AAC5E,SAAK,0BAA0B,cAAc,QAAQ,QAAQ;AAC7D,WAAO,GAAG,eAAe;AACvB,UAAK,OAAO,MAAM,iBAAiB;AACnC,sBAAiB,cAAc,QAAQ;MACvC;SAEF,MAAK,OAAO,MAAM,kBAAkB,SAAS,kBAAkB;IAEjE;;CAGJ,MAAa,OAAO;AAClB,OAAK,OAAO,MAAM,2BAA2B;AAE7C,SAAO,IAAI,SAAe,SAAS,WAAW;AAC5C,QAAK,aAAa,OAAO,UAAU;AACjC,QAAI,MACF,QAAO,MAAM;AAEf,aAAS;KACT;IACF;;CAGJ,AAAQ,0BAA0B,cAA4B,QAAmB,SAAkC;AAEjH,SAAO,iBAAiB,WAAW,OAAO,UAAe;AACvD,QAAK,OAAO,MAAM,qCAAqC,EAAE,KAAK,MAAM,OAAO,KAAK,CAAC;AACjF,OAAI;IACF,MAAM,mBAAmB,KAAK,MAAM,MAAM,KAAK;AAG/C,IADqB,aAAa,kBAAkB,QAAQ,aAAa,CAC5D,KAAkC,cAAc;KAC3D,MAAM,kBAAkB;KACxB,SAAS;MACP,SAAS;MACA;MACV;KACF,CAAC;YACK,OAAO;AACd,SAAK,OAAO,MAAM,6BAA6B,QAAQ;;IAEzD;;;AAIN,IAAa,4BAAb,MAA0E;CAMxE,AAAO,YAAY,IAAY,QAAmB,QAAgB;OAJlD,OAAO;AAKrB,OAAK,KAAK;AACV,OAAK,SAAS;AACd,OAAK,SAAS;;CAGhB,MAAa,KAAK,eAA6B,kBAA0D;AACvG,MAAI,KAAK,OAAO,eAAe,UAAU,KACvC,OAAM,IAAI,WAAW,GAAG,KAAK,KAAK,qCAAqC;AAEzE,OAAK,OAAO,KAAK,KAAK,UAAU,iBAAiB,GAAG,UAAW;AAE7D,OAAI,SAAS,QAAW;AACtB,SAAK,OAAO,MAAM,0BAA0B,QAAQ;AACpD,UAAM,IAAI,WAAW,GAAG,KAAK,KAAK,wBAAwB,EAAE,OAAO,OAAO,CAAC;;AAE7E,QAAK,OAAO,MAAM,GAAG,KAAK,KAAK,6BAA6B;IAC5D;;CAGJ,MAAa,QAAuB;AAClC,MAAI,KAAK,OAAO,eAAe,UAAU,KACvC,MAAK,OAAO,OAAO"}