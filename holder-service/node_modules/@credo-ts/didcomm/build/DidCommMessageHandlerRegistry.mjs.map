{"version":3,"file":"DidCommMessageHandlerRegistry.mjs","names":[],"sources":["../src/DidCommMessageHandlerRegistry.ts"],"sourcesContent":["import { injectable } from '@credo-ts/core'\nimport type { DidCommMessage } from './DidCommMessage'\nimport type { DidCommMessageHandler } from './handlers/DidCommMessageHandler'\nimport type { DidCommMessageHandlerMiddleware } from './handlers/DidCommMessageHandlerMiddleware'\nimport type { ParsedDidCommProtocolUri } from './util/messageType'\n\nimport { canHandleMessageType, parseMessageType, supportsIncomingDidCommProtocolUri } from './util/messageType'\n\n@injectable()\nexport class DidCommMessageHandlerRegistry {\n  private messageHandlers: DidCommMessageHandler[] = []\n  public readonly messageHandlerMiddlewares: DidCommMessageHandlerMiddleware[] = []\n  private _fallbackMessageHandler?: DidCommMessageHandler['handle']\n\n  public registerMessageHandler(messageHandler: DidCommMessageHandler) {\n    this.messageHandlers.push(messageHandler)\n  }\n\n  public registerMessageHandlers(messageHandlers: DidCommMessageHandler[]) {\n    for (const messageHandler of messageHandlers) {\n      this.registerMessageHandler(messageHandler)\n    }\n  }\n\n  public registerMessageHandlerMiddleware(messageHandlerMiddleware: DidCommMessageHandlerMiddleware) {\n    this.messageHandlerMiddlewares.push(messageHandlerMiddleware)\n  }\n\n  public get fallbackMessageHandler() {\n    return this._fallbackMessageHandler\n  }\n\n  /**\n   * Sets the fallback message handler, the message handler that will be called if no handler\n   * is registered for an incoming message type.\n   */\n  public setFallbackMessageHandler(fallbackMessageHandler: DidCommMessageHandler['handle']) {\n    this._fallbackMessageHandler = fallbackMessageHandler\n  }\n\n  public getHandlerForMessageType(messageType: string): DidCommMessageHandler | undefined {\n    const incomingMessageType = parseMessageType(messageType)\n\n    for (const handler of this.messageHandlers) {\n      for (const MessageClass of handler.supportedMessages) {\n        if (canHandleMessageType(MessageClass, incomingMessageType)) return handler\n      }\n    }\n  }\n\n  public getMessageClassForMessageType(messageType: string): typeof DidCommMessage | undefined {\n    const incomingMessageType = parseMessageType(messageType)\n\n    for (const handler of this.messageHandlers) {\n      for (const MessageClass of handler.supportedMessages) {\n        if (canHandleMessageType(MessageClass, incomingMessageType)) return MessageClass\n      }\n    }\n  }\n\n  /**\n   * Returns array of message types that dispatcher is able to handle.\n   * Message type format is MTURI specified at https://github.com/hyperledger/aries-rfcs/blob/main/concepts/0003-protocols/README.md#mturi.\n   */\n  public get supportedMessageTypes() {\n    return (\n      this.messageHandlers\n        // biome-ignore lint/performance/noAccumulatingSpread: no explanation\n        .reduce<(typeof DidCommMessage)[]>((all, cur) => [...all, ...cur.supportedMessages], [])\n        .map((m) => m.type)\n    )\n  }\n\n  /**\n   * Returns array of protocol IDs that dispatcher is able to handle.\n   * Protocol ID format is PIURI specified at https://github.com/hyperledger/aries-rfcs/blob/main/concepts/0003-protocols/README.md#piuri.\n   */\n  public get supportedProtocolUris() {\n    const seenProtocolUris = new Set<string>()\n\n    const protocolUris: ParsedDidCommProtocolUri[] = this.supportedMessageTypes\n      .filter((m) => {\n        const has = seenProtocolUris.has(m.protocolUri)\n        seenProtocolUris.add(m.protocolUri)\n        return !has\n      })\n      .map(({ messageName, messageTypeUri, ...parsedProtocolUri }) => parsedProtocolUri)\n\n    return protocolUris\n  }\n\n  public filterSupportedProtocolsByProtocolUris(parsedProtocolUris: ParsedDidCommProtocolUri[]) {\n    return this.supportedProtocolUris.filter((supportedProtocol) =>\n      parsedProtocolUris.some((p) => supportsIncomingDidCommProtocolUri(supportedProtocol, p))\n    )\n  }\n}\n"],"mappings":";;;;;AASO,0CAAM,8BAA8B;;OACjC,kBAA2C,EAAE;OACrC,4BAA+D,EAAE;;CAGjF,AAAO,uBAAuB,gBAAuC;AACnE,OAAK,gBAAgB,KAAK,eAAe;;CAG3C,AAAO,wBAAwB,iBAA0C;AACvE,OAAK,MAAM,kBAAkB,gBAC3B,MAAK,uBAAuB,eAAe;;CAI/C,AAAO,iCAAiC,0BAA2D;AACjG,OAAK,0BAA0B,KAAK,yBAAyB;;CAG/D,IAAW,yBAAyB;AAClC,SAAO,KAAK;;;;;;CAOd,AAAO,0BAA0B,wBAAyD;AACxF,OAAK,0BAA0B;;CAGjC,AAAO,yBAAyB,aAAwD;EACtF,MAAM,sBAAsB,iBAAiB,YAAY;AAEzD,OAAK,MAAM,WAAW,KAAK,gBACzB,MAAK,MAAM,gBAAgB,QAAQ,kBACjC,KAAI,qBAAqB,cAAc,oBAAoB,CAAE,QAAO;;CAK1E,AAAO,8BAA8B,aAAwD;EAC3F,MAAM,sBAAsB,iBAAiB,YAAY;AAEzD,OAAK,MAAM,WAAW,KAAK,gBACzB,MAAK,MAAM,gBAAgB,QAAQ,kBACjC,KAAI,qBAAqB,cAAc,oBAAoB,CAAE,QAAO;;;;;;CAS1E,IAAW,wBAAwB;AACjC,SACE,KAAK,gBAEF,QAAmC,KAAK,QAAQ,CAAC,GAAG,KAAK,GAAG,IAAI,kBAAkB,EAAE,EAAE,CAAC,CACvF,KAAK,MAAM,EAAE,KAAK;;;;;;CAQzB,IAAW,wBAAwB;EACjC,MAAM,mCAAmB,IAAI,KAAa;AAU1C,SARiD,KAAK,sBACnD,QAAQ,MAAM;GACb,MAAM,MAAM,iBAAiB,IAAI,EAAE,YAAY;AAC/C,oBAAiB,IAAI,EAAE,YAAY;AACnC,UAAO,CAAC;IACR,CACD,KAAK,EAAE,aAAa,gBAAgB,GAAG,wBAAwB,kBAAkB;;CAKtF,AAAO,uCAAuC,oBAAgD;AAC5F,SAAO,KAAK,sBAAsB,QAAQ,sBACxC,mBAAmB,MAAM,MAAM,mCAAmC,mBAAmB,EAAE,CAAC,CACzF;;;4CAtFJ,YAAY"}