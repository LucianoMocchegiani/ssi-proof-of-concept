{"version":3,"file":"DidCommApi.mjs","names":[],"sources":["../src/DidCommApi.ts"],"sourcesContent":["import { AgentContext, type InjectionToken, injectable } from '@credo-ts/core'\nimport { DidCommFeatureRegistry } from './DidCommFeatureRegistry'\nimport { DidCommMessageHandlerRegistry } from './DidCommMessageHandlerRegistry'\nimport { DidCommModuleConfig, type DidCommModuleConfigOptions } from './DidCommModuleConfig'\nimport type { DidCommMessageHandler, DidCommMessageHandlerMiddleware } from './handlers'\nimport {\n  type DefaultDidCommMessagePickupProtocols,\n  type DefaultDidCommProofProtocols,\n  DidCommBasicMessagesApi,\n  DidCommConnectionsApi,\n  type DidCommCredentialProtocol,\n  DidCommDiscoverFeaturesApi,\n  DidCommMessagePickupApi,\n  type DidCommMessagePickupModuleConfigOptions,\n  type DidCommMessagePickupProtocol,\n  DidCommOutOfBandApi,\n  type DidCommProofProtocol,\n  DidCommProofsApi,\n  type DidCommProofsModuleConfigOptions,\n} from './modules'\nimport { DidCommCredentialsApi } from './modules/credentials/DidCommCredentialsApi'\nimport type { DefaultDidCommCredentialProtocols } from './modules/credentials/DidCommCredentialsModule'\nimport type { DidCommCredentialsModuleConfigOptions } from './modules/credentials/DidCommCredentialsModuleConfig'\nimport { DidCommMediationRecipientApi } from './modules/routing/DidCommMediationRecipientApi'\nimport { DidCommMediatorApi } from './modules/routing/DidCommMediatorApi'\nimport type { DidCommInboundTransport, DidCommOutboundTransport } from './transport'\n\ntype ApiOrUndefined<Config, Api> = Config extends false ? never : Api\n\n@injectable()\nexport class DidCommApi<Options extends DidCommModuleConfigOptions> {\n  public connections = this.agentContext.resolve(DidCommConnectionsApi)\n  public oob = this.agentContext.resolve(DidCommOutOfBandApi)\n  public discovery = this.agentContext.resolve(DidCommDiscoverFeaturesApi)\n  public proofs: ApiOrUndefined<\n    Options['proofs'],\n    DidCommProofsApi<\n      Options['proofs'] extends DidCommProofsModuleConfigOptions<DidCommProofProtocol[]>\n        ? Options['proofs']['proofProtocols']\n        : DefaultDidCommProofProtocols\n    >\n  > = this.apiOrUndefined(this.config.enabledModules.proofs, DidCommProofsApi)\n\n  public credentials: ApiOrUndefined<\n    Options['credentials'],\n    DidCommCredentialsApi<\n      Options['credentials'] extends DidCommCredentialsModuleConfigOptions<DidCommCredentialProtocol[]>\n        ? Options['credentials']['credentialProtocols']\n        : DefaultDidCommCredentialProtocols\n    >\n  > = this.apiOrUndefined(this.config.enabledModules.credentials, DidCommCredentialsApi)\n\n  public messagePickup: ApiOrUndefined<\n    Options['messagePickup'],\n    DidCommMessagePickupApi<\n      Options['messagePickup'] extends DidCommMessagePickupModuleConfigOptions<DidCommMessagePickupProtocol[]>\n        ? Options['messagePickup']['protocols']\n        : DefaultDidCommMessagePickupProtocols\n    >\n  > = this.apiOrUndefined(this.config.enabledModules.messagePickup, DidCommMessagePickupApi)\n\n  public basicMessages: ApiOrUndefined<Options['basicMessages'], DidCommBasicMessagesApi> = this.apiOrUndefined(\n    this.config.enabledModules.basicMessages,\n    DidCommBasicMessagesApi\n  )\n\n  public mediator: ApiOrUndefined<Options['mediator'], DidCommMediatorApi> = this.apiOrUndefined(\n    this.config.enabledModules.mediator,\n    DidCommMediatorApi\n  )\n\n  public mediationRecipient: ApiOrUndefined<Options['mediationRecipient'], DidCommMediationRecipientApi> =\n    this.apiOrUndefined(this.config.enabledModules.mediationRecipient, DidCommMediationRecipientApi)\n\n  public constructor(\n    public agentContext: AgentContext,\n    private messageHandlerRegistry: DidCommMessageHandlerRegistry,\n    private featureRegistry: DidCommFeatureRegistry,\n    public config: DidCommModuleConfig\n  ) {}\n\n  public registerInboundTransport(inboundTransport: DidCommInboundTransport) {\n    this.config.inboundTransports.push(inboundTransport)\n  }\n\n  public async unregisterInboundTransport(inboundTransport: DidCommInboundTransport) {\n    this.config.inboundTransports = this.config.inboundTransports.filter((transport) => transport !== inboundTransport)\n    await inboundTransport.stop()\n  }\n\n  public get inboundTransports() {\n    return this.config.inboundTransports\n  }\n\n  public registerOutboundTransport(outboundTransport: DidCommOutboundTransport) {\n    this.config.outboundTransports.push(outboundTransport)\n  }\n\n  public async unregisterOutboundTransport(outboundTransport: DidCommOutboundTransport) {\n    this.config.outboundTransports = this.config.outboundTransports.filter(\n      (transport) => transport !== outboundTransport\n    )\n  }\n\n  public get outboundTransports() {\n    return this.config.outboundTransports\n  }\n\n  /**\n   * Agent's feature registry\n   */\n  public registerMessageHandlers(messageHandlers: DidCommMessageHandler[]) {\n    for (const messageHandler of messageHandlers) {\n      this.messageHandlerRegistry.registerMessageHandler(messageHandler)\n    }\n  }\n\n  public registerMessageHandlerMiddleware(messageHandlerMiddleware: DidCommMessageHandlerMiddleware) {\n    this.messageHandlerRegistry.registerMessageHandlerMiddleware(messageHandlerMiddleware)\n  }\n\n  public get fallbackMessageHandler() {\n    return this.messageHandlerRegistry.fallbackMessageHandler\n  }\n\n  public get messageHandlerMiddlewares() {\n    return this.messageHandlerRegistry.messageHandlerMiddlewares\n  }\n\n  /**\n   * Sets the fallback message handler, the message handler that will be called if no handler\n   * is registered for an incoming message type.\n   */\n  public setFallbackMessageHandler(fallbackMessageHandler: DidCommMessageHandler['handle']) {\n    this.messageHandlerRegistry.setFallbackMessageHandler(fallbackMessageHandler)\n  }\n\n  public get features() {\n    return this.featureRegistry\n  }\n\n  private apiOrUndefined(isEnabled: boolean, apiClass: InjectionToken) {\n    if (isEnabled) {\n      return this.agentContext.resolve(apiClass)\n    }\n\n    return undefined\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;AA8BO,uBAAM,WAAuD;CA4ClE,AAAO,YACL,AAAO,cACP,AAAQ,wBACR,AAAQ,iBACR,AAAO,QACP;EAJO;EACC;EACA;EACD;OA/CF,cAAc,KAAK,aAAa,QAAQ,sBAAsB;OAC9D,MAAM,KAAK,aAAa,QAAQ,oBAAoB;OACpD,YAAY,KAAK,aAAa,QAAQ,2BAA2B;OACjE,SAOH,KAAK,eAAe,KAAK,OAAO,eAAe,QAAQ,iBAAiB;OAErE,cAOH,KAAK,eAAe,KAAK,OAAO,eAAe,aAAa,sBAAsB;OAE/E,gBAOH,KAAK,eAAe,KAAK,OAAO,eAAe,eAAe,wBAAwB;OAEnF,gBAAmF,KAAK,eAC7F,KAAK,OAAO,eAAe,eAC3B,wBACD;OAEM,WAAoE,KAAK,eAC9E,KAAK,OAAO,eAAe,UAC3B,mBACD;OAEM,qBACL,KAAK,eAAe,KAAK,OAAO,eAAe,oBAAoB,6BAA6B;;CASlG,AAAO,yBAAyB,kBAA2C;AACzE,OAAK,OAAO,kBAAkB,KAAK,iBAAiB;;CAGtD,MAAa,2BAA2B,kBAA2C;AACjF,OAAK,OAAO,oBAAoB,KAAK,OAAO,kBAAkB,QAAQ,cAAc,cAAc,iBAAiB;AACnH,QAAM,iBAAiB,MAAM;;CAG/B,IAAW,oBAAoB;AAC7B,SAAO,KAAK,OAAO;;CAGrB,AAAO,0BAA0B,mBAA6C;AAC5E,OAAK,OAAO,mBAAmB,KAAK,kBAAkB;;CAGxD,MAAa,4BAA4B,mBAA6C;AACpF,OAAK,OAAO,qBAAqB,KAAK,OAAO,mBAAmB,QAC7D,cAAc,cAAc,kBAC9B;;CAGH,IAAW,qBAAqB;AAC9B,SAAO,KAAK,OAAO;;;;;CAMrB,AAAO,wBAAwB,iBAA0C;AACvE,OAAK,MAAM,kBAAkB,gBAC3B,MAAK,uBAAuB,uBAAuB,eAAe;;CAItE,AAAO,iCAAiC,0BAA2D;AACjG,OAAK,uBAAuB,iCAAiC,yBAAyB;;CAGxF,IAAW,yBAAyB;AAClC,SAAO,KAAK,uBAAuB;;CAGrC,IAAW,4BAA4B;AACrC,SAAO,KAAK,uBAAuB;;;;;;CAOrC,AAAO,0BAA0B,wBAAyD;AACxF,OAAK,uBAAuB,0BAA0B,uBAAuB;;CAG/E,IAAW,WAAW;AACpB,SAAO,KAAK;;CAGd,AAAQ,eAAe,WAAoB,UAA0B;AACnE,MAAI,UACF,QAAO,KAAK,aAAa,QAAQ,SAAS;;;yBAlH/C,YAAY"}