{"version":3,"file":"DidCommAttachment.mjs","names":[],"sources":["../../../src/decorators/attachment/DidCommAttachment.ts"],"sourcesContent":["import type { JwsDetachedFormat, JwsFlattenedDetachedFormat, JwsGeneralFormat } from '@credo-ts/core'\n\nimport { CredoError, JsonEncoder, type JsonValue, utils } from '@credo-ts/core'\nimport { Expose, Type } from 'class-transformer'\nimport { IsDate, IsHash, IsInstance, IsInt, IsMimeType, IsOptional, IsString, ValidateNested } from 'class-validator'\n\nexport interface DidCommAttachmentOptions {\n  id?: string\n  description?: string\n  filename?: string\n  mimeType?: string\n  lastmodTime?: Date\n  byteCount?: number\n  data: DidCommAttachmentDataOptions\n}\n\nexport interface DidCommAttachmentDataOptions {\n  base64?: string\n  json?: JsonValue\n  links?: string[]\n  jws?: JwsDetachedFormat | JwsFlattenedDetachedFormat\n  sha256?: string\n}\n\n/**\n * A JSON object that gives access to the actual content of the attachment\n */\nexport class DidCommAttachmentData {\n  /**\n   * Base64-encoded data, when representing arbitrary content inline instead of via links. Optional.\n   */\n  @IsOptional()\n  @IsString()\n  public base64?: string\n\n  /**\n   *  Directly embedded JSON data, when representing content inline instead of via links, and when the content is natively conveyable as JSON. Optional.\n   */\n  @IsOptional()\n  public json?: JsonValue\n\n  /**\n   * A list of zero or more locations at which the content may be fetched. Optional.\n   */\n  @IsOptional()\n  @IsString({ each: true })\n  public links?: string[]\n\n  /**\n   * A JSON Web Signature over the content of the attachment. Optional.\n   */\n  @IsOptional()\n  // Signed attachments use JWS detached format\n  public jws?: JwsDetachedFormat | JwsFlattenedDetachedFormat\n\n  /**\n   * The hash of the content. Optional.\n   */\n  @IsOptional()\n  @IsHash('sha256')\n  public sha256?: string\n\n  public constructor(options: DidCommAttachmentDataOptions) {\n    if (options) {\n      this.base64 = options.base64\n      this.json = options.json\n      this.links = options.links\n      this.jws = options.jws\n      this.sha256 = options.sha256\n    }\n  }\n}\n\n/**\n * Represents DIDComm attachment\n * https://github.com/hyperledger/aries-rfcs/blob/master/concepts/0017-attachments/README.md\n */\nexport class DidCommAttachment {\n  public constructor(options: DidCommAttachmentOptions) {\n    if (options) {\n      this.id = options.id ?? utils.uuid()\n      this.description = options.description\n      this.filename = options.filename\n      this.mimeType = options.mimeType\n      this.lastmodTime = options.lastmodTime\n      this.byteCount = options.byteCount\n      this.data = new DidCommAttachmentData(options.data)\n    }\n  }\n\n  @Expose({ name: '@id' })\n  public id!: string\n\n  /**\n   * An optional human-readable description of the content.\n   */\n  @IsOptional()\n  @IsString()\n  public description?: string\n\n  /**\n   * A hint about the name that might be used if this attachment is persisted as a file. It is not required, and need not be unique. If this field is present and mime-type is not, the extension on the filename may be used to infer a MIME type.\n   */\n  @IsOptional()\n  @IsString()\n  public filename?: string\n\n  /**\n   * Describes the MIME type of the attached content. Optional but recommended.\n   */\n  @Expose({ name: 'mime-type' })\n  @IsOptional()\n  @IsMimeType()\n  public mimeType?: string\n\n  /**\n   * A hint about when the content in this attachment was last modified.\n   */\n  @Expose({ name: 'lastmod_time' })\n  @Type(() => Date)\n  @IsOptional()\n  @IsDate()\n  public lastmodTime?: Date\n\n  /**\n   * Optional, and mostly relevant when content is included by reference instead of by value. Lets the receiver guess how expensive it will be, in time, bandwidth, and storage, to fully fetch the attachment.\n   */\n  @Expose({ name: 'byte_count' })\n  @IsOptional()\n  @IsInt()\n  public byteCount?: number\n\n  @Type(() => DidCommAttachmentData)\n  @ValidateNested()\n  @IsInstance(DidCommAttachmentData)\n  public data!: DidCommAttachmentData\n\n  /*\n   * Helper function returning JSON representation of attachment data (if present). Tries to obtain the data from .base64 or .json, throws an error otherwise\n   */\n  public getDataAsJson<T>(): T {\n    if (typeof this.data.base64 === 'string') {\n      return JsonEncoder.fromBase64(this.data.base64) as T\n    }\n    if (this.data.json) {\n      return this.data.json as T\n    }\n    throw new CredoError('No attachment data found in `json` or `base64` data fields.')\n  }\n\n  public addJws(jws: JwsDetachedFormat) {\n    // Remove payload if user provided a non-detached JWS\n    const { payload, ...detachedJws } = jws as JwsGeneralFormat\n\n    // If no JWS yet, assign to current JWS\n    if (!this.data.jws) {\n      this.data.jws = detachedJws\n    }\n    // Is already jws array, add to it\n    else if ('signatures' in this.data.jws) {\n      this.data.jws.signatures.push(detachedJws)\n    }\n    // If already single JWS, transform to general jws format\n    else {\n      this.data.jws = {\n        signatures: [this.data.jws, detachedJws],\n      }\n    }\n  }\n}\n"],"mappings":";;;;;;;;;;;AA2BA,IAAa,wBAAb,MAAmC;CAmCjC,AAAO,YAAY,SAAuC;AACxD,MAAI,SAAS;AACX,QAAK,SAAS,QAAQ;AACtB,QAAK,OAAO,QAAQ;AACpB,QAAK,QAAQ,QAAQ;AACrB,QAAK,MAAM,QAAQ;AACnB,QAAK,SAAS,QAAQ;;;;;CArCzB,YAAY;CACZ,UAAU;;;YAMV,YAAY;;CAMZ,YAAY;CACZ,SAAS,EAAE,MAAM,MAAM,CAAC;;;YAMxB,YAAY;;CAOZ,YAAY;CACZ,OAAO,SAAS;;;;;;;AAkBnB,IAAa,oBAAb,MAA+B;CAC7B,AAAO,YAAY,SAAmC;AACpD,MAAI,SAAS;AACX,QAAK,KAAK,QAAQ,MAAM,MAAM,MAAM;AACpC,QAAK,cAAc,QAAQ;AAC3B,QAAK,WAAW,QAAQ;AACxB,QAAK,WAAW,QAAQ;AACxB,QAAK,cAAc,QAAQ;AAC3B,QAAK,YAAY,QAAQ;AACzB,QAAK,OAAO,IAAI,sBAAsB,QAAQ,KAAK;;;CAsDvD,AAAO,gBAAsB;AAC3B,MAAI,OAAO,KAAK,KAAK,WAAW,SAC9B,QAAO,YAAY,WAAW,KAAK,KAAK,OAAO;AAEjD,MAAI,KAAK,KAAK,KACZ,QAAO,KAAK,KAAK;AAEnB,QAAM,IAAI,WAAW,8DAA8D;;CAGrF,AAAO,OAAO,KAAwB;EAEpC,MAAM,EAAE,SAAS,GAAG,gBAAgB;AAGpC,MAAI,CAAC,KAAK,KAAK,IACb,MAAK,KAAK,MAAM;WAGT,gBAAgB,KAAK,KAAK,IACjC,MAAK,KAAK,IAAI,WAAW,KAAK,YAAY;MAI1C,MAAK,KAAK,MAAM,EACd,YAAY,CAAC,KAAK,KAAK,KAAK,YAAY,EACzC;;;YA5EJ,OAAO,EAAE,MAAM,OAAO,CAAC;;CAMvB,YAAY;CACZ,UAAU;;;;CAMV,YAAY;CACZ,UAAU;;;;CAMV,OAAO,EAAE,MAAM,aAAa,CAAC;CAC7B,YAAY;CACZ,YAAY;;;;CAMZ,OAAO,EAAE,MAAM,gBAAgB,CAAC;CAChC,WAAW,KAAK;CAChB,YAAY;CACZ,QAAQ;;;;CAMR,OAAO,EAAE,MAAM,cAAc,CAAC;CAC9B,YAAY;CACZ,OAAO;;;;CAGP,WAAW,sBAAsB;CACjC,gBAAgB;CAChB,WAAW,sBAAsB"}