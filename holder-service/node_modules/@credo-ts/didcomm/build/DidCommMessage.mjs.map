{"version":3,"file":"DidCommMessage.mjs","names":[],"sources":["../src/DidCommMessage.ts"],"sourcesContent":["import type { Constructor } from '@credo-ts/core'\nimport { JsonTransformer } from '@credo-ts/core'\nimport { Exclude } from 'class-transformer'\nimport { BaseDidCommMessage } from './BaseDidCommMessage'\nimport { AckDecorated } from './decorators/ack/AckDecoratorExtension'\nimport { AttachmentDecorated } from './decorators/attachment/AttachmentExtension'\nimport { L10nDecorated } from './decorators/l10n/L10nDecoratorExtension'\nimport { ServiceDecorated } from './decorators/service/ServiceDecoratorExtension'\nimport { ThreadDecorated } from './decorators/thread/ThreadDecoratorExtension'\nimport { TimingDecorated } from './decorators/timing/TimingDecoratorExtension'\nimport { TransportDecorated } from './decorators/transport/TransportDecoratorExtension'\nimport type { DidCommPlaintextMessage } from './types'\nimport type { ParsedMessageType } from './util/messageType'\nimport { replaceNewDidCommPrefixWithLegacyDidSovOnMessage } from './util/messageType'\n\nexport type ConstructableAgentMessage = Constructor<DidCommMessage> & { type: ParsedMessageType }\n\nconst Decorated = ThreadDecorated(\n  L10nDecorated(\n    TransportDecorated(TimingDecorated(AckDecorated(AttachmentDecorated(ServiceDecorated(BaseDidCommMessage)))))\n  )\n)\n\nexport class DidCommMessage extends Decorated {\n  /**\n   * Whether the protocol RFC was initially written using the legacy did:prefix instead of the\n   * new https://didcomm.org message type prefix.\n   *\n   * @see https://github.com/hyperledger/aries-rfcs/blob/main/features/0348-transition-msg-type-to-https/README.md\n   */\n  @Exclude()\n  public readonly allowDidSovPrefix: boolean = false\n\n  /**\n   * Whether to use Queue Transport in case the recipient of this message does not have a reliable\n   * endpoint available\n   *\n   * @see https://github.com/decentralized-identity/didcomm-messaging/blob/main/extensions/return_route/main.md#queue-transport\n   */\n  @Exclude()\n  public readonly allowQueueTransport: boolean = true\n\n  public toJSON({\n    useDidSovPrefixWhereAllowed,\n  }: {\n    useDidSovPrefixWhereAllowed?: boolean\n  } = {}): DidCommPlaintextMessage {\n    const json = JsonTransformer.toJSON(this)\n\n    // If we have `useDidSovPrefixWhereAllowed` enabled, we want to replace the new https://didcomm.org prefix with the legacy did:sov prefix.\n    // However, we only do this if the protocol RFC was initially written with the did:sov message type prefix\n    // See https://github.com/hyperledger/aries-rfcs/blob/main/features/0348-transition-msg-type-to-https/README.md\n    if (this.allowDidSovPrefix && useDidSovPrefixWhereAllowed) {\n      replaceNewDidCommPrefixWithLegacyDidSovOnMessage(json)\n    }\n\n    return json as DidCommPlaintextMessage\n  }\n\n  public is<C extends typeof DidCommMessage>(Class: C): this is InstanceType<C> {\n    return this.type === Class.type.messageTypeUri\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;AAiBA,MAAM,YAAY,gBAChB,cACE,mBAAmB,gBAAgB,aAAa,oBAAoB,iBAAiB,mBAAmB,CAAC,CAAC,CAAC,CAAC,CAC7G,CACF;AAED,IAAa,iBAAb,cAAoC,UAAU;;;OAQ5B,oBAA6B;OAS7B,sBAA+B;;CAE/C,AAAO,OAAO,EACZ,gCAGE,EAAE,EAA2B;EAC/B,MAAM,OAAO,gBAAgB,OAAO,KAAK;AAKzC,MAAI,KAAK,qBAAqB,4BAC5B,kDAAiD,KAAK;AAGxD,SAAO;;CAGT,AAAO,GAAoC,OAAmC;AAC5E,SAAO,KAAK,SAAS,MAAM,KAAK;;;YA9BjC,SAAS;YAST,SAAS"}