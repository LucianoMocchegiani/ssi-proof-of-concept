{"version":3,"file":"DidCommMessageRepository.mjs","names":[],"sources":["../../src/repository/DidCommMessageRepository.ts"],"sourcesContent":["import type { AgentContext } from '@credo-ts/core'\nimport { EventEmitter, InjectionSymbols, inject, injectable, Repository, type StorageService } from '@credo-ts/core'\nimport type { ConstructableAgentMessage, DidCommMessage } from '../DidCommMessage'\nimport { parseMessageType } from '../util/messageType'\nimport { DidCommMessageRecord } from './DidCommMessageRecord'\nimport type { DidCommMessageRole } from './DidCommMessageRole'\n\n@injectable()\nexport class DidCommMessageRepository extends Repository<DidCommMessageRecord> {\n  public constructor(\n    @inject(InjectionSymbols.StorageService) storageService: StorageService<DidCommMessageRecord>,\n    eventEmitter: EventEmitter\n  ) {\n    super(DidCommMessageRecord, storageService, eventEmitter)\n  }\n\n  public async saveAgentMessage(\n    agentContext: AgentContext,\n    { role, agentMessage, associatedRecordId }: SaveAgentMessageOptions\n  ) {\n    const didCommMessageRecord = new DidCommMessageRecord({\n      message: agentMessage.toJSON(),\n      role,\n      associatedRecordId,\n    })\n\n    await this.save(agentContext, didCommMessageRecord)\n  }\n\n  public async saveOrUpdateAgentMessage(agentContext: AgentContext, options: SaveAgentMessageOptions) {\n    const { messageName, protocolName, protocolMajorVersion } = parseMessageType(options.agentMessage.type)\n\n    const record = await this.findSingleByQuery(agentContext, {\n      associatedRecordId: options.associatedRecordId,\n      messageName: messageName,\n      protocolName: protocolName,\n      protocolMajorVersion: String(protocolMajorVersion),\n    })\n\n    if (record) {\n      record.message = options.agentMessage.toJSON()\n      record.role = options.role\n      await this.update(agentContext, record)\n      return\n    }\n\n    await this.saveAgentMessage(agentContext, options)\n  }\n\n  public async getAgentMessage<MessageClass extends ConstructableAgentMessage = ConstructableAgentMessage>(\n    agentContext: AgentContext,\n    { associatedRecordId, messageClass, role }: GetAgentMessageOptions<MessageClass>\n  ): Promise<InstanceType<MessageClass>> {\n    const record = await this.getSingleByQuery(agentContext, {\n      associatedRecordId,\n      messageName: messageClass.type.messageName,\n      protocolName: messageClass.type.protocolName,\n      protocolMajorVersion: String(messageClass.type.protocolMajorVersion),\n      role,\n    })\n\n    return record.getMessageInstance(messageClass)\n  }\n  public async findAgentMessage<MessageClass extends ConstructableAgentMessage = ConstructableAgentMessage>(\n    agentContext: AgentContext,\n    { associatedRecordId, messageClass, role }: GetAgentMessageOptions<MessageClass>\n  ): Promise<InstanceType<MessageClass> | null> {\n    const record = await this.findSingleByQuery(agentContext, {\n      associatedRecordId,\n      messageName: messageClass.type.messageName,\n      protocolName: messageClass.type.protocolName,\n      protocolMajorVersion: String(messageClass.type.protocolMajorVersion),\n      role,\n    })\n\n    return record?.getMessageInstance(messageClass) ?? null\n  }\n}\n\nexport interface SaveAgentMessageOptions {\n  role: DidCommMessageRole\n  agentMessage: DidCommMessage\n  associatedRecordId: string\n}\n\nexport interface GetAgentMessageOptions<MessageClass extends typeof DidCommMessage> {\n  associatedRecordId: string\n  messageClass: MessageClass\n  role?: DidCommMessageRole\n}\n"],"mappings":";;;;;;;;;AAQO,qCAAM,iCAAiC,WAAiC;CAC7E,AAAO,YACL,AAAyC,gBACzC,cACA;AACA,QAAM,sBAAsB,gBAAgB,aAAa;;CAG3D,MAAa,iBACX,cACA,EAAE,MAAM,cAAc,sBACtB;EACA,MAAM,uBAAuB,IAAI,qBAAqB;GACpD,SAAS,aAAa,QAAQ;GAC9B;GACA;GACD,CAAC;AAEF,QAAM,KAAK,KAAK,cAAc,qBAAqB;;CAGrD,MAAa,yBAAyB,cAA4B,SAAkC;EAClG,MAAM,EAAE,aAAa,cAAc,yBAAyB,iBAAiB,QAAQ,aAAa,KAAK;EAEvG,MAAM,SAAS,MAAM,KAAK,kBAAkB,cAAc;GACxD,oBAAoB,QAAQ;GACf;GACC;GACd,sBAAsB,OAAO,qBAAqB;GACnD,CAAC;AAEF,MAAI,QAAQ;AACV,UAAO,UAAU,QAAQ,aAAa,QAAQ;AAC9C,UAAO,OAAO,QAAQ;AACtB,SAAM,KAAK,OAAO,cAAc,OAAO;AACvC;;AAGF,QAAM,KAAK,iBAAiB,cAAc,QAAQ;;CAGpD,MAAa,gBACX,cACA,EAAE,oBAAoB,cAAc,QACC;AASrC,UARe,MAAM,KAAK,iBAAiB,cAAc;GACvD;GACA,aAAa,aAAa,KAAK;GAC/B,cAAc,aAAa,KAAK;GAChC,sBAAsB,OAAO,aAAa,KAAK,qBAAqB;GACpE;GACD,CAAC,EAEY,mBAAmB,aAAa;;CAEhD,MAAa,iBACX,cACA,EAAE,oBAAoB,cAAc,QACQ;AAS5C,UARe,MAAM,KAAK,kBAAkB,cAAc;GACxD;GACA,aAAa,aAAa,KAAK;GAC/B,cAAc,aAAa,KAAK;GAChC,sBAAsB,OAAO,aAAa,KAAK,qBAAqB;GACpE;GACD,CAAC,GAEa,mBAAmB,aAAa,IAAI;;;;CApEtD,YAAY;oBAGR,OAAO,iBAAiB,eAAe"}