{"version":3,"file":"credentialExchangeRecord.mjs","names":[],"sources":["../../../src/updates/0.4-0.5/credentialExchangeRecord.ts"],"sourcesContent":["import type { BaseAgent } from '@credo-ts/core'\nimport { CredoError } from '@credo-ts/core'\nimport type { DidCommCredentialExchangeRecord } from '../../modules/credentials'\n\nimport {\n  DidCommCredentialExchangeRepository,\n  DidCommCredentialRole,\n  DidCommCredentialState,\n  DidCommOfferCredentialV2Message,\n  DidCommProposeCredentialV2Message,\n  DidCommRequestCredentialV2Message,\n} from '../../modules/credentials'\nimport { DidCommMessageRepository, DidCommMessageRole } from '../../repository'\nimport { parseMessageType } from '../../util/messageType'\n\n/**\n * Migrates the {@link DidCommCredentialExchangeRecord} to 0.5 compatible format. It fetches all credential exchange records from\n *  storage and applies the needed updates to the records. After a record has been transformed, it is updated\n * in storage and the next record will be transformed.\n *\n * The following transformations are applied:\n *  - {@link migrateRole}\n */\nexport async function migrateCredentialExchangeRecordToV0_5<Agent extends BaseAgent>(agent: Agent) {\n  agent.config.logger.info('Migrating credential exchange records to storage version 0.5')\n  const credentialRepository = agent.dependencyManager.resolve(DidCommCredentialExchangeRepository)\n\n  agent.config.logger.debug('Fetching all credential records from storage')\n  const credentialRecords = await credentialRepository.getAll(agent.context)\n\n  agent.config.logger.debug(`Found a total of ${credentialRecords.length} credential exchange records to update.`)\n  for (const credentialRecord of credentialRecords) {\n    agent.config.logger.debug(\n      `Migrating credential exchange record with id ${credentialRecord.id} to storage version 0.5`\n    )\n\n    await migrateRole(agent, credentialRecord)\n\n    // Save updated record\n    await credentialRepository.update(agent.context, credentialRecord)\n\n    agent.config.logger.debug(\n      `Successfully migrated credential exchange record with id ${credentialRecord.id} to storage version 0.5`\n    )\n  }\n}\n\nconst holderCredentialStates = [\n  DidCommCredentialState.Declined,\n  DidCommCredentialState.ProposalSent,\n  DidCommCredentialState.OfferReceived,\n  DidCommCredentialState.RequestSent,\n  DidCommCredentialState.CredentialReceived,\n]\n\nconst issuerCredentialStates = [\n  DidCommCredentialState.ProposalReceived,\n  DidCommCredentialState.OfferSent,\n  DidCommCredentialState.RequestReceived,\n  DidCommCredentialState.CredentialIssued,\n]\n\nexport async function getCredentialRole(agent: BaseAgent, credentialRecord: DidCommCredentialExchangeRecord) {\n  // Credentials will only have a value when a credential is received, meaning we're the holder\n  if (credentialRecord.credentials.length > 0) {\n    return DidCommCredentialRole.Holder\n  }\n  // If credentialRecord.credentials doesn't have any values, and we're also not in state done it means we're the issuer.\n  if (credentialRecord.state === DidCommCredentialState.Done) {\n    return DidCommCredentialRole.Issuer\n  }\n  // For these states we know for certain that we're the holder\n  if (holderCredentialStates.includes(credentialRecord.state)) {\n    return DidCommCredentialRole.Holder\n  }\n  // For these states we know for certain that we're the issuer\n  if (issuerCredentialStates.includes(credentialRecord.state)) {\n    return DidCommCredentialRole.Issuer\n  }\n\n  // We now need to determine the role based on the didcomm message. Only the Abandoned state remains\n  // and we can't be certain of the role based on the state alone.\n\n  // Fetch any of the associated credential messages that we can use to determine the role\n  // Either one of these MUST be present or we can't determine the role.\n  const didCommMessageRepository = agent.dependencyManager.resolve(DidCommMessageRepository)\n  const [didCommMessageRecord] = await didCommMessageRepository.findByQuery(agent.context, {\n    associatedRecordId: credentialRecord.id,\n    $or: [\n      // We can't be certain which messages will be present.\n      { messageName: DidCommOfferCredentialV2Message.type.messageName },\n      { messageName: DidCommProposeCredentialV2Message.type.messageName },\n      { messageName: DidCommRequestCredentialV2Message.type.messageName },\n    ],\n  })\n\n  if (!didCommMessageRecord) {\n    throw new CredoError(\n      `Unable to determine the role of the credential exchange record with id ${credentialRecord.id} without any didcomm messages and state abandoned`\n    )\n  }\n\n  // Maps the message name and the didcomm message role to the respective credential role\n  const roleStateMapping = {\n    [DidCommOfferCredentialV2Message.type.messageName]: {\n      [DidCommMessageRole.Sender]: DidCommCredentialRole.Issuer,\n      [DidCommMessageRole.Receiver]: DidCommCredentialRole.Holder,\n    },\n    [DidCommProposeCredentialV2Message.type.messageName]: {\n      [DidCommMessageRole.Sender]: DidCommCredentialRole.Holder,\n      [DidCommMessageRole.Receiver]: DidCommCredentialRole.Issuer,\n    },\n    [DidCommRequestCredentialV2Message.type.messageName]: {\n      [DidCommMessageRole.Sender]: DidCommCredentialRole.Holder,\n      [DidCommMessageRole.Receiver]: DidCommCredentialRole.Issuer,\n    },\n  }\n\n  const messageName = parseMessageType(didCommMessageRecord.message['@type']).messageName\n  const credentialRole = roleStateMapping[messageName][didCommMessageRecord.role]\n\n  return credentialRole\n}\n\n/**\n * Add a role to the credential record.\n */\nexport async function migrateRole<Agent extends BaseAgent>(\n  agent: Agent,\n  credentialRecord: DidCommCredentialExchangeRecord\n) {\n  agent.config.logger.debug(`Adding role to record with id ${credentialRecord.id} to for version 0.4`)\n\n  credentialRecord.role = await getCredentialRole(agent, credentialRecord)\n\n  agent.config.logger.debug(\n    `Successfully updated role to '${credentialRecord.role}' on credential record with id ${credentialRecord.id} to for version 0.4`\n  )\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;AAuBA,eAAsB,sCAA+D,OAAc;AACjG,OAAM,OAAO,OAAO,KAAK,+DAA+D;CACxF,MAAM,uBAAuB,MAAM,kBAAkB,QAAQ,oCAAoC;AAEjG,OAAM,OAAO,OAAO,MAAM,+CAA+C;CACzE,MAAM,oBAAoB,MAAM,qBAAqB,OAAO,MAAM,QAAQ;AAE1E,OAAM,OAAO,OAAO,MAAM,oBAAoB,kBAAkB,OAAO,yCAAyC;AAChH,MAAK,MAAM,oBAAoB,mBAAmB;AAChD,QAAM,OAAO,OAAO,MAClB,gDAAgD,iBAAiB,GAAG,yBACrE;AAED,QAAM,YAAY,OAAO,iBAAiB;AAG1C,QAAM,qBAAqB,OAAO,MAAM,SAAS,iBAAiB;AAElE,QAAM,OAAO,OAAO,MAClB,4DAA4D,iBAAiB,GAAG,yBACjF;;;AAIL,MAAM,yBAAyB;CAC7B,uBAAuB;CACvB,uBAAuB;CACvB,uBAAuB;CACvB,uBAAuB;CACvB,uBAAuB;CACxB;AAED,MAAM,yBAAyB;CAC7B,uBAAuB;CACvB,uBAAuB;CACvB,uBAAuB;CACvB,uBAAuB;CACxB;AAED,eAAsB,kBAAkB,OAAkB,kBAAmD;AAE3G,KAAI,iBAAiB,YAAY,SAAS,EACxC,QAAO,sBAAsB;AAG/B,KAAI,iBAAiB,UAAU,uBAAuB,KACpD,QAAO,sBAAsB;AAG/B,KAAI,uBAAuB,SAAS,iBAAiB,MAAM,CACzD,QAAO,sBAAsB;AAG/B,KAAI,uBAAuB,SAAS,iBAAiB,MAAM,CACzD,QAAO,sBAAsB;CAS/B,MAAM,CAAC,wBAAwB,MADE,MAAM,kBAAkB,QAAQ,yBAAyB,CAC5B,YAAY,MAAM,SAAS;EACvF,oBAAoB,iBAAiB;EACrC,KAAK;GAEH,EAAE,aAAa,gCAAgC,KAAK,aAAa;GACjE,EAAE,aAAa,kCAAkC,KAAK,aAAa;GACnE,EAAE,aAAa,kCAAkC,KAAK,aAAa;GACpE;EACF,CAAC;AAEF,KAAI,CAAC,qBACH,OAAM,IAAI,WACR,0EAA0E,iBAAiB,GAAG,mDAC/F;AAsBH,QAlByB;GACtB,gCAAgC,KAAK,cAAc;IACjD,mBAAmB,SAAS,sBAAsB;IAClD,mBAAmB,WAAW,sBAAsB;GACtD;GACA,kCAAkC,KAAK,cAAc;IACnD,mBAAmB,SAAS,sBAAsB;IAClD,mBAAmB,WAAW,sBAAsB;GACtD;GACA,kCAAkC,KAAK,cAAc;IACnD,mBAAmB,SAAS,sBAAsB;IAClD,mBAAmB,WAAW,sBAAsB;GACtD;EACF,CAEmB,iBAAiB,qBAAqB,QAAQ,SAAS,CAAC,aACvB,qBAAqB;;;;;AAQ5E,eAAsB,YACpB,OACA,kBACA;AACA,OAAM,OAAO,OAAO,MAAM,iCAAiC,iBAAiB,GAAG,qBAAqB;AAEpG,kBAAiB,OAAO,MAAM,kBAAkB,OAAO,iBAAiB;AAExE,OAAM,OAAO,OAAO,MAClB,iCAAiC,iBAAiB,KAAK,iCAAiC,iBAAiB,GAAG,qBAC7G"}