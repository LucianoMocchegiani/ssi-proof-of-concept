{"version":3,"file":"proofExchangeRecord.mjs","names":[],"sources":["../../../src/updates/0.4-0.5/proofExchangeRecord.ts"],"sourcesContent":["import type { BaseAgent } from '@credo-ts/core'\n\nimport { CredoError } from '@credo-ts/core'\n\nimport {\n  type DidCommProofExchangeRecord,\n  DidCommProofExchangeRepository,\n  DidCommProofRole,\n  DidCommProofState,\n  DidCommProposePresentationV2Message,\n  DidCommRequestPresentationV2Message,\n} from '../../modules/proofs'\nimport { DidCommMessageRepository, DidCommMessageRole } from '../../repository'\nimport { parseMessageType } from '../../util/messageType'\n\n/**\n * Migrates the {@link ProofExchangeExchangeRecord} to 0.5 compatible format. It fetches all proof exchange records from\n *  storage and applies the needed updates to the records. After a record has been transformed, it is updated\n * in storage and the next record will be transformed.\n *\n * The following transformations are applied:\n *  - {@link migrateRole}\n */\nexport async function migrateProofExchangeRecordToV0_5<Agent extends BaseAgent>(agent: Agent) {\n  agent.config.logger.info('Migrating proof exchange records to storage version 0.5')\n  const proofRepository = agent.dependencyManager.resolve(DidCommProofExchangeRepository)\n\n  agent.config.logger.debug('Fetching all proof records from storage')\n  const proofRecords = await proofRepository.getAll(agent.context)\n\n  agent.config.logger.debug(`Found a total of ${proofRecords.length} proof exchange records to update.`)\n  for (const proofRecord of proofRecords) {\n    agent.config.logger.debug(`Migrating proof exchange record with id ${proofRecord.id} to storage version 0.5`)\n\n    await migrateRole(agent, proofRecord)\n\n    // Save updated record\n    await proofRepository.update(agent.context, proofRecord)\n\n    agent.config.logger.debug(\n      `Successfully migrated proof exchange record with id ${proofRecord.id} to storage version 0.5`\n    )\n  }\n}\n\nconst proverProofStates = [\n  DidCommProofState.RequestReceived,\n  DidCommProofState.ProposalSent,\n  DidCommProofState.PresentationSent,\n  DidCommProofState.Declined,\n]\nconst verifierProofStates = [\n  DidCommProofState.RequestSent,\n  DidCommProofState.ProposalReceived,\n  DidCommProofState.PresentationReceived,\n]\n\nexport async function getProofRole(agent: BaseAgent, proofRecord: DidCommProofExchangeRecord) {\n  // For these states we know for certain that we're the prover\n  if (proverProofStates.includes(proofRecord.state)) {\n    return DidCommProofRole.Prover\n  }\n  // For these states we know for certain that we're the verifier\n  if (verifierProofStates.includes(proofRecord.state)) {\n    return DidCommProofRole.Verifier\n  }\n\n  // We now need to determine the role based on the didcomm message. Only the Done and Abandoned states\n  // remain and we can't be certain of the role based on the state alone.\n\n  // Fetch any of the associated proof messages that we can use to determine the role\n  // Either one of these MUST be present or we can't determine the role.\n  const didCommMessageRepository = agent.dependencyManager.resolve(DidCommMessageRepository)\n  const [didCommMessageRecord] = await didCommMessageRepository.findByQuery(agent.context, {\n    associatedRecordId: proofRecord.id,\n    $or: [\n      // We can't be certain which messages will be present.\n      { messageName: DidCommProposePresentationV2Message.type.messageName },\n      { messageName: DidCommRequestPresentationV2Message.type.messageName },\n    ],\n  })\n\n  if (!didCommMessageRecord) {\n    throw new CredoError(\n      `Unable to determine the role of the proof exchange record with id ${proofRecord.id} without any didcomm messages and state abandoned/done`\n    )\n  }\n\n  // Maps the message name and the didcomm message role to the respective proof role\n  const roleStateMapping = {\n    [DidCommProposePresentationV2Message.type.messageName]: {\n      [DidCommMessageRole.Sender]: DidCommProofRole.Prover,\n      [DidCommMessageRole.Receiver]: DidCommProofRole.Verifier,\n    },\n    [DidCommRequestPresentationV2Message.type.messageName]: {\n      [DidCommMessageRole.Sender]: DidCommProofRole.Verifier,\n      [DidCommMessageRole.Receiver]: DidCommProofRole.Prover,\n    },\n  }\n\n  const messageName = parseMessageType(didCommMessageRecord.message['@type']).messageName\n  const proofRole = roleStateMapping[messageName][didCommMessageRecord.role]\n\n  return proofRole\n}\n\n/**\n * Add a role to the proof record.\n */\nexport async function migrateRole<Agent extends BaseAgent>(agent: Agent, proofRecord: DidCommProofExchangeRecord) {\n  agent.config.logger.debug(`Adding role to record with id ${proofRecord.id} to for version 0.5`)\n\n  proofRecord.role = await getProofRole(agent, proofRecord)\n\n  agent.config.logger.debug(\n    `Successfully updated role to '${proofRecord.role}' on proof record with id ${proofRecord.id} to for version 0.5`\n  )\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;AAuBA,eAAsB,iCAA0D,OAAc;AAC5F,OAAM,OAAO,OAAO,KAAK,0DAA0D;CACnF,MAAM,kBAAkB,MAAM,kBAAkB,QAAQ,+BAA+B;AAEvF,OAAM,OAAO,OAAO,MAAM,0CAA0C;CACpE,MAAM,eAAe,MAAM,gBAAgB,OAAO,MAAM,QAAQ;AAEhE,OAAM,OAAO,OAAO,MAAM,oBAAoB,aAAa,OAAO,oCAAoC;AACtG,MAAK,MAAM,eAAe,cAAc;AACtC,QAAM,OAAO,OAAO,MAAM,2CAA2C,YAAY,GAAG,yBAAyB;AAE7G,QAAM,YAAY,OAAO,YAAY;AAGrC,QAAM,gBAAgB,OAAO,MAAM,SAAS,YAAY;AAExD,QAAM,OAAO,OAAO,MAClB,uDAAuD,YAAY,GAAG,yBACvE;;;AAIL,MAAM,oBAAoB;CACxB,kBAAkB;CAClB,kBAAkB;CAClB,kBAAkB;CAClB,kBAAkB;CACnB;AACD,MAAM,sBAAsB;CAC1B,kBAAkB;CAClB,kBAAkB;CAClB,kBAAkB;CACnB;AAED,eAAsB,aAAa,OAAkB,aAAyC;AAE5F,KAAI,kBAAkB,SAAS,YAAY,MAAM,CAC/C,QAAO,iBAAiB;AAG1B,KAAI,oBAAoB,SAAS,YAAY,MAAM,CACjD,QAAO,iBAAiB;CAS1B,MAAM,CAAC,wBAAwB,MADE,MAAM,kBAAkB,QAAQ,yBAAyB,CAC5B,YAAY,MAAM,SAAS;EACvF,oBAAoB,YAAY;EAChC,KAAK,CAEH,EAAE,aAAa,oCAAoC,KAAK,aAAa,EACrE,EAAE,aAAa,oCAAoC,KAAK,aAAa,CACtE;EACF,CAAC;AAEF,KAAI,CAAC,qBACH,OAAM,IAAI,WACR,qEAAqE,YAAY,GAAG,wDACrF;AAkBH,QAdyB;GACtB,oCAAoC,KAAK,cAAc;IACrD,mBAAmB,SAAS,iBAAiB;IAC7C,mBAAmB,WAAW,iBAAiB;GACjD;GACA,oCAAoC,KAAK,cAAc;IACrD,mBAAmB,SAAS,iBAAiB;IAC7C,mBAAmB,WAAW,iBAAiB;GACjD;EACF,CAEmB,iBAAiB,qBAAqB,QAAQ,SAAS,CAAC,aAC5B,qBAAqB;;;;;AAQvE,eAAsB,YAAqC,OAAc,aAAyC;AAChH,OAAM,OAAO,OAAO,MAAM,iCAAiC,YAAY,GAAG,qBAAqB;AAE/F,aAAY,OAAO,MAAM,aAAa,OAAO,YAAY;AAEzD,OAAM,OAAO,OAAO,MAClB,iCAAiC,YAAY,KAAK,4BAA4B,YAAY,GAAG,qBAC9F"}