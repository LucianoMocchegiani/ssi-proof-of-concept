import { parseMessageType } from "../../util/messageType.mjs";
import { DidCommMessageRepository } from "../../repository/DidCommMessageRepository.mjs";
import { DidCommMessageRole } from "../../repository/DidCommMessageRole.mjs";
import "../../repository/index.mjs";
import { DidCommProofState } from "../../modules/proofs/models/DidCommProofState.mjs";
import { DidCommProofExchangeRepository } from "../../modules/proofs/repository/DidCommProofExchangeRepository.mjs";
import { DidCommProofRole } from "../../modules/proofs/models/DidCommProofRole.mjs";
import { DidCommProposePresentationV2Message } from "../../modules/proofs/protocol/v2/messages/DidCommProposePresentationV2Message.mjs";
import { DidCommRequestPresentationV2Message } from "../../modules/proofs/protocol/v2/messages/DidCommRequestPresentationV2Message.mjs";
import "../../modules/proofs/index.mjs";
import { CredoError } from "@credo-ts/core";

//#region src/updates/0.4-0.5/proofExchangeRecord.ts
/**
* Migrates the {@link ProofExchangeExchangeRecord} to 0.5 compatible format. It fetches all proof exchange records from
*  storage and applies the needed updates to the records. After a record has been transformed, it is updated
* in storage and the next record will be transformed.
*
* The following transformations are applied:
*  - {@link migrateRole}
*/
async function migrateProofExchangeRecordToV0_5(agent) {
	agent.config.logger.info("Migrating proof exchange records to storage version 0.5");
	const proofRepository = agent.dependencyManager.resolve(DidCommProofExchangeRepository);
	agent.config.logger.debug("Fetching all proof records from storage");
	const proofRecords = await proofRepository.getAll(agent.context);
	agent.config.logger.debug(`Found a total of ${proofRecords.length} proof exchange records to update.`);
	for (const proofRecord of proofRecords) {
		agent.config.logger.debug(`Migrating proof exchange record with id ${proofRecord.id} to storage version 0.5`);
		await migrateRole(agent, proofRecord);
		await proofRepository.update(agent.context, proofRecord);
		agent.config.logger.debug(`Successfully migrated proof exchange record with id ${proofRecord.id} to storage version 0.5`);
	}
}
const proverProofStates = [
	DidCommProofState.RequestReceived,
	DidCommProofState.ProposalSent,
	DidCommProofState.PresentationSent,
	DidCommProofState.Declined
];
const verifierProofStates = [
	DidCommProofState.RequestSent,
	DidCommProofState.ProposalReceived,
	DidCommProofState.PresentationReceived
];
async function getProofRole(agent, proofRecord) {
	if (proverProofStates.includes(proofRecord.state)) return DidCommProofRole.Prover;
	if (verifierProofStates.includes(proofRecord.state)) return DidCommProofRole.Verifier;
	const [didCommMessageRecord] = await agent.dependencyManager.resolve(DidCommMessageRepository).findByQuery(agent.context, {
		associatedRecordId: proofRecord.id,
		$or: [{ messageName: DidCommProposePresentationV2Message.type.messageName }, { messageName: DidCommRequestPresentationV2Message.type.messageName }]
	});
	if (!didCommMessageRecord) throw new CredoError(`Unable to determine the role of the proof exchange record with id ${proofRecord.id} without any didcomm messages and state abandoned/done`);
	return {
		[DidCommProposePresentationV2Message.type.messageName]: {
			[DidCommMessageRole.Sender]: DidCommProofRole.Prover,
			[DidCommMessageRole.Receiver]: DidCommProofRole.Verifier
		},
		[DidCommRequestPresentationV2Message.type.messageName]: {
			[DidCommMessageRole.Sender]: DidCommProofRole.Verifier,
			[DidCommMessageRole.Receiver]: DidCommProofRole.Prover
		}
	}[parseMessageType(didCommMessageRecord.message["@type"]).messageName][didCommMessageRecord.role];
}
/**
* Add a role to the proof record.
*/
async function migrateRole(agent, proofRecord) {
	agent.config.logger.debug(`Adding role to record with id ${proofRecord.id} to for version 0.5`);
	proofRecord.role = await getProofRole(agent, proofRecord);
	agent.config.logger.debug(`Successfully updated role to '${proofRecord.role}' on proof record with id ${proofRecord.id} to for version 0.5`);
}

//#endregion
export { migrateProofExchangeRecordToV0_5 };
//# sourceMappingURL=proofExchangeRecord.mjs.map