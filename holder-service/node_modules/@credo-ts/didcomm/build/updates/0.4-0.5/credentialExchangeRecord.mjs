import { parseMessageType } from "../../util/messageType.mjs";
import { DidCommMessageRepository } from "../../repository/DidCommMessageRepository.mjs";
import { DidCommMessageRole } from "../../repository/DidCommMessageRole.mjs";
import "../../repository/index.mjs";
import { DidCommCredentialRole } from "../../modules/credentials/models/DidCommCredentialRole.mjs";
import { DidCommCredentialState } from "../../modules/credentials/models/DidCommCredentialState.mjs";
import { DidCommCredentialExchangeRepository } from "../../modules/credentials/repository/DidCommCredentialExchangeRepository.mjs";
import { DidCommOfferCredentialV2Message } from "../../modules/credentials/protocol/v2/messages/DidCommOfferCredentialV2Message.mjs";
import { DidCommProposeCredentialV2Message } from "../../modules/credentials/protocol/v2/messages/DidCommProposeCredentialV2Message.mjs";
import { DidCommRequestCredentialV2Message } from "../../modules/credentials/protocol/v2/messages/DidCommRequestCredentialV2Message.mjs";
import "../../modules/credentials/index.mjs";
import { CredoError } from "@credo-ts/core";

//#region src/updates/0.4-0.5/credentialExchangeRecord.ts
/**
* Migrates the {@link DidCommCredentialExchangeRecord} to 0.5 compatible format. It fetches all credential exchange records from
*  storage and applies the needed updates to the records. After a record has been transformed, it is updated
* in storage and the next record will be transformed.
*
* The following transformations are applied:
*  - {@link migrateRole}
*/
async function migrateCredentialExchangeRecordToV0_5(agent) {
	agent.config.logger.info("Migrating credential exchange records to storage version 0.5");
	const credentialRepository = agent.dependencyManager.resolve(DidCommCredentialExchangeRepository);
	agent.config.logger.debug("Fetching all credential records from storage");
	const credentialRecords = await credentialRepository.getAll(agent.context);
	agent.config.logger.debug(`Found a total of ${credentialRecords.length} credential exchange records to update.`);
	for (const credentialRecord of credentialRecords) {
		agent.config.logger.debug(`Migrating credential exchange record with id ${credentialRecord.id} to storage version 0.5`);
		await migrateRole(agent, credentialRecord);
		await credentialRepository.update(agent.context, credentialRecord);
		agent.config.logger.debug(`Successfully migrated credential exchange record with id ${credentialRecord.id} to storage version 0.5`);
	}
}
const holderCredentialStates = [
	DidCommCredentialState.Declined,
	DidCommCredentialState.ProposalSent,
	DidCommCredentialState.OfferReceived,
	DidCommCredentialState.RequestSent,
	DidCommCredentialState.CredentialReceived
];
const issuerCredentialStates = [
	DidCommCredentialState.ProposalReceived,
	DidCommCredentialState.OfferSent,
	DidCommCredentialState.RequestReceived,
	DidCommCredentialState.CredentialIssued
];
async function getCredentialRole(agent, credentialRecord) {
	if (credentialRecord.credentials.length > 0) return DidCommCredentialRole.Holder;
	if (credentialRecord.state === DidCommCredentialState.Done) return DidCommCredentialRole.Issuer;
	if (holderCredentialStates.includes(credentialRecord.state)) return DidCommCredentialRole.Holder;
	if (issuerCredentialStates.includes(credentialRecord.state)) return DidCommCredentialRole.Issuer;
	const [didCommMessageRecord] = await agent.dependencyManager.resolve(DidCommMessageRepository).findByQuery(agent.context, {
		associatedRecordId: credentialRecord.id,
		$or: [
			{ messageName: DidCommOfferCredentialV2Message.type.messageName },
			{ messageName: DidCommProposeCredentialV2Message.type.messageName },
			{ messageName: DidCommRequestCredentialV2Message.type.messageName }
		]
	});
	if (!didCommMessageRecord) throw new CredoError(`Unable to determine the role of the credential exchange record with id ${credentialRecord.id} without any didcomm messages and state abandoned`);
	return {
		[DidCommOfferCredentialV2Message.type.messageName]: {
			[DidCommMessageRole.Sender]: DidCommCredentialRole.Issuer,
			[DidCommMessageRole.Receiver]: DidCommCredentialRole.Holder
		},
		[DidCommProposeCredentialV2Message.type.messageName]: {
			[DidCommMessageRole.Sender]: DidCommCredentialRole.Holder,
			[DidCommMessageRole.Receiver]: DidCommCredentialRole.Issuer
		},
		[DidCommRequestCredentialV2Message.type.messageName]: {
			[DidCommMessageRole.Sender]: DidCommCredentialRole.Holder,
			[DidCommMessageRole.Receiver]: DidCommCredentialRole.Issuer
		}
	}[parseMessageType(didCommMessageRecord.message["@type"]).messageName][didCommMessageRecord.role];
}
/**
* Add a role to the credential record.
*/
async function migrateRole(agent, credentialRecord) {
	agent.config.logger.debug(`Adding role to record with id ${credentialRecord.id} to for version 0.4`);
	credentialRecord.role = await getCredentialRole(agent, credentialRecord);
	agent.config.logger.debug(`Successfully updated role to '${credentialRecord.role}' on credential record with id ${credentialRecord.id} to for version 0.4`);
}

//#endregion
export { migrateCredentialExchangeRecordToV0_5 };
//# sourceMappingURL=credentialExchangeRecord.mjs.map