{"version":3,"file":"credential.mjs","names":[],"sources":["../../../src/updates/0.1-0.2/credential.ts"],"sourcesContent":["import type { BaseAgent, JsonObject } from '@credo-ts/core'\nimport { Metadata } from '@credo-ts/core'\nimport type { DidCommCredentialExchangeRecord } from '../../modules/credentials'\nimport { DidCommCredentialState } from '../../modules/credentials/models/DidCommCredentialState'\nimport { DidCommCredentialExchangeRepository } from '../../modules/credentials/repository/DidCommCredentialExchangeRepository'\nimport { DidCommMessageRecord, DidCommMessageRepository, DidCommMessageRole } from '../../repository'\nimport type { DidCommPlaintextMessage } from '../../types'\n\n/**\n * Migrates the {@link CredentialRecord} to 0.2 compatible format. It fetches all records from storage\n * and applies the needed updates to the records. After a record has been transformed, it is updated\n * in storage and the next record will be transformed.\n *\n * The following transformations are applied:\n *  - {@link updateIndyMetadata}\n */\nexport async function migrateCredentialRecordToV0_2<Agent extends BaseAgent>(agent: Agent) {\n  agent.config.logger.info('Migrating credential records to storage version 0.2')\n  const credentialRepository = agent.dependencyManager.resolve(DidCommCredentialExchangeRepository)\n\n  agent.config.logger.debug('Fetching all credential records from storage')\n  const allCredentials = await credentialRepository.getAll(agent.context)\n\n  agent.config.logger.debug(`Found a total of ${allCredentials.length} credential records to update.`)\n  for (const credentialRecord of allCredentials) {\n    agent.config.logger.debug(`Migrating credential record with id ${credentialRecord.id} to storage version 0.2`)\n\n    await updateIndyMetadata(agent, credentialRecord)\n    await migrateInternalCredentialRecordProperties(agent, credentialRecord)\n    await moveDidCommMessages(agent, credentialRecord)\n\n    await credentialRepository.update(agent.context, credentialRecord)\n\n    agent.config.logger.debug(\n      `Successfully migrated credential record with id ${credentialRecord.id} to storage version 0.2`\n    )\n  }\n}\n\nexport enum V01_02MigrationCredentialRole {\n  Issuer = 0,\n  Holder = 1,\n}\n\nconst holderCredentialStates = [\n  DidCommCredentialState.Declined,\n  DidCommCredentialState.ProposalSent,\n  DidCommCredentialState.OfferReceived,\n  DidCommCredentialState.RequestSent,\n  DidCommCredentialState.CredentialReceived,\n]\n\nconst didCommMessageRoleMapping = {\n  [V01_02MigrationCredentialRole.Issuer]: {\n    proposalMessage: DidCommMessageRole.Receiver,\n    offerMessage: DidCommMessageRole.Sender,\n    requestMessage: DidCommMessageRole.Receiver,\n    credentialMessage: DidCommMessageRole.Sender,\n  },\n  [V01_02MigrationCredentialRole.Holder]: {\n    proposalMessage: DidCommMessageRole.Sender,\n    offerMessage: DidCommMessageRole.Receiver,\n    requestMessage: DidCommMessageRole.Sender,\n    credentialMessage: DidCommMessageRole.Receiver,\n  },\n}\n\nconst credentialRecordMessageKeys = ['proposalMessage', 'offerMessage', 'requestMessage', 'credentialMessage'] as const\n\nexport function getCredentialRole(credentialRecord: DidCommCredentialExchangeRecord) {\n  // Credentials will only have a value when a credential is received, meaning we're the holder\n  if (credentialRecord.credentials.length > 0) {\n    return V01_02MigrationCredentialRole.Holder\n  }\n  // If credentialRecord.credentials doesn't have any values, and we're also not in state done it means we're the issuer.\n  if (credentialRecord.state === DidCommCredentialState.Done) {\n    return V01_02MigrationCredentialRole.Issuer\n  }\n  // For these states we know for certain that we're the holder\n  if (holderCredentialStates.includes(credentialRecord.state)) {\n    return V01_02MigrationCredentialRole.Holder\n  }\n\n  // For all other states we can be certain we're the issuer\n  return V01_02MigrationCredentialRole.Issuer\n}\n\n/**\n * The credential record had a custom `metadata` property in pre-0.1.0 storage that contained the `requestMetadata`, `schemaId` and `credentialDefinition`\n * properties. Later a generic metadata API was added that only allows objects to be stored. Therefore the properties were moved into a different structure.\n *\n * This migration method updates the top level properties to the new nested metadata structure.\n *\n * The following pre-0.1.0 structure:\n *\n * ```json\n * {\n *   \"requestMetadata\": \"<value of requestMetadata>\",\n *   \"schemaId\": \"<value of schemaId>\",\n *   \"credentialDefinitionId\": \"<value of credential definition id>\"\n * }\n * ```\n *\n * Will be transformed into the following 0.2.0 structure:\n *\n * ```json\n * {\n *   \"_internal/indyRequest\": <value of requestMetadata>,\n *   \"_internal/indyCredential\": {\n *     \"schemaId\": \"<value of schemaId>\",\n *     \"credentialDefinitionId\": \"<value of credential definition id>\"\n *   }\n * }\n * ```\n */\nexport async function updateIndyMetadata<Agent extends BaseAgent>(\n  agent: Agent,\n  credentialRecord: DidCommCredentialExchangeRecord\n) {\n  agent.config.logger.debug('Updating indy metadata to use the generic metadata api available to records.')\n\n  const { requestMetadata, schemaId, credentialDefinitionId, ...rest } = credentialRecord.metadata.data\n  const metadata = new Metadata<Record<string, unknown>>(rest)\n\n  const indyRequestMetadataKey = '_internal/indyRequest'\n  const indyCredentialMetadataKey = '_internal/indyCredential'\n  if (requestMetadata) {\n    agent.config.logger.trace(`Found top-level 'requestMetadata' key, moving to '${indyRequestMetadataKey}'`)\n    metadata.add(indyRequestMetadataKey, { ...requestMetadata })\n  }\n\n  if (schemaId && typeof schemaId === 'string') {\n    agent.config.logger.trace(`Found top-level 'schemaId' key, moving to '${indyCredentialMetadataKey}.schemaId'`)\n    metadata.add(indyCredentialMetadataKey, { schemaId })\n  }\n\n  if (credentialDefinitionId && typeof credentialDefinitionId === 'string') {\n    agent.config.logger.trace(\n      `Found top-level 'credentialDefinitionId' key, moving to '${indyCredentialMetadataKey}.credentialDefinitionId'`\n    )\n    metadata.add(indyCredentialMetadataKey, { credentialDefinitionId })\n  }\n\n  credentialRecord.metadata = metadata\n}\n\n/**\n * With the addition of support for different protocol versions the credential record now stores the protocol version.\n * With the addition of issue credential v2 support, other credential formats than indy can be used, and multiple credentials can be issued at once. To\n * account for this the `credentialId` has been replaced by the `credentials` array. This is an array of objects containing the `credentialRecordId` and\n * the `credentialRecordType`. For all current credentials the `credentialRecordType` will always be `indy`.\n *\n * The following 0.1.0 credential record structure (unrelated keys omitted):\n *\n * ```json\n * {\n *   \"credentialId\": \"09e46da9-a575-4909-b016-040e96c3c539\"\n * }\n * ```\n *\n * Will be transformed into the following 0.2.0 structure (unrelated keys omitted):\n *\n * ```json\n * {\n *  \"protocolVersion: \"v1\",\n *  \"credentials\": [\n *    {\n *      \"credentialRecordId\": \"09e46da9-a575-4909-b016-040e96c3c539\",\n *      \"credentialRecordType\": \"anoncreds\"\n *    }\n *  ]\n * }\n * ```\n */\nexport async function migrateInternalCredentialRecordProperties<Agent extends BaseAgent>(\n  agent: Agent,\n  credentialRecord: DidCommCredentialExchangeRecord\n) {\n  agent.config.logger.debug(\n    `Migrating internal credential record ${credentialRecord.id} properties to storage version 0.2`\n  )\n\n  if (!credentialRecord.protocolVersion) {\n    agent.config.logger.debug('Setting protocolVersion to v1')\n    credentialRecord.protocolVersion = 'v1'\n  }\n\n  const untypedCredentialRecord = credentialRecord as unknown as JsonObject\n\n  if (untypedCredentialRecord.credentialId) {\n    agent.config.logger.debug(`Migrating indy credentialId ${untypedCredentialRecord.id} to credentials array`)\n    credentialRecord.credentials = [\n      {\n        credentialRecordId: untypedCredentialRecord.credentialId as string,\n        credentialRecordType: 'indy',\n      },\n    ]\n\n    // biome-ignore lint/performance/noDelete: no explanation\n    delete untypedCredentialRecord.credentialId\n  }\n\n  agent.config.logger.debug(\n    `Successfully migrated internal credential record ${credentialRecord.id} properties to storage version 0.2`\n  )\n}\n\n/**\n * In 0.2.0 the v1 didcomm messages have been moved out of the credential record into separate record using the DidCommMessageRepository.\n * This migration scripts extracts all message (proposalMessage, offerMessage, requestMessage, credentialMessage) and moves\n * them into the DidCommMessageRepository.\n */\nexport async function moveDidCommMessages<Agent extends BaseAgent>(\n  agent: Agent,\n  credentialRecord: DidCommCredentialExchangeRecord\n) {\n  agent.config.logger.debug(\n    `Moving didcomm messages from credential record with id ${credentialRecord.id} to DidCommMessageRecord`\n  )\n  const didCommMessageRepository = agent.dependencyManager.resolve(DidCommMessageRepository)\n\n  for (const messageKey of credentialRecordMessageKeys) {\n    agent.config.logger.debug(\n      `Starting move of ${messageKey} from credential record with id ${credentialRecord.id} to DIDCommMessageRecord`\n    )\n    const credentialRecordJson = credentialRecord as unknown as JsonObject\n    const message = credentialRecordJson[messageKey] as DidCommPlaintextMessage | undefined\n\n    if (message) {\n      const credentialRole = getCredentialRole(credentialRecord)\n      const didCommMessageRole = didCommMessageRoleMapping[credentialRole][messageKey]\n\n      const didCommMessageRecord = new DidCommMessageRecord({\n        role: didCommMessageRole,\n        associatedRecordId: credentialRecord.id,\n        message,\n      })\n      await didCommMessageRepository.save(agent.context, didCommMessageRecord)\n\n      agent.config.logger.debug(\n        `Successfully moved ${messageKey} from credential record with id ${credentialRecord.id} to DIDCommMessageRecord`\n      )\n\n      delete credentialRecordJson[messageKey]\n    } else {\n      agent.config.logger.debug(\n        `Credential record with id ${credentialRecord.id} does not have a ${messageKey}. Not creating a DIDCommMessageRecord`\n      )\n    }\n  }\n\n  agent.config.logger.debug(\n    `Successfully moved didcomm messages from credential record with id ${credentialRecord.id} to DIDCommMessageRecord`\n  )\n}\n"],"mappings":"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"}