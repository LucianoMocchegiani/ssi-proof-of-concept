{"version":3,"file":"mediation.mjs","names":[],"sources":["../../../src/updates/0.1-0.2/mediation.ts"],"sourcesContent":["import type { BaseAgent, V0_1ToV0_2UpdateConfig } from '@credo-ts/core'\nimport type { DidCommMediationRecord } from '../../modules/routing'\n\nimport { DidCommMediationRepository, DidCommMediationRole } from '../../modules/routing'\n\n/**\n * Migrates the {@link DidCommMediationRecord} to 0.2 compatible format. It fetches all records from storage\n * and applies the needed updates to the records. After a record has been transformed, it is updated\n * in storage and the next record will be transformed.\n *\n * The following transformations are applied:\n *  - {@link updateMediationRole}\n */\nexport async function migrateMediationRecordToV0_2<Agent extends BaseAgent>(\n  agent: Agent,\n  upgradeConfig: V0_1ToV0_2UpdateConfig\n) {\n  agent.config.logger.info('Migrating mediation records to storage version 0.2')\n  const mediationRepository = agent.dependencyManager.resolve(DidCommMediationRepository)\n\n  agent.config.logger.debug('Fetching all mediation records from storage')\n  const allMediationRecords = await mediationRepository.getAll(agent.context)\n\n  agent.config.logger.debug(`Found a total of ${allMediationRecords.length} mediation records to update.`)\n  for (const mediationRecord of allMediationRecords) {\n    agent.config.logger.debug(`Migrating mediation record with id ${mediationRecord.id} to storage version 0.2`)\n\n    await updateMediationRole(agent, mediationRecord, upgradeConfig)\n\n    await mediationRepository.update(agent.context, mediationRecord)\n\n    agent.config.logger.debug(\n      `Successfully migrated mediation record with id ${mediationRecord.id} to storage version 0.2`\n    )\n  }\n}\n\n/**\n * The role in the mediation record was always being set to {@link DidCommMediationRole.Mediator} for both mediators and recipients. This didn't cause any issues, but would return the wrong role for recipients.\n *\n * In 0.2 a check is added to make sure the role of a mediation record matches with actions (e.g. a recipient can't grant mediation), which means it will throw an error if the role is not set correctly.\n *\n * Because it's not always possible detect whether the role should actually be mediator or recipient, a number of configuration options are provided on how the role should be updated:\n *\n * - `allMediator`: The role is set to {@link DidCommMediationRole.Mediator} for both mediators and recipients\n * - `allRecipient`: The role is set to {@link DidCommMediationRole.Recipient} for both mediators and recipients\n * - `recipientIfEndpoint`: The role is set to {@link DidCommMediationRole.Recipient} if their is an `endpoint` configured on the record otherwise it is set to {@link DidCommMediationRole.Mediator}.\n *      The endpoint is not set when running as a mediator, so in theory this allows to determine the role of the record.\n *      There is one case where this could be problematic when the role should be recipient, if the mediation grant hasn't actually occurred (meaning the endpoint is not set).\n * - `doNotChange`: The role is not changed\n *\n * Most agents only act as either the role of mediator or recipient, in which case the `allMediator` or `allRecipient` configuration is the most appropriate. If your agent acts as both a recipient and mediator, the `recipientIfEndpoint` configuration is the most appropriate. The `doNotChange` options is not recommended and can lead to errors if the role is not set correctly.\n *\n */\nexport async function updateMediationRole<Agent extends BaseAgent>(\n  agent: Agent,\n  mediationRecord: DidCommMediationRecord,\n  { mediationRoleUpdateStrategy }: V0_1ToV0_2UpdateConfig\n) {\n  agent.config.logger.debug(`Updating mediation record role using strategy '${mediationRoleUpdateStrategy}'`)\n\n  switch (mediationRoleUpdateStrategy) {\n    case 'allMediator':\n      mediationRecord.role = DidCommMediationRole.Mediator\n      break\n    case 'allRecipient':\n      mediationRecord.role = DidCommMediationRole.Recipient\n      break\n    case 'recipientIfEndpoint':\n      if (mediationRecord.endpoint) {\n        agent.config.logger.debug('Mediation record endpoint is set, setting mediation role to recipient')\n        mediationRecord.role = DidCommMediationRole.Recipient\n      } else {\n        agent.config.logger.debug('Mediation record endpoint is not set, setting mediation role to mediator')\n        mediationRecord.role = DidCommMediationRole.Mediator\n      }\n      break\n    case 'doNotChange':\n      break\n  }\n}\n"],"mappings":";;;;;;;;;;;;;AAaA,eAAsB,6BACpB,OACA,eACA;AACA,OAAM,OAAO,OAAO,KAAK,qDAAqD;CAC9E,MAAM,sBAAsB,MAAM,kBAAkB,QAAQ,2BAA2B;AAEvF,OAAM,OAAO,OAAO,MAAM,8CAA8C;CACxE,MAAM,sBAAsB,MAAM,oBAAoB,OAAO,MAAM,QAAQ;AAE3E,OAAM,OAAO,OAAO,MAAM,oBAAoB,oBAAoB,OAAO,+BAA+B;AACxG,MAAK,MAAM,mBAAmB,qBAAqB;AACjD,QAAM,OAAO,OAAO,MAAM,sCAAsC,gBAAgB,GAAG,yBAAyB;AAE5G,QAAM,oBAAoB,OAAO,iBAAiB,cAAc;AAEhE,QAAM,oBAAoB,OAAO,MAAM,SAAS,gBAAgB;AAEhE,QAAM,OAAO,OAAO,MAClB,kDAAkD,gBAAgB,GAAG,yBACtE;;;;;;;;;;;;;;;;;;;;AAqBL,eAAsB,oBACpB,OACA,iBACA,EAAE,+BACF;AACA,OAAM,OAAO,OAAO,MAAM,kDAAkD,4BAA4B,GAAG;AAE3G,SAAQ,6BAAR;EACE,KAAK;AACH,mBAAgB,OAAO,qBAAqB;AAC5C;EACF,KAAK;AACH,mBAAgB,OAAO,qBAAqB;AAC5C;EACF,KAAK;AACH,OAAI,gBAAgB,UAAU;AAC5B,UAAM,OAAO,OAAO,MAAM,wEAAwE;AAClG,oBAAgB,OAAO,qBAAqB;UACvC;AACL,UAAM,OAAO,OAAO,MAAM,2EAA2E;AACrG,oBAAgB,OAAO,qBAAqB;;AAE9C;EACF,KAAK,cACH"}