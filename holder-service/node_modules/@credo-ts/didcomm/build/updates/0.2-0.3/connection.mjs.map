{"version":3,"file":"connection.mjs","names":[],"sources":["../../../src/updates/0.2-0.3/connection.ts"],"sourcesContent":["import type { BaseAgent } from '@credo-ts/core'\nimport type { DidCommConnectionRecord } from '../../modules/connections'\n\nimport { DidCommConnectionRepository, DidCommConnectionType } from '../../modules/connections'\nimport { DidCommMediationRepository } from '../../modules/routing'\n\n/**\n * Migrate the {@link DidCommConnectionRecord} to a 0.3 compatible format.\n *\n * @param agent\n */\nexport async function migrateConnectionRecordToV0_3<Agent extends BaseAgent>(agent: Agent) {\n  agent.config.logger.info('Migrating connection records to storage version 0.3')\n  const connectionRepository = agent.dependencyManager.resolve(DidCommConnectionRepository)\n  const mediationRepository = agent.dependencyManager.resolve(DidCommMediationRepository)\n\n  agent.config.logger.debug('Fetching all connection records from storage')\n  const allConnections = await connectionRepository.getAll(agent.context)\n  agent.config.logger.debug(`Found a total of ${allConnections.length} connection records to update`)\n\n  agent.config.logger.debug('Fetching all mediation records from storage')\n  const allMediators = await mediationRepository.getAll(agent.context)\n  agent.config.logger.debug(`Found a total of ${allMediators.length} mediation records`)\n\n  const mediatorConnectionIds = new Set(allMediators.map((mediator) => mediator.connectionId))\n\n  for (const connectionRecord of allConnections) {\n    agent.config.logger.debug(`Migrating connection record with id ${connectionRecord.id} to storage version 0.3`)\n\n    await migrateConnectionRecordTags(agent, connectionRecord, mediatorConnectionIds)\n    await connectionRepository.update(agent.context, connectionRecord)\n\n    agent.config.logger.debug(\n      `Successfully migrated connection record with id ${connectionRecord.id} to storage version 0.3`\n    )\n  }\n}\n\n/**\n *\n * @param agent\n * @param connectionRecord\n */\nexport async function migrateConnectionRecordTags<Agent extends BaseAgent>(\n  agent: Agent,\n  connectionRecord: DidCommConnectionRecord,\n  mediatorConnectionIds: Set<string> = new Set()\n) {\n  agent.config.logger.debug(\n    `Migrating internal connection record type tags ${connectionRecord.id} to storage version 0.3`\n  )\n\n  // Old connection records will have tags set in the 'connectionType' property\n  const connectionTypeTags = (connectionRecord.getTags().connectionType || []) as [string]\n  const connectionTypes = [...connectionTypeTags]\n\n  if (mediatorConnectionIds.has(connectionRecord.id) && !connectionTypes.includes(DidCommConnectionType.Mediator)) {\n    connectionTypes.push(DidCommConnectionType.Mediator)\n  }\n\n  connectionRecord.connectionTypes = connectionTypes\n  connectionRecord.setTag('connectionType', undefined)\n\n  agent.config.logger.debug(\n    `Successfully migrated internal connection record type tags ${connectionRecord.id} to storage version 0.3`\n  )\n}\n"],"mappings":";;;;;;;;;;;;AAWA,eAAsB,8BAAuD,OAAc;AACzF,OAAM,OAAO,OAAO,KAAK,sDAAsD;CAC/E,MAAM,uBAAuB,MAAM,kBAAkB,QAAQ,4BAA4B;CACzF,MAAM,sBAAsB,MAAM,kBAAkB,QAAQ,2BAA2B;AAEvF,OAAM,OAAO,OAAO,MAAM,+CAA+C;CACzE,MAAM,iBAAiB,MAAM,qBAAqB,OAAO,MAAM,QAAQ;AACvE,OAAM,OAAO,OAAO,MAAM,oBAAoB,eAAe,OAAO,+BAA+B;AAEnG,OAAM,OAAO,OAAO,MAAM,8CAA8C;CACxE,MAAM,eAAe,MAAM,oBAAoB,OAAO,MAAM,QAAQ;AACpE,OAAM,OAAO,OAAO,MAAM,oBAAoB,aAAa,OAAO,oBAAoB;CAEtF,MAAM,wBAAwB,IAAI,IAAI,aAAa,KAAK,aAAa,SAAS,aAAa,CAAC;AAE5F,MAAK,MAAM,oBAAoB,gBAAgB;AAC7C,QAAM,OAAO,OAAO,MAAM,uCAAuC,iBAAiB,GAAG,yBAAyB;AAE9G,QAAM,4BAA4B,OAAO,kBAAkB,sBAAsB;AACjF,QAAM,qBAAqB,OAAO,MAAM,SAAS,iBAAiB;AAElE,QAAM,OAAO,OAAO,MAClB,mDAAmD,iBAAiB,GAAG,yBACxE;;;;;;;;AASL,eAAsB,4BACpB,OACA,kBACA,wCAAqC,IAAI,KAAK,EAC9C;AACA,OAAM,OAAO,OAAO,MAClB,kDAAkD,iBAAiB,GAAG,yBACvE;CAID,MAAM,kBAAkB,CAAC,GADG,iBAAiB,SAAS,CAAC,kBAAkB,EAAE,CAC5B;AAE/C,KAAI,sBAAsB,IAAI,iBAAiB,GAAG,IAAI,CAAC,gBAAgB,SAAS,sBAAsB,SAAS,CAC7G,iBAAgB,KAAK,sBAAsB,SAAS;AAGtD,kBAAiB,kBAAkB;AACnC,kBAAiB,OAAO,kBAAkB,OAAU;AAEpD,OAAM,OAAO,OAAO,MAClB,8DAA8D,iBAAiB,GAAG,yBACnF"}