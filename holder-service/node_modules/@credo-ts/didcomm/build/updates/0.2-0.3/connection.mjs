import { DidCommConnectionType } from "../../modules/connections/models/DidCommConnectionType.mjs";
import { DidCommConnectionRepository } from "../../modules/connections/repository/DidCommConnectionRepository.mjs";
import { DidCommMediationRepository } from "../../modules/routing/repository/DidCommMediationRepository.mjs";
import "../../modules/connections/index.mjs";
import "../../modules/routing/index.mjs";

//#region src/updates/0.2-0.3/connection.ts
/**
* Migrate the {@link DidCommConnectionRecord} to a 0.3 compatible format.
*
* @param agent
*/
async function migrateConnectionRecordToV0_3(agent) {
	agent.config.logger.info("Migrating connection records to storage version 0.3");
	const connectionRepository = agent.dependencyManager.resolve(DidCommConnectionRepository);
	const mediationRepository = agent.dependencyManager.resolve(DidCommMediationRepository);
	agent.config.logger.debug("Fetching all connection records from storage");
	const allConnections = await connectionRepository.getAll(agent.context);
	agent.config.logger.debug(`Found a total of ${allConnections.length} connection records to update`);
	agent.config.logger.debug("Fetching all mediation records from storage");
	const allMediators = await mediationRepository.getAll(agent.context);
	agent.config.logger.debug(`Found a total of ${allMediators.length} mediation records`);
	const mediatorConnectionIds = new Set(allMediators.map((mediator) => mediator.connectionId));
	for (const connectionRecord of allConnections) {
		agent.config.logger.debug(`Migrating connection record with id ${connectionRecord.id} to storage version 0.3`);
		await migrateConnectionRecordTags(agent, connectionRecord, mediatorConnectionIds);
		await connectionRepository.update(agent.context, connectionRecord);
		agent.config.logger.debug(`Successfully migrated connection record with id ${connectionRecord.id} to storage version 0.3`);
	}
}
/**
*
* @param agent
* @param connectionRecord
*/
async function migrateConnectionRecordTags(agent, connectionRecord, mediatorConnectionIds = /* @__PURE__ */ new Set()) {
	agent.config.logger.debug(`Migrating internal connection record type tags ${connectionRecord.id} to storage version 0.3`);
	const connectionTypes = [...connectionRecord.getTags().connectionType || []];
	if (mediatorConnectionIds.has(connectionRecord.id) && !connectionTypes.includes(DidCommConnectionType.Mediator)) connectionTypes.push(DidCommConnectionType.Mediator);
	connectionRecord.connectionTypes = connectionTypes;
	connectionRecord.setTag("connectionType", void 0);
	agent.config.logger.debug(`Successfully migrated internal connection record type tags ${connectionRecord.id} to storage version 0.3`);
}

//#endregion
export { migrateConnectionRecordToV0_3 };
//# sourceMappingURL=connection.mjs.map