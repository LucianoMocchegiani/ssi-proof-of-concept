{"version":3,"file":"proof.mjs","names":[],"sources":["../../../src/updates/0.2-0.3/proof.ts"],"sourcesContent":["import type { BaseAgent, JsonObject } from '@credo-ts/core'\nimport {\n  type DidCommProofExchangeRecord,\n  DidCommProofExchangeRepository,\n  DidCommProofState,\n} from '../../modules/proofs'\nimport { DidCommMessageRecord, DidCommMessageRepository, DidCommMessageRole } from '../../repository'\nimport type { DidCommPlaintextMessage } from '../../types'\n\n/**\n * Migrates the {@link DidCommProofExchangeRecord} to 0.3 compatible format. It fetches all records from storage\n * and applies the needed updates to the records. After a record has been transformed, it is updated\n * in storage and the next record will be transformed.\n *\n * The following transformations are applied:\n *  - {@link migrateInternalProofExchangeRecordProperties}\n *  - {@link moveDidCommMessages}\n */\nexport async function migrateProofExchangeRecordToV0_3<Agent extends BaseAgent>(agent: Agent) {\n  agent.config.logger.info('Migrating proof records to storage version 0.3')\n  const proofRepository = agent.dependencyManager.resolve(DidCommProofExchangeRepository)\n\n  agent.config.logger.debug('Fetching all proof records from storage')\n  const allProofs = await proofRepository.getAll(agent.context)\n\n  agent.config.logger.debug(`Found a total of ${allProofs.length} proof records to update.`)\n  for (const proofRecord of allProofs) {\n    agent.config.logger.debug(`Migrating proof record with id ${proofRecord.id} to storage version 0.3`)\n\n    await migrateInternalProofExchangeRecordProperties(agent, proofRecord)\n    await moveDidCommMessages(agent, proofRecord)\n\n    await proofRepository.update(agent.context, proofRecord)\n\n    agent.config.logger.debug(`Successfully migrated proof record with id ${proofRecord.id} to storage version 0.3`)\n  }\n}\n\nexport enum V02_03MigrationProofRole {\n  Verifier = 0,\n  Prover = 1,\n}\n\nconst proverProofStates = [\n  DidCommProofState.Declined,\n  DidCommProofState.ProposalSent,\n  DidCommProofState.RequestReceived,\n  DidCommProofState.PresentationSent,\n  DidCommProofState.Done,\n]\n\nconst didCommMessageRoleMapping = {\n  [V02_03MigrationProofRole.Verifier]: {\n    proposalMessage: DidCommMessageRole.Receiver,\n    requestMessage: DidCommMessageRole.Sender,\n    presentationMessage: DidCommMessageRole.Receiver,\n  },\n  [V02_03MigrationProofRole.Prover]: {\n    proposalMessage: DidCommMessageRole.Sender,\n    requestMessage: DidCommMessageRole.Receiver,\n    presentationMessage: DidCommMessageRole.Sender,\n  },\n}\n\nconst proofRecordMessageKeys = ['proposalMessage', 'requestMessage', 'presentationMessage'] as const\n\nexport function getProofRole(proofRecord: DidCommProofExchangeRecord) {\n  // Proofs will only have an isVerified value when a presentation is verified, meaning we're the verifier\n  if (proofRecord.isVerified !== undefined) {\n    return V02_03MigrationProofRole.Verifier\n  }\n  // If proofRecord.isVerified doesn't have any value, and we're also not in state done it means we're the prover.\n  if (proofRecord.state === DidCommProofState.Done) {\n    return V02_03MigrationProofRole.Prover\n  }\n  // For these states we know for certain that we're the prover\n  if (proverProofStates.includes(proofRecord.state)) {\n    return V02_03MigrationProofRole.Prover\n  }\n\n  // For all other states we can be certain we're the verifier\n  return V02_03MigrationProofRole.Verifier\n}\n\n/**\n * With the addition of support for different protocol versions the proof record now stores the protocol version.\n *\n * The following 0.2.0 proof record structure (unrelated keys omitted):\n *\n * ```json\n * {\n * }\n * ```\n *\n * Will be transformed into the following 0.3.0 structure (unrelated keys omitted):\n *\n * ```json\n * {\n *  \"protocolVersion: \"v1\"\n * }\n * ```\n */\nexport async function migrateInternalProofExchangeRecordProperties<Agent extends BaseAgent>(\n  agent: Agent,\n  proofRecord: DidCommProofExchangeRecord\n) {\n  agent.config.logger.debug(`Migrating internal proof record ${proofRecord.id} properties to storage version 0.3`)\n\n  if (!proofRecord.protocolVersion) {\n    agent.config.logger.debug('Setting protocolVersion to v1')\n    proofRecord.protocolVersion = 'v1'\n  }\n\n  agent.config.logger.debug(\n    `Successfully migrated internal proof record ${proofRecord.id} properties to storage version 0.3`\n  )\n}\n\n/**\n * In 0.3.0 the v1 didcomm messages have been moved out of the proof record into separate record using the DidCommMessageRepository.\n * This migration scripts extracts all message (proposalMessage, requestMessage, presentationMessage) and moves\n * them into the DidCommMessageRepository.\n */\nexport async function moveDidCommMessages<Agent extends BaseAgent>(\n  agent: Agent,\n  proofRecord: DidCommProofExchangeRecord\n) {\n  agent.config.logger.debug(\n    `Moving didcomm messages from proof record with id ${proofRecord.id} to DidCommMessageRecord`\n  )\n  const didCommMessageRepository = agent.dependencyManager.resolve(DidCommMessageRepository)\n\n  for (const messageKey of proofRecordMessageKeys) {\n    agent.config.logger.debug(\n      `Starting move of ${messageKey} from proof record with id ${proofRecord.id} to DIDCommMessageRecord`\n    )\n    const proofRecordJson = proofRecord as unknown as JsonObject\n    const message = proofRecordJson[messageKey] as DidCommPlaintextMessage | undefined\n\n    if (message) {\n      const proofRole = getProofRole(proofRecord)\n      const didCommMessageRole = didCommMessageRoleMapping[proofRole][messageKey]\n\n      const didCommMessageRecord = new DidCommMessageRecord({\n        role: didCommMessageRole,\n        associatedRecordId: proofRecord.id,\n        message,\n      })\n      await didCommMessageRepository.save(agent.context, didCommMessageRecord)\n\n      agent.config.logger.debug(\n        `Successfully moved ${messageKey} from proof record with id ${proofRecord.id} to DIDCommMessageRecord`\n      )\n\n      delete proofRecordJson[messageKey]\n    } else {\n      agent.config.logger.debug(\n        `Proof record with id ${proofRecord.id} does not have a ${messageKey}. Not creating a DIDCommMessageRecord`\n      )\n    }\n  }\n\n  agent.config.logger.debug(\n    `Successfully moved didcomm messages from proof record with id ${proofRecord.id} to DIDCommMessageRecord`\n  )\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;AAkBA,eAAsB,iCAA0D,OAAc;AAC5F,OAAM,OAAO,OAAO,KAAK,iDAAiD;CAC1E,MAAM,kBAAkB,MAAM,kBAAkB,QAAQ,+BAA+B;AAEvF,OAAM,OAAO,OAAO,MAAM,0CAA0C;CACpE,MAAM,YAAY,MAAM,gBAAgB,OAAO,MAAM,QAAQ;AAE7D,OAAM,OAAO,OAAO,MAAM,oBAAoB,UAAU,OAAO,2BAA2B;AAC1F,MAAK,MAAM,eAAe,WAAW;AACnC,QAAM,OAAO,OAAO,MAAM,kCAAkC,YAAY,GAAG,yBAAyB;AAEpG,QAAM,6CAA6C,OAAO,YAAY;AACtE,QAAM,oBAAoB,OAAO,YAAY;AAE7C,QAAM,gBAAgB,OAAO,MAAM,SAAS,YAAY;AAExD,QAAM,OAAO,OAAO,MAAM,8CAA8C,YAAY,GAAG,yBAAyB;;;AAIpH,IAAY,8EAAL;AACL;AACA;;;AAGF,MAAM,oBAAoB;CACxB,kBAAkB;CAClB,kBAAkB;CAClB,kBAAkB;CAClB,kBAAkB;CAClB,kBAAkB;CACnB;AAED,MAAM,4BAA4B;EAC/B,yBAAyB,WAAW;EACnC,iBAAiB,mBAAmB;EACpC,gBAAgB,mBAAmB;EACnC,qBAAqB,mBAAmB;EACzC;EACA,yBAAyB,SAAS;EACjC,iBAAiB,mBAAmB;EACpC,gBAAgB,mBAAmB;EACnC,qBAAqB,mBAAmB;EACzC;CACF;AAED,MAAM,yBAAyB;CAAC;CAAmB;CAAkB;CAAsB;AAE3F,SAAgB,aAAa,aAAyC;AAEpE,KAAI,YAAY,eAAe,OAC7B,QAAO,yBAAyB;AAGlC,KAAI,YAAY,UAAU,kBAAkB,KAC1C,QAAO,yBAAyB;AAGlC,KAAI,kBAAkB,SAAS,YAAY,MAAM,CAC/C,QAAO,yBAAyB;AAIlC,QAAO,yBAAyB;;;;;;;;;;;;;;;;;;;;AAqBlC,eAAsB,6CACpB,OACA,aACA;AACA,OAAM,OAAO,OAAO,MAAM,mCAAmC,YAAY,GAAG,oCAAoC;AAEhH,KAAI,CAAC,YAAY,iBAAiB;AAChC,QAAM,OAAO,OAAO,MAAM,gCAAgC;AAC1D,cAAY,kBAAkB;;AAGhC,OAAM,OAAO,OAAO,MAClB,+CAA+C,YAAY,GAAG,oCAC/D;;;;;;;AAQH,eAAsB,oBACpB,OACA,aACA;AACA,OAAM,OAAO,OAAO,MAClB,qDAAqD,YAAY,GAAG,0BACrE;CACD,MAAM,2BAA2B,MAAM,kBAAkB,QAAQ,yBAAyB;AAE1F,MAAK,MAAM,cAAc,wBAAwB;AAC/C,QAAM,OAAO,OAAO,MAClB,oBAAoB,WAAW,6BAA6B,YAAY,GAAG,0BAC5E;EACD,MAAM,kBAAkB;EACxB,MAAM,UAAU,gBAAgB;AAEhC,MAAI,SAAS;GAEX,MAAM,qBAAqB,0BADT,aAAa,YAAY,EACqB;GAEhE,MAAM,uBAAuB,IAAI,qBAAqB;IACpD,MAAM;IACN,oBAAoB,YAAY;IAChC;IACD,CAAC;AACF,SAAM,yBAAyB,KAAK,MAAM,SAAS,qBAAqB;AAExE,SAAM,OAAO,OAAO,MAClB,sBAAsB,WAAW,6BAA6B,YAAY,GAAG,0BAC9E;AAED,UAAO,gBAAgB;QAEvB,OAAM,OAAO,OAAO,MAClB,wBAAwB,YAAY,GAAG,mBAAmB,WAAW,uCACtE;;AAIL,OAAM,OAAO,OAAO,MAClB,iEAAiE,YAAY,GAAG,0BACjF"}