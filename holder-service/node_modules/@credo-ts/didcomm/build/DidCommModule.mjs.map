{"version":3,"file":"DidCommModule.mjs","names":[],"sources":["../src/DidCommModule.ts"],"sourcesContent":["import type { AgentContext, Constructor, DependencyManager, Module, Update } from '@credo-ts/core'\nimport { EventEmitter, InjectionSymbols } from '@credo-ts/core'\nimport type { Subject } from 'rxjs'\nimport { mergeMap, takeUntil } from 'rxjs'\nimport { DidCommApi } from './DidCommApi'\nimport { DidCommDispatcher } from './DidCommDispatcher'\nimport { DidCommEnvelopeService } from './DidCommEnvelopeService'\nimport type { DidCommMessageReceivedEvent } from './DidCommEvents'\nimport { DidCommEventTypes } from './DidCommEvents'\nimport { DidCommFeatureRegistry } from './DidCommFeatureRegistry'\nimport { DidCommMessageHandlerRegistry } from './DidCommMessageHandlerRegistry'\nimport { DidCommMessageReceiver } from './DidCommMessageReceiver'\nimport { DidCommMessageSender } from './DidCommMessageSender'\nimport type { DidCommModuleConfigOptions } from './DidCommModuleConfig'\nimport { DidCommModuleConfig } from './DidCommModuleConfig'\nimport { DidCommTransportService } from './DidCommTransportService'\nimport {\n  type DefaultDidCommMessagePickupProtocols,\n  type DefaultDidCommProofProtocols,\n  DidCommBasicMessagesModule,\n  DidCommConnectionsModule,\n  type DidCommCredentialProtocol,\n  DidCommDiscoverFeaturesModule,\n  DidCommMessagePickupModule,\n  type DidCommMessagePickupModuleConfigOptions,\n  type DidCommMessagePickupProtocol,\n  DidCommOutOfBandModule,\n  type DidCommProofProtocol,\n  DidCommProofsModule,\n  type DidCommProofsModuleConfigOptions,\n} from './modules'\nimport {\n  type DefaultDidCommCredentialProtocols,\n  DidCommCredentialsModule,\n} from './modules/credentials/DidCommCredentialsModule'\nimport type { DidCommCredentialsModuleConfigOptions } from './modules/credentials/DidCommCredentialsModuleConfig'\nimport { DidCommMediationRecipientModule } from './modules/routing/DidCommMediationRecipientModule'\nimport { DidCommMediatorModule } from './modules/routing/DidCommMediatorModule'\nimport { DidCommMessageRepository } from './repository'\nimport { updateV0_1ToV0_2 } from './updates/0.1-0.2'\nimport { updateV0_2ToV0_3 } from './updates/0.2-0.3'\nimport { updateV0_4ToV0_5 } from './updates/0.4-0.5'\n\n// biome-ignore lint/complexity/noBannedTypes: no explanation\ntype ModuleOrEmpty<Config, Module> = Config extends false ? {} : Module\n\ntype DidCommModules<Options extends DidCommModuleConfigOptions> = {\n  connections: DidCommConnectionsModule\n  oob: DidCommOutOfBandModule\n  discovery: DidCommDiscoverFeaturesModule\n} & ModuleOrEmpty<\n  Options['credentials'],\n  {\n    credentials: DidCommCredentialsModule<\n      Options['credentials'] extends DidCommCredentialsModuleConfigOptions<DidCommCredentialProtocol[]>\n        ? Options['credentials']['credentialProtocols']\n        : DefaultDidCommCredentialProtocols\n    >\n  }\n> &\n  ModuleOrEmpty<\n    Options['proofs'],\n    {\n      proofs: DidCommProofsModule<\n        Options['proofs'] extends DidCommProofsModuleConfigOptions<DidCommProofProtocol[]>\n          ? Options['proofs']['proofProtocols']\n          : DefaultDidCommProofProtocols\n      >\n    }\n  > &\n  ModuleOrEmpty<\n    Options['messagePickup'],\n    {\n      messagePickup: DidCommMessagePickupModule<\n        Options['messagePickup'] extends DidCommMessagePickupModuleConfigOptions<DidCommMessagePickupProtocol[]>\n          ? Options['messagePickup']['protocols']\n          : DefaultDidCommMessagePickupProtocols\n      >\n    }\n  > &\n  ModuleOrEmpty<Options['mediator'], { mediator: DidCommMediatorModule }> &\n  ModuleOrEmpty<Options['mediationRecipient'], { mediationRecipient: DidCommMediationRecipientModule }> &\n  ModuleOrEmpty<Options['basicMessages'], { basicMessages: DidCommBasicMessagesModule }>\n\nfunction getDidcommModules<Options extends DidCommModuleConfigOptions>(options: Options): DidCommModules<Options> {\n  return Object.fromEntries(\n    Object.entries({\n      connections: new DidCommConnectionsModule(options.connections),\n      oob: new DidCommOutOfBandModule(),\n      discovery: new DidCommDiscoverFeaturesModule(options.discovery),\n\n      credentials:\n        options.credentials !== false\n          ? new DidCommCredentialsModule(options.credentials === true ? {} : options.credentials)\n          : undefined,\n\n      proofs:\n        options.proofs !== false ? new DidCommProofsModule(options.proofs === true ? {} : options.proofs) : undefined,\n\n      mediator:\n        options.mediator !== false\n          ? new DidCommMediatorModule(options.mediator === true ? {} : options.mediator)\n          : undefined,\n\n      mediationRecipient:\n        options.mediationRecipient !== false\n          ? new DidCommMediationRecipientModule(options.mediationRecipient === true ? {} : options.mediationRecipient)\n          : undefined,\n\n      messagePickup:\n        options.messagePickup !== false\n          ? new DidCommMessagePickupModule(options.messagePickup === true ? {} : options.messagePickup)\n          : undefined,\n\n      basicMessages: options.basicMessages !== false ? new DidCommBasicMessagesModule() : undefined,\n    }).filter(([, moduleValue]) => moduleValue !== undefined)\n  ) as unknown as DidCommModules<Options>\n}\n\nexport class DidCommModule<Options extends DidCommModuleConfigOptions = DidCommModuleConfigOptions> implements Module {\n  public readonly config: DidCommModuleConfig<Options>\n  public readonly api: typeof DidCommApi<Options> = DidCommApi\n\n  public readonly modules: ReturnType<typeof getDidcommModules<Options>>\n\n  public constructor(config?: Options) {\n    this.config = new DidCommModuleConfig<Options>(config)\n    this.modules = getDidcommModules(config ?? {})\n  }\n\n  /**\n   * Registers the dependencies of the question answer module on the dependency manager.\n   */\n  public register(dependencyManager: DependencyManager) {\n    // Config\n    dependencyManager.registerInstance(DidCommModuleConfig, this.config)\n\n    // Registries\n    dependencyManager.registerSingleton(DidCommMessageHandlerRegistry)\n    dependencyManager.registerSingleton(DidCommFeatureRegistry)\n\n    // Services\n    dependencyManager.registerSingleton(DidCommMessageSender)\n    dependencyManager.registerSingleton(DidCommMessageReceiver)\n    dependencyManager.registerSingleton(DidCommTransportService)\n    dependencyManager.registerSingleton(DidCommDispatcher)\n    dependencyManager.registerSingleton(DidCommEnvelopeService)\n\n    // Repositories\n    dependencyManager.registerSingleton(DidCommMessageRepository)\n\n    for (const [_moduleKey, module] of Object.entries(this.modules)) {\n      module.register(dependencyManager)\n\n      if (module.api) {\n        dependencyManager.registerContextScoped(module.api as Constructor<unknown>)\n      }\n    }\n  }\n\n  public async initialize(agentContext: AgentContext): Promise<void> {\n    const stop$ = agentContext.dependencyManager.resolve<Subject<boolean>>(InjectionSymbols.Stop$)\n    const eventEmitter = agentContext.dependencyManager.resolve(EventEmitter)\n    const messageReceiver = agentContext.dependencyManager.resolve(DidCommMessageReceiver)\n\n    // Listen for new messages (either from transports or somewhere else in the framework / extensions)\n    // We create this before doing any other initialization, so the initialization could already receive messages\n    eventEmitter\n      .observable<DidCommMessageReceivedEvent>(DidCommEventTypes.DidCommMessageReceived)\n      .pipe(\n        takeUntil(stop$),\n        mergeMap(\n          (e) =>\n            messageReceiver\n              .receiveMessage(e.payload.message, {\n                connection: e.payload.connection,\n                contextCorrelationId: e.payload.contextCorrelationId,\n                session: e.payload.session,\n                receivedAt: e.payload.receivedAt,\n              })\n              .catch((error) => {\n                agentContext.config.logger.error('Failed to process message', { error })\n              }),\n          this.config.processDidCommMessagesConcurrently ? undefined : 1\n        )\n      )\n      .subscribe()\n\n    for (const transport of this.config.inboundTransports) {\n      await transport.start(agentContext)\n    }\n\n    for (const transport of this.config.outboundTransports) {\n      await transport.start(agentContext)\n    }\n\n    for (const module of Object.values(this.modules)) {\n      await module.initialize?.(agentContext)\n    }\n  }\n\n  public async onInitializeContext(agentContext: AgentContext): Promise<void> {\n    for (const module of Object.values(this.modules)) {\n      const standardModule = module as Module\n      await standardModule.onInitializeContext?.(agentContext)\n    }\n  }\n\n  public async onCloseContext(agentContext: AgentContext): Promise<void> {\n    for (const module of Object.values(this.modules)) {\n      const standardModule = module as Module\n      await standardModule.onCloseContext?.(agentContext)\n    }\n  }\n\n  public async onDeleteContext(agentContext: AgentContext): Promise<void> {\n    for (const module of Object.values(this.modules)) {\n      const standardModule = module as Module\n      await standardModule.onDeleteContext?.(agentContext)\n    }\n  }\n\n  public async onProvisionContext(agentContext: AgentContext): Promise<void> {\n    for (const module of Object.values(this.modules)) {\n      const standardModule = module as Module\n      await standardModule.onProvisionContext?.(agentContext)\n    }\n  }\n\n  public async shutdown(agentContext: AgentContext) {\n    // Stop transports\n    const allTransports = [...this.config.inboundTransports, ...this.config.outboundTransports]\n    const transportPromises = allTransports.map((transport) => transport.stop())\n    await Promise.all(transportPromises)\n\n    for (const module of Object.values(this.modules)) {\n      const standardModule = module as Module\n      await standardModule.shutdown?.(agentContext)\n    }\n  }\n\n  public get updates() {\n    return [\n      {\n        fromVersion: '0.1',\n        toVersion: '0.2',\n        doUpdate: updateV0_1ToV0_2,\n      },\n      {\n        fromVersion: '0.2',\n        toVersion: '0.3',\n        doUpdate: updateV0_2ToV0_3,\n      },\n      {\n        fromVersion: '0.4',\n        toVersion: '0.5',\n        doUpdate: updateV0_4ToV0_5,\n      },\n    ] satisfies Update[]\n  }\n}\n"],"mappings":"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"}