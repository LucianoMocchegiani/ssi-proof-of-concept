{"version":3,"file":"DidCommCredentialFormatCoordinator.mjs","names":[],"sources":["../../../../../src/modules/credentials/protocol/v2/DidCommCredentialFormatCoordinator.ts"],"sourcesContent":["import type { AgentContext } from '@credo-ts/core'\nimport { CredoError } from '@credo-ts/core'\nimport type { DidCommAttachment } from '../../../../decorators/attachment/DidCommAttachment'\nimport { DidCommMessageRepository, DidCommMessageRole } from '../../../../repository'\nimport type {\n  DidCommCredentialFormatPayload,\n  DidCommCredentialFormatService,\n  ExtractCredentialFormats,\n} from '../../formats'\nimport type { DidCommCredentialFormatSpec } from '../../models'\nimport type { DidCommCredentialExchangeRecord } from '../../repository/DidCommCredentialExchangeRecord'\n\nimport {\n  DidCommCredentialV2Preview,\n  DidCommIssueCredentialV2Message,\n  DidCommOfferCredentialV2Message,\n  DidCommProposeCredentialV2Message,\n  DidCommRequestCredentialV2Message,\n} from './messages'\n\nexport class DidCommCredentialFormatCoordinator<CFs extends DidCommCredentialFormatService[]> {\n  /**\n   * Create a {@link DidCommProposeCredentialV2Message}.\n   *\n   * @param options\n   * @returns The created {@link DidCommProposeCredentialV2Message}\n   *\n   */\n  public async createProposal(\n    agentContext: AgentContext,\n    {\n      credentialFormats,\n      formatServices,\n      credentialExchangeRecord,\n      comment,\n      goalCode,\n      goal,\n    }: {\n      formatServices: DidCommCredentialFormatService[]\n      credentialFormats: DidCommCredentialFormatPayload<ExtractCredentialFormats<CFs>, 'createProposal'>\n      credentialExchangeRecord: DidCommCredentialExchangeRecord\n      comment?: string\n      goalCode?: string\n      goal?: string\n    }\n  ): Promise<DidCommProposeCredentialV2Message> {\n    const didCommMessageRepository = agentContext.dependencyManager.resolve(DidCommMessageRepository)\n\n    // create message. there are two arrays in each message, one for formats the other for attachments\n    const formats: DidCommCredentialFormatSpec[] = []\n    const proposalAttachments: DidCommAttachment[] = []\n    let credentialPreview: DidCommCredentialV2Preview | undefined\n\n    for (const formatService of formatServices) {\n      const { format, attachment, previewAttributes } = await formatService.createProposal(agentContext, {\n        credentialFormats,\n        credentialExchangeRecord,\n      })\n\n      if (previewAttributes) {\n        credentialPreview = new DidCommCredentialV2Preview({\n          attributes: previewAttributes,\n        })\n      }\n\n      proposalAttachments.push(attachment)\n      formats.push(format)\n    }\n\n    credentialExchangeRecord.credentialAttributes = credentialPreview?.attributes\n\n    const message = new DidCommProposeCredentialV2Message({\n      id: credentialExchangeRecord.threadId,\n      formats,\n      proposalAttachments,\n      comment,\n      credentialPreview,\n      goalCode,\n      goal,\n    })\n\n    message.setThread({\n      threadId: credentialExchangeRecord.threadId,\n      parentThreadId: credentialExchangeRecord.parentThreadId,\n    })\n\n    await didCommMessageRepository.saveOrUpdateAgentMessage(agentContext, {\n      agentMessage: message,\n      role: DidCommMessageRole.Sender,\n      associatedRecordId: credentialExchangeRecord.id,\n    })\n\n    return message\n  }\n\n  public async processProposal(\n    agentContext: AgentContext,\n    {\n      credentialExchangeRecord,\n      message,\n      formatServices,\n    }: {\n      credentialExchangeRecord: DidCommCredentialExchangeRecord\n      message: DidCommProposeCredentialV2Message\n      formatServices: DidCommCredentialFormatService[]\n    }\n  ) {\n    const didCommMessageRepository = agentContext.dependencyManager.resolve(DidCommMessageRepository)\n\n    for (const formatService of formatServices) {\n      const attachment = this.getAttachmentForService(formatService, message.formats, message.proposalAttachments)\n\n      await formatService.processProposal(agentContext, {\n        attachment,\n        credentialExchangeRecord,\n      })\n    }\n\n    await didCommMessageRepository.saveOrUpdateAgentMessage(agentContext, {\n      agentMessage: message,\n      role: DidCommMessageRole.Receiver,\n      associatedRecordId: credentialExchangeRecord.id,\n    })\n  }\n\n  public async acceptProposal(\n    agentContext: AgentContext,\n    {\n      credentialExchangeRecord,\n      credentialFormats,\n      formatServices,\n      comment,\n      goalCode,\n      goal,\n    }: {\n      credentialExchangeRecord: DidCommCredentialExchangeRecord\n      credentialFormats?: DidCommCredentialFormatPayload<ExtractCredentialFormats<CFs>, 'acceptProposal'>\n      formatServices: DidCommCredentialFormatService[]\n      comment?: string\n      goalCode?: string\n      goal?: string\n    }\n  ) {\n    const didCommMessageRepository = agentContext.dependencyManager.resolve(DidCommMessageRepository)\n\n    // create message. there are two arrays in each message, one for formats the other for attachments\n    const formats: DidCommCredentialFormatSpec[] = []\n    const offerAttachments: DidCommAttachment[] = []\n    let credentialPreview: DidCommCredentialV2Preview | undefined\n\n    const proposalMessage = await didCommMessageRepository.getAgentMessage(agentContext, {\n      associatedRecordId: credentialExchangeRecord.id,\n      messageClass: DidCommProposeCredentialV2Message,\n      role: DidCommMessageRole.Receiver,\n    })\n\n    // NOTE: We set the credential attributes from the proposal on the record as we've 'accepted' them\n    // and can now use them to create the offer in the format services. It may be overwritten later on\n    // if the user provided other attributes in the credentialFormats array.\n    credentialExchangeRecord.credentialAttributes = proposalMessage.credentialPreview?.attributes\n\n    for (const formatService of formatServices) {\n      const proposalAttachment = this.getAttachmentForService(\n        formatService,\n        proposalMessage.formats,\n        proposalMessage.proposalAttachments\n      )\n\n      const { attachment, format, previewAttributes } = await formatService.acceptProposal(agentContext, {\n        credentialExchangeRecord,\n        credentialFormats,\n        proposalAttachment,\n      })\n\n      if (previewAttributes) {\n        credentialPreview = new DidCommCredentialV2Preview({\n          attributes: previewAttributes,\n        })\n      }\n\n      offerAttachments.push(attachment)\n      formats.push(format)\n    }\n\n    credentialExchangeRecord.credentialAttributes = credentialPreview?.attributes\n\n    if (!credentialPreview) {\n      // If no preview attributes were provided, use a blank preview. Not all formats use this object\n      // but it is required by the protocol\n      credentialPreview = new DidCommCredentialV2Preview({\n        attributes: [],\n      })\n    }\n\n    const message = new DidCommOfferCredentialV2Message({\n      formats,\n      credentialPreview,\n      offerAttachments,\n      comment,\n      goalCode,\n      goal,\n    })\n\n    message.setThread({\n      threadId: credentialExchangeRecord.threadId,\n      parentThreadId: credentialExchangeRecord.parentThreadId,\n    })\n\n    await didCommMessageRepository.saveOrUpdateAgentMessage(agentContext, {\n      agentMessage: message,\n      associatedRecordId: credentialExchangeRecord.id,\n      role: DidCommMessageRole.Sender,\n    })\n\n    return message\n  }\n\n  /**\n   * Create a {@link DidCommOfferCredentialV2Message}.\n   *\n   * @param options\n   * @returns The created {@link DidCommOfferCredentialV2Message}\n   *\n   */\n  public async createOffer(\n    agentContext: AgentContext,\n    {\n      credentialFormats,\n      formatServices,\n      credentialExchangeRecord,\n      comment,\n      goalCode,\n      goal,\n    }: {\n      formatServices: DidCommCredentialFormatService[]\n      credentialFormats: DidCommCredentialFormatPayload<ExtractCredentialFormats<CFs>, 'createOffer'>\n      credentialExchangeRecord: DidCommCredentialExchangeRecord\n      comment?: string\n      goalCode?: string\n      goal?: string\n    }\n  ): Promise<DidCommOfferCredentialV2Message> {\n    const didCommMessageRepository = agentContext.dependencyManager.resolve(DidCommMessageRepository)\n\n    // create message. there are two arrays in each message, one for formats the other for attachments\n    const formats: DidCommCredentialFormatSpec[] = []\n    const offerAttachments: DidCommAttachment[] = []\n    let credentialPreview: DidCommCredentialV2Preview | undefined\n\n    for (const formatService of formatServices) {\n      const { format, attachment, previewAttributes } = await formatService.createOffer(agentContext, {\n        credentialFormats,\n        credentialExchangeRecord,\n      })\n\n      if (previewAttributes) {\n        credentialPreview = new DidCommCredentialV2Preview({\n          attributes: previewAttributes,\n        })\n      }\n\n      offerAttachments.push(attachment)\n      formats.push(format)\n    }\n\n    credentialExchangeRecord.credentialAttributes = credentialPreview?.attributes\n\n    if (!credentialPreview) {\n      // If no preview attributes were provided, use a blank preview. Not all formats use this object\n      // but it is required by the protocol\n      credentialPreview = new DidCommCredentialV2Preview({\n        attributes: [],\n      })\n    }\n\n    const message = new DidCommOfferCredentialV2Message({\n      formats,\n      comment,\n      goalCode,\n      goal,\n      offerAttachments,\n      credentialPreview,\n    })\n\n    message.setThread({\n      threadId: credentialExchangeRecord.threadId,\n      parentThreadId: credentialExchangeRecord.parentThreadId,\n    })\n\n    await didCommMessageRepository.saveOrUpdateAgentMessage(agentContext, {\n      agentMessage: message,\n      role: DidCommMessageRole.Sender,\n      associatedRecordId: credentialExchangeRecord.id,\n    })\n\n    return message\n  }\n\n  public async processOffer(\n    agentContext: AgentContext,\n    {\n      credentialExchangeRecord,\n      message,\n      formatServices,\n    }: {\n      credentialExchangeRecord: DidCommCredentialExchangeRecord\n      message: DidCommOfferCredentialV2Message\n      formatServices: DidCommCredentialFormatService[]\n    }\n  ) {\n    const didCommMessageRepository = agentContext.dependencyManager.resolve(DidCommMessageRepository)\n\n    for (const formatService of formatServices) {\n      const attachment = this.getAttachmentForService(formatService, message.formats, message.offerAttachments)\n\n      await formatService.processOffer(agentContext, {\n        attachment,\n        credentialExchangeRecord,\n      })\n    }\n\n    await didCommMessageRepository.saveOrUpdateAgentMessage(agentContext, {\n      agentMessage: message,\n      role: DidCommMessageRole.Receiver,\n      associatedRecordId: credentialExchangeRecord.id,\n    })\n  }\n\n  public async acceptOffer(\n    agentContext: AgentContext,\n    {\n      credentialExchangeRecord,\n      credentialFormats,\n      formatServices,\n      comment,\n      goalCode,\n      goal,\n    }: {\n      credentialExchangeRecord: DidCommCredentialExchangeRecord\n      credentialFormats?: DidCommCredentialFormatPayload<ExtractCredentialFormats<CFs>, 'acceptOffer'>\n      formatServices: DidCommCredentialFormatService[]\n      comment?: string\n      goalCode?: string\n      goal?: string\n    }\n  ) {\n    const didCommMessageRepository = agentContext.dependencyManager.resolve(DidCommMessageRepository)\n\n    const offerMessage = await didCommMessageRepository.getAgentMessage(agentContext, {\n      associatedRecordId: credentialExchangeRecord.id,\n      messageClass: DidCommOfferCredentialV2Message,\n      role: DidCommMessageRole.Receiver,\n    })\n\n    // create message. there are two arrays in each message, one for formats the other for attachments\n    const formats: DidCommCredentialFormatSpec[] = []\n    const requestAttachments: DidCommAttachment[] = []\n    const requestAppendAttachments: DidCommAttachment[] = []\n\n    for (const formatService of formatServices) {\n      const offerAttachment = this.getAttachmentForService(\n        formatService,\n        offerMessage.formats,\n        offerMessage.offerAttachments\n      )\n\n      const { attachment, format, appendAttachments } = await formatService.acceptOffer(agentContext, {\n        offerAttachment,\n        credentialExchangeRecord,\n        credentialFormats,\n      })\n\n      requestAttachments.push(attachment)\n      formats.push(format)\n      if (appendAttachments) requestAppendAttachments.push(...appendAttachments)\n    }\n\n    credentialExchangeRecord.credentialAttributes = offerMessage.credentialPreview?.attributes\n\n    const message = new DidCommRequestCredentialV2Message({\n      formats,\n      attachments: requestAppendAttachments,\n      requestAttachments: requestAttachments,\n      comment,\n      goalCode,\n      goal,\n    })\n\n    message.setThread({\n      threadId: credentialExchangeRecord.threadId,\n      parentThreadId: credentialExchangeRecord.parentThreadId,\n    })\n\n    await didCommMessageRepository.saveOrUpdateAgentMessage(agentContext, {\n      agentMessage: message,\n      associatedRecordId: credentialExchangeRecord.id,\n      role: DidCommMessageRole.Sender,\n    })\n\n    return message\n  }\n\n  /**\n   * Create a {@link DidCommRequestCredentialV2Message}.\n   *\n   * @param options\n   * @returns The created {@link DidCommRequestCredentialV2Message}\n   *\n   */\n  public async createRequest(\n    agentContext: AgentContext,\n    {\n      credentialFormats,\n      formatServices,\n      credentialExchangeRecord,\n      comment,\n      goalCode,\n      goal,\n    }: {\n      formatServices: DidCommCredentialFormatService[]\n      credentialFormats: DidCommCredentialFormatPayload<ExtractCredentialFormats<CFs>, 'createRequest'>\n      credentialExchangeRecord: DidCommCredentialExchangeRecord\n      comment?: string\n      goalCode?: string\n      goal?: string\n    }\n  ): Promise<DidCommRequestCredentialV2Message> {\n    const didCommMessageRepository = agentContext.dependencyManager.resolve(DidCommMessageRepository)\n\n    // create message. there are two arrays in each message, one for formats the other for attachments\n    const formats: DidCommCredentialFormatSpec[] = []\n    const requestAttachments: DidCommAttachment[] = []\n\n    for (const formatService of formatServices) {\n      const { format, attachment } = await formatService.createRequest(agentContext, {\n        credentialFormats,\n        credentialExchangeRecord,\n      })\n\n      requestAttachments.push(attachment)\n      formats.push(format)\n    }\n\n    const message = new DidCommRequestCredentialV2Message({\n      formats,\n      comment,\n      goalCode,\n      goal,\n      requestAttachments: requestAttachments,\n    })\n\n    message.setThread({\n      threadId: credentialExchangeRecord.threadId,\n      parentThreadId: credentialExchangeRecord.parentThreadId,\n    })\n\n    await didCommMessageRepository.saveOrUpdateAgentMessage(agentContext, {\n      agentMessage: message,\n      role: DidCommMessageRole.Sender,\n      associatedRecordId: credentialExchangeRecord.id,\n    })\n\n    return message\n  }\n\n  public async processRequest(\n    agentContext: AgentContext,\n    {\n      credentialExchangeRecord,\n      message,\n      formatServices,\n    }: {\n      credentialExchangeRecord: DidCommCredentialExchangeRecord\n      message: DidCommRequestCredentialV2Message\n      formatServices: DidCommCredentialFormatService[]\n    }\n  ) {\n    const didCommMessageRepository = agentContext.dependencyManager.resolve(DidCommMessageRepository)\n\n    for (const formatService of formatServices) {\n      const attachment = this.getAttachmentForService(formatService, message.formats, message.requestAttachments)\n\n      await formatService.processRequest(agentContext, {\n        attachment,\n        credentialExchangeRecord,\n      })\n    }\n\n    await didCommMessageRepository.saveOrUpdateAgentMessage(agentContext, {\n      agentMessage: message,\n      role: DidCommMessageRole.Receiver,\n      associatedRecordId: credentialExchangeRecord.id,\n    })\n  }\n\n  public async acceptRequest(\n    agentContext: AgentContext,\n    {\n      credentialExchangeRecord,\n      credentialFormats,\n      formatServices,\n      comment,\n      goalCode,\n      goal,\n    }: {\n      credentialExchangeRecord: DidCommCredentialExchangeRecord\n      credentialFormats?: DidCommCredentialFormatPayload<ExtractCredentialFormats<CFs>, 'acceptRequest'>\n      formatServices: DidCommCredentialFormatService[]\n      comment?: string\n      goalCode?: string\n      goal?: string\n    }\n  ) {\n    const didCommMessageRepository = agentContext.dependencyManager.resolve(DidCommMessageRepository)\n\n    const requestMessage = await didCommMessageRepository.getAgentMessage(agentContext, {\n      associatedRecordId: credentialExchangeRecord.id,\n      messageClass: DidCommRequestCredentialV2Message,\n      role: DidCommMessageRole.Receiver,\n    })\n\n    const offerMessage = await didCommMessageRepository.findAgentMessage(agentContext, {\n      associatedRecordId: credentialExchangeRecord.id,\n      messageClass: DidCommOfferCredentialV2Message,\n      role: DidCommMessageRole.Sender,\n    })\n\n    // create message. there are two arrays in each message, one for formats the other for attachments\n    const formats: DidCommCredentialFormatSpec[] = []\n    const credentialAttachments: DidCommAttachment[] = []\n\n    for (const formatService of formatServices) {\n      const requestAttachment = this.getAttachmentForService(\n        formatService,\n        requestMessage.formats,\n        requestMessage.requestAttachments\n      )\n\n      const offerAttachment = offerMessage\n        ? this.getAttachmentForService(formatService, offerMessage.formats, offerMessage.offerAttachments)\n        : undefined\n\n      const { attachment, format } = await formatService.acceptRequest(agentContext, {\n        requestAttachment,\n        offerAttachment,\n        credentialExchangeRecord,\n        credentialFormats,\n        requestAppendAttachments: requestMessage.appendedAttachments,\n      })\n\n      credentialAttachments.push(attachment)\n      formats.push(format)\n    }\n\n    const message = new DidCommIssueCredentialV2Message({\n      formats,\n      credentialAttachments: credentialAttachments,\n      comment,\n      goalCode,\n      goal,\n    })\n\n    message.setThread({\n      threadId: credentialExchangeRecord.threadId,\n      parentThreadId: credentialExchangeRecord.parentThreadId,\n    })\n    message.setPleaseAck()\n\n    await didCommMessageRepository.saveOrUpdateAgentMessage(agentContext, {\n      agentMessage: message,\n      associatedRecordId: credentialExchangeRecord.id,\n      role: DidCommMessageRole.Sender,\n    })\n\n    return message\n  }\n\n  public async processCredential(\n    agentContext: AgentContext,\n    {\n      credentialExchangeRecord,\n      message,\n      requestMessage,\n      formatServices,\n    }: {\n      credentialExchangeRecord: DidCommCredentialExchangeRecord\n      message: DidCommIssueCredentialV2Message\n      requestMessage: DidCommRequestCredentialV2Message\n      formatServices: DidCommCredentialFormatService[]\n    }\n  ) {\n    const didCommMessageRepository = agentContext.dependencyManager.resolve(DidCommMessageRepository)\n\n    const offerMessage = await didCommMessageRepository.getAgentMessage(agentContext, {\n      associatedRecordId: credentialExchangeRecord.id,\n      messageClass: DidCommOfferCredentialV2Message,\n      role: DidCommMessageRole.Receiver,\n    })\n\n    for (const formatService of formatServices) {\n      const offerAttachment = this.getAttachmentForService(\n        formatService,\n        offerMessage.formats,\n        offerMessage.offerAttachments\n      )\n\n      const attachment = this.getAttachmentForService(formatService, message.formats, message.credentialAttachments)\n      const requestAttachment = this.getAttachmentForService(\n        formatService,\n        requestMessage.formats,\n        requestMessage.requestAttachments\n      )\n\n      await formatService.processCredential(agentContext, {\n        attachment,\n        offerAttachment,\n        requestAttachment,\n        credentialExchangeRecord,\n        requestAppendAttachments: requestMessage.appendedAttachments,\n      })\n    }\n\n    await didCommMessageRepository.saveOrUpdateAgentMessage(agentContext, {\n      agentMessage: message,\n      role: DidCommMessageRole.Receiver,\n      associatedRecordId: credentialExchangeRecord.id,\n    })\n  }\n\n  public getAttachmentForService(\n    credentialFormatService: DidCommCredentialFormatService,\n    formats: DidCommCredentialFormatSpec[],\n    attachments: DidCommAttachment[]\n  ) {\n    const attachmentId = this.getAttachmentIdForService(credentialFormatService, formats)\n    const attachment = attachments.find((attachment) => attachment.id === attachmentId)\n\n    if (!attachment) {\n      throw new CredoError(`DidCommAttachment with id ${attachmentId} not found in attachments.`)\n    }\n\n    return attachment\n  }\n\n  private getAttachmentIdForService(\n    credentialFormatService: DidCommCredentialFormatService,\n    formats: DidCommCredentialFormatSpec[]\n  ) {\n    const format = formats.find((format) => credentialFormatService.supportsFormat(format.format))\n\n    if (!format) throw new CredoError(`No attachment found for service ${credentialFormatService.formatKey}`)\n\n    return format.attachmentId\n  }\n}\n"],"mappings":"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"}