{"version":3,"file":"DidCommIssueCredentialV2Handler.mjs","names":[],"sources":["../../../../../../src/modules/credentials/protocol/v2/handlers/DidCommIssueCredentialV2Handler.ts"],"sourcesContent":["import { CredoError } from '@credo-ts/core'\nimport { getOutboundDidCommMessageContext } from '../../../../../getDidCommOutboundMessageContext'\nimport type { DidCommMessageHandler, DidCommMessageHandlerInboundMessage } from '../../../../../handlers'\nimport type { DidCommInboundMessageContext } from '../../../../../models'\nimport type { DidCommCredentialExchangeRecord } from '../../../repository/DidCommCredentialExchangeRecord'\nimport type { DidCommCredentialV2Protocol } from '../DidCommCredentialV2Protocol'\nimport { DidCommIssueCredentialV2Message } from '../messages/DidCommIssueCredentialV2Message'\n\nexport class DidCommIssueCredentialV2Handler implements DidCommMessageHandler {\n  private credentialProtocol: DidCommCredentialV2Protocol\n  public supportedMessages = [DidCommIssueCredentialV2Message]\n\n  public constructor(credentialProtocol: DidCommCredentialV2Protocol) {\n    this.credentialProtocol = credentialProtocol\n  }\n\n  public async handle(messageContext: DidCommInboundMessageContext<DidCommIssueCredentialV2Message>) {\n    const credentialExchangeRecord = await this.credentialProtocol.processCredential(messageContext)\n\n    const shouldAutoRespond = await this.credentialProtocol.shouldAutoRespondToCredential(messageContext.agentContext, {\n      credentialExchangeRecord,\n      credentialMessage: messageContext.message,\n    })\n\n    if (shouldAutoRespond) {\n      return await this.acceptCredential(credentialExchangeRecord, messageContext)\n    }\n  }\n\n  private async acceptCredential(\n    credentialExchangeRecord: DidCommCredentialExchangeRecord,\n    messageContext: DidCommMessageHandlerInboundMessage<DidCommIssueCredentialV2Handler>\n  ) {\n    messageContext.agentContext.config.logger.info('Automatically sending acknowledgement with autoAccept')\n    const { message } = await this.credentialProtocol.acceptCredential(messageContext.agentContext, {\n      credentialExchangeRecord,\n    })\n\n    const requestMessage = await this.credentialProtocol.findRequestMessage(\n      messageContext.agentContext,\n      credentialExchangeRecord.id\n    )\n    if (!requestMessage) {\n      throw new CredoError(`No request message found for credential record with id '${credentialExchangeRecord.id}'`)\n    }\n\n    return getOutboundDidCommMessageContext(messageContext.agentContext, {\n      connectionRecord: messageContext.connection,\n      message,\n      associatedRecord: credentialExchangeRecord,\n      lastReceivedMessage: messageContext.message,\n      lastSentMessage: requestMessage,\n    })\n  }\n}\n"],"mappings":";;;;;AAQA,IAAa,kCAAb,MAA8E;CAI5E,AAAO,YAAY,oBAAiD;OAF7D,oBAAoB,CAAC,gCAAgC;AAG1D,OAAK,qBAAqB;;CAG5B,MAAa,OAAO,gBAA+E;EACjG,MAAM,2BAA2B,MAAM,KAAK,mBAAmB,kBAAkB,eAAe;AAOhG,MAL0B,MAAM,KAAK,mBAAmB,8BAA8B,eAAe,cAAc;GACjH;GACA,mBAAmB,eAAe;GACnC,CAAC,CAGA,QAAO,MAAM,KAAK,iBAAiB,0BAA0B,eAAe;;CAIhF,MAAc,iBACZ,0BACA,gBACA;AACA,iBAAe,aAAa,OAAO,OAAO,KAAK,wDAAwD;EACvG,MAAM,EAAE,YAAY,MAAM,KAAK,mBAAmB,iBAAiB,eAAe,cAAc,EAC9F,0BACD,CAAC;EAEF,MAAM,iBAAiB,MAAM,KAAK,mBAAmB,mBACnD,eAAe,cACf,yBAAyB,GAC1B;AACD,MAAI,CAAC,eACH,OAAM,IAAI,WAAW,2DAA2D,yBAAyB,GAAG,GAAG;AAGjH,SAAO,iCAAiC,eAAe,cAAc;GACnE,kBAAkB,eAAe;GACjC;GACA,kBAAkB;GAClB,qBAAqB,eAAe;GACpC,iBAAiB;GAClB,CAAC"}