{"version":3,"file":"DidCommBaseCredentialProtocol.mjs","names":[],"sources":["../../../../src/modules/credentials/protocol/DidCommBaseCredentialProtocol.ts"],"sourcesContent":["import type { AgentContext, Query, QueryOptions } from '@credo-ts/core'\nimport { EventEmitter } from '@credo-ts/core'\nimport type { DidCommFeatureRegistry } from '../../../DidCommFeatureRegistry'\nimport type { DidCommMessage } from '../../../DidCommMessage'\nimport type { DidCommMessageHandlerRegistry } from '../../../DidCommMessageHandlerRegistry'\nimport type { DidCommProblemReportMessage } from '../../../messages'\nimport type { DidCommInboundMessageContext } from '../../../models'\nimport { DidCommMessageRepository } from '../../../repository'\nimport { DidCommConnectionService } from '../../connections'\nimport type { DidCommCredentialStateChangedEvent } from '../DidCommCredentialEvents'\nimport { DidCommCredentialEventTypes } from '../DidCommCredentialEvents'\nimport type { DidCommCredentialFormatService, ExtractCredentialFormats } from '../formats'\nimport type { DidCommCredentialRole } from '../models'\nimport { DidCommCredentialState } from '../models/DidCommCredentialState'\nimport type { DidCommCredentialExchangeRecord } from '../repository'\nimport { DidCommCredentialExchangeRepository } from '../repository'\nimport type { DidCommCredentialProtocol } from './DidCommCredentialProtocol'\nimport type {\n  AcceptCredentialOfferOptions,\n  AcceptCredentialOptions,\n  AcceptCredentialProposalOptions,\n  AcceptCredentialRequestOptions,\n  CreateCredentialOfferOptions,\n  CreateCredentialProblemReportOptions,\n  CreateCredentialProposalOptions,\n  CreateCredentialRequestOptions,\n  CredentialProtocolMsgReturnType,\n  DeleteCredentialOptions,\n  GetCredentialFormatDataReturn,\n  NegotiateCredentialOfferOptions,\n  NegotiateCredentialProposalOptions,\n} from './DidCommCredentialProtocolOptions'\n\n/**\n * Base implementation of the DidCommCredentialProtocol that can be used as a foundation for implementing\n * the DidCommCredentialProtocol interface.\n */\nexport abstract class DidCommBaseCredentialProtocol<\n  CFs extends DidCommCredentialFormatService[] = DidCommCredentialFormatService[],\n> implements DidCommCredentialProtocol<CFs>\n{\n  public abstract readonly version: string\n\n  protected abstract getFormatServiceForRecordType(credentialRecordType: string): CFs[number]\n\n  // methods for proposal\n  public abstract createProposal(\n    agentContext: AgentContext,\n    options: CreateCredentialProposalOptions<CFs>\n  ): Promise<CredentialProtocolMsgReturnType<DidCommMessage>>\n  public abstract processProposal(\n    messageContext: DidCommInboundMessageContext<DidCommMessage>\n  ): Promise<DidCommCredentialExchangeRecord>\n  public abstract acceptProposal(\n    agentContext: AgentContext,\n    options: AcceptCredentialProposalOptions<CFs>\n  ): Promise<CredentialProtocolMsgReturnType<DidCommMessage>>\n  public abstract negotiateProposal(\n    agentContext: AgentContext,\n    options: NegotiateCredentialProposalOptions<CFs>\n  ): Promise<CredentialProtocolMsgReturnType<DidCommMessage>>\n\n  // methods for offer\n  public abstract createOffer(\n    agentContext: AgentContext,\n    options: CreateCredentialOfferOptions<CFs>\n  ): Promise<CredentialProtocolMsgReturnType<DidCommMessage>>\n  public abstract processOffer(\n    messageContext: DidCommInboundMessageContext<DidCommMessage>\n  ): Promise<DidCommCredentialExchangeRecord>\n  public abstract acceptOffer(\n    agentContext: AgentContext,\n    options: AcceptCredentialOfferOptions<CFs>\n  ): Promise<CredentialProtocolMsgReturnType<DidCommMessage>>\n  public abstract negotiateOffer(\n    agentContext: AgentContext,\n    options: NegotiateCredentialOfferOptions<CFs>\n  ): Promise<CredentialProtocolMsgReturnType<DidCommMessage>>\n\n  // methods for request\n  public abstract createRequest(\n    agentContext: AgentContext,\n    options: CreateCredentialRequestOptions<CFs>\n  ): Promise<CredentialProtocolMsgReturnType<DidCommMessage>>\n  public abstract processRequest(\n    messageContext: DidCommInboundMessageContext<DidCommMessage>\n  ): Promise<DidCommCredentialExchangeRecord>\n  public abstract acceptRequest(\n    agentContext: AgentContext,\n    options: AcceptCredentialRequestOptions<CFs>\n  ): Promise<CredentialProtocolMsgReturnType<DidCommMessage>>\n\n  // methods for issue\n  public abstract processCredential(\n    messageContext: DidCommInboundMessageContext<DidCommMessage>\n  ): Promise<DidCommCredentialExchangeRecord>\n  public abstract acceptCredential(\n    agentContext: AgentContext,\n    options: AcceptCredentialOptions\n  ): Promise<CredentialProtocolMsgReturnType<DidCommMessage>>\n\n  // methods for ack\n  public abstract processAck(\n    messageContext: DidCommInboundMessageContext<DidCommMessage>\n  ): Promise<DidCommCredentialExchangeRecord>\n\n  // methods for problem-report\n  public abstract createProblemReport(\n    agentContext: AgentContext,\n    options: CreateCredentialProblemReportOptions\n  ): Promise<CredentialProtocolMsgReturnType<DidCommProblemReportMessage>>\n\n  public abstract findProposalMessage(\n    agentContext: AgentContext,\n    credentialExchangeId: string\n  ): Promise<DidCommMessage | null>\n  public abstract findOfferMessage(\n    agentContext: AgentContext,\n    credentialExchangeId: string\n  ): Promise<DidCommMessage | null>\n  public abstract findRequestMessage(\n    agentContext: AgentContext,\n    credentialExchangeId: string\n  ): Promise<DidCommMessage | null>\n  public abstract findCredentialMessage(\n    agentContext: AgentContext,\n    credentialExchangeId: string\n  ): Promise<DidCommMessage | null>\n  public abstract getFormatData(\n    agentContext: AgentContext,\n    credentialExchangeId: string\n  ): Promise<GetCredentialFormatDataReturn<ExtractCredentialFormats<CFs>>>\n\n  public abstract register(\n    messageHandlerRegistry: DidCommMessageHandlerRegistry,\n    featureRegistry: DidCommFeatureRegistry\n  ): void\n\n  /**\n   * Process a received credential {@link DidCommProblemReportMessage}.\n   *\n   * @param messageContext The message context containing a credential problem report message\n   * @returns credential record associated with the credential problem report message\n   */\n  public async processProblemReport(\n    messageContext: DidCommInboundMessageContext<DidCommProblemReportMessage>\n  ): Promise<DidCommCredentialExchangeRecord> {\n    const { message: credentialProblemReportMessage, agentContext, connection } = messageContext\n\n    const connectionService = agentContext.dependencyManager.resolve(DidCommConnectionService)\n\n    agentContext.config.logger.debug(`Processing problem report with message id ${credentialProblemReportMessage.id}`)\n\n    const credentialExchangeRecord = await this.getByProperties(agentContext, {\n      threadId: credentialProblemReportMessage.threadId,\n    })\n\n    // Assert\n    await connectionService.assertConnectionOrOutOfBandExchange(messageContext, {\n      expectedConnectionId: credentialExchangeRecord.connectionId,\n    })\n\n    //  This makes sure that the sender of the incoming message is authorized to do so.\n    if (!credentialExchangeRecord?.connectionId) {\n      await connectionService.matchIncomingMessageToRequestMessageInOutOfBandExchange(messageContext, {\n        expectedConnectionId: credentialExchangeRecord?.connectionId,\n      })\n\n      credentialExchangeRecord.connectionId = connection?.id\n    }\n\n    // Update record\n    credentialExchangeRecord.errorMessage = `${credentialProblemReportMessage.description.code}: ${credentialProblemReportMessage.description.en}`\n    await this.updateState(agentContext, credentialExchangeRecord, DidCommCredentialState.Abandoned)\n    return credentialExchangeRecord\n  }\n\n  /**\n   * Update the record to a new state and emit an state changed event. Also updates the record\n   * in storage.\n   *\n   * @param credentialExchangeRecord The credential record to update the state for\n   * @param newState The state to update to\n   *\n   */\n  public async updateState(\n    agentContext: AgentContext,\n    credentialExchangeRecord: DidCommCredentialExchangeRecord,\n    newState: DidCommCredentialState\n  ) {\n    const credentialRepository = agentContext.dependencyManager.resolve(DidCommCredentialExchangeRepository)\n\n    agentContext.config.logger.debug(\n      `Updating credential record ${credentialExchangeRecord.id} to state ${newState} (previous=${credentialExchangeRecord.state})`\n    )\n\n    const previousState = credentialExchangeRecord.state\n    credentialExchangeRecord.state = newState\n    await credentialRepository.update(agentContext, credentialExchangeRecord)\n\n    this.emitStateChangedEvent(agentContext, credentialExchangeRecord, previousState)\n  }\n\n  protected emitStateChangedEvent(\n    agentContext: AgentContext,\n    credentialExchangeRecord: DidCommCredentialExchangeRecord,\n    previousState: DidCommCredentialState | null\n  ) {\n    const eventEmitter = agentContext.dependencyManager.resolve(EventEmitter)\n\n    eventEmitter.emit<DidCommCredentialStateChangedEvent>(agentContext, {\n      type: DidCommCredentialEventTypes.DidCommCredentialStateChanged,\n      payload: {\n        credentialExchangeRecord: credentialExchangeRecord.clone(),\n        previousState: previousState,\n      },\n    })\n  }\n\n  /**\n   * Retrieve a credential record by id\n   *\n   * @param credentialRecordId The credential record id\n   * @throws {RecordNotFoundError} If no record is found\n   * @return The credential record\n   *\n   */\n  public getById(agentContext: AgentContext, credentialRecordId: string): Promise<DidCommCredentialExchangeRecord> {\n    const credentialRepository = agentContext.dependencyManager.resolve(DidCommCredentialExchangeRepository)\n\n    return credentialRepository.getById(agentContext, credentialRecordId)\n  }\n\n  /**\n   * Retrieve all credential records\n   *\n   * @returns List containing all credential records\n   */\n  public getAll(agentContext: AgentContext): Promise<DidCommCredentialExchangeRecord[]> {\n    const credentialRepository = agentContext.dependencyManager.resolve(DidCommCredentialExchangeRepository)\n\n    return credentialRepository.getAll(agentContext)\n  }\n\n  public async findAllByQuery(\n    agentContext: AgentContext,\n    query: Query<DidCommCredentialExchangeRecord>,\n    queryOptions?: QueryOptions\n  ): Promise<DidCommCredentialExchangeRecord[]> {\n    const credentialRepository = agentContext.dependencyManager.resolve(DidCommCredentialExchangeRepository)\n\n    return credentialRepository.findByQuery(agentContext, query, queryOptions)\n  }\n\n  /**\n   * Find a credential record by id\n   *\n   * @param credentialRecordId the credential record id\n   * @returns The credential record or null if not found\n   */\n  public findById(\n    agentContext: AgentContext,\n    proofExchangeRecordId: string\n  ): Promise<DidCommCredentialExchangeRecord | null> {\n    const credentialRepository = agentContext.dependencyManager.resolve(DidCommCredentialExchangeRepository)\n\n    return credentialRepository.findById(agentContext, proofExchangeRecordId)\n  }\n\n  public async delete(\n    agentContext: AgentContext,\n    credentialExchangeRecord: DidCommCredentialExchangeRecord,\n    options?: DeleteCredentialOptions\n  ): Promise<void> {\n    const credentialRepository = agentContext.dependencyManager.resolve(DidCommCredentialExchangeRepository)\n    const didCommMessageRepository = agentContext.dependencyManager.resolve(DidCommMessageRepository)\n\n    await credentialRepository.delete(agentContext, credentialExchangeRecord)\n\n    const deleteAssociatedCredentials = options?.deleteAssociatedCredentials ?? true\n    const deleteAssociatedDidCommMessages = options?.deleteAssociatedDidCommMessages ?? true\n\n    if (deleteAssociatedCredentials) {\n      for (const credential of credentialExchangeRecord.credentials) {\n        const formatService = this.getFormatServiceForRecordType(credential.credentialRecordType)\n        await formatService.deleteCredentialById(agentContext, credential.credentialRecordId)\n      }\n    }\n\n    if (deleteAssociatedDidCommMessages) {\n      const didCommMessages = await didCommMessageRepository.findByQuery(agentContext, {\n        associatedRecordId: credentialExchangeRecord.id,\n      })\n      for (const didCommMessage of didCommMessages) {\n        await didCommMessageRepository.delete(agentContext, didCommMessage)\n      }\n    }\n  }\n\n  /**\n   * Retrieve a credential record by connection id and thread id\n   *\n   * @param properties Properties to query by\n   *\n   * @throws {RecordNotFoundError} If no record is found\n   * @throws {RecordDuplicateError} If multiple records are found\n   * @returns The credential record\n   */\n  public getByProperties(\n    agentContext: AgentContext,\n    properties: {\n      threadId: string\n      role?: DidCommCredentialRole\n      connectionId?: string\n    }\n  ): Promise<DidCommCredentialExchangeRecord> {\n    const { role, connectionId, threadId } = properties\n    const credentialRepository = agentContext.dependencyManager.resolve(DidCommCredentialExchangeRepository)\n\n    return credentialRepository.getSingleByQuery(agentContext, {\n      connectionId,\n      threadId,\n      role,\n    })\n  }\n\n  /**\n   * Find a credential record by connection id and thread id, returns null if not found\n   *\n   * @param threadId The thread id\n   * @param role The role of the record, i.e. holder or issuer\n   * @param connectionId The connection id\n   *\n   * @returns The credential record\n   */\n  public findByProperties(\n    agentContext: AgentContext,\n    properties: {\n      threadId: string\n      role?: DidCommCredentialRole\n      connectionId?: string\n    }\n  ): Promise<DidCommCredentialExchangeRecord | null> {\n    const { role, connectionId, threadId } = properties\n    const credentialRepository = agentContext.dependencyManager.resolve(DidCommCredentialExchangeRepository)\n\n    return credentialRepository.findSingleByQuery(agentContext, {\n      connectionId,\n      threadId,\n      role,\n    })\n  }\n\n  public async update(agentContext: AgentContext, credentialExchangeRecord: DidCommCredentialExchangeRecord) {\n    const credentialRepository = agentContext.dependencyManager.resolve(DidCommCredentialExchangeRepository)\n\n    return await credentialRepository.update(agentContext, credentialExchangeRecord)\n  }\n}\n"],"mappings":"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"}