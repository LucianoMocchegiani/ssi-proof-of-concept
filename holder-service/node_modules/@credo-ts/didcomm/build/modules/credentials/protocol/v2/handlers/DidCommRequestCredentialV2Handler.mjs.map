{"version":3,"file":"DidCommRequestCredentialV2Handler.mjs","names":[],"sources":["../../../../../../src/modules/credentials/protocol/v2/handlers/DidCommRequestCredentialV2Handler.ts"],"sourcesContent":["import { CredoError } from '@credo-ts/core'\nimport { getOutboundDidCommMessageContext } from '../../../../../getDidCommOutboundMessageContext'\nimport type { DidCommMessageHandler } from '../../../../../handlers'\nimport type { DidCommInboundMessageContext } from '../../../../../models'\nimport type { DidCommCredentialExchangeRecord } from '../../../repository'\nimport type { DidCommCredentialV2Protocol } from '../DidCommCredentialV2Protocol'\nimport { DidCommRequestCredentialV2Message } from '../messages/DidCommRequestCredentialV2Message'\n\nexport class DidCommRequestCredentialV2Handler implements DidCommMessageHandler {\n  private credentialProtocol: DidCommCredentialV2Protocol\n\n  public supportedMessages = [DidCommRequestCredentialV2Message]\n\n  public constructor(credentialProtocol: DidCommCredentialV2Protocol) {\n    this.credentialProtocol = credentialProtocol\n  }\n\n  public async handle(messageContext: DidCommInboundMessageContext<DidCommRequestCredentialV2Message>) {\n    const credentialExchangeRecord = await this.credentialProtocol.processRequest(messageContext)\n\n    const shouldAutoRespond = await this.credentialProtocol.shouldAutoRespondToRequest(messageContext.agentContext, {\n      credentialExchangeRecord,\n      requestMessage: messageContext.message,\n    })\n\n    if (shouldAutoRespond) {\n      return await this.acceptRequest(credentialExchangeRecord, messageContext)\n    }\n  }\n\n  private async acceptRequest(\n    credentialExchangeRecord: DidCommCredentialExchangeRecord,\n    messageContext: DidCommInboundMessageContext<DidCommRequestCredentialV2Message>\n  ) {\n    messageContext.agentContext.config.logger.info('Automatically sending credential with autoAccept')\n\n    const offerMessage = await this.credentialProtocol.findOfferMessage(\n      messageContext.agentContext,\n      credentialExchangeRecord.id\n    )\n    if (!offerMessage) {\n      throw new CredoError(`Could not find offer message for credential record with id ${credentialExchangeRecord.id}`)\n    }\n\n    const { message } = await this.credentialProtocol.acceptRequest(messageContext.agentContext, {\n      credentialExchangeRecord,\n    })\n\n    return getOutboundDidCommMessageContext(messageContext.agentContext, {\n      connectionRecord: messageContext.connection,\n      message,\n      associatedRecord: credentialExchangeRecord,\n      lastReceivedMessage: messageContext.message,\n      lastSentMessage: offerMessage,\n    })\n  }\n}\n"],"mappings":";;;;;AAQA,IAAa,oCAAb,MAAgF;CAK9E,AAAO,YAAY,oBAAiD;OAF7D,oBAAoB,CAAC,kCAAkC;AAG5D,OAAK,qBAAqB;;CAG5B,MAAa,OAAO,gBAAiF;EACnG,MAAM,2BAA2B,MAAM,KAAK,mBAAmB,eAAe,eAAe;AAO7F,MAL0B,MAAM,KAAK,mBAAmB,2BAA2B,eAAe,cAAc;GAC9G;GACA,gBAAgB,eAAe;GAChC,CAAC,CAGA,QAAO,MAAM,KAAK,cAAc,0BAA0B,eAAe;;CAI7E,MAAc,cACZ,0BACA,gBACA;AACA,iBAAe,aAAa,OAAO,OAAO,KAAK,mDAAmD;EAElG,MAAM,eAAe,MAAM,KAAK,mBAAmB,iBACjD,eAAe,cACf,yBAAyB,GAC1B;AACD,MAAI,CAAC,aACH,OAAM,IAAI,WAAW,8DAA8D,yBAAyB,KAAK;EAGnH,MAAM,EAAE,YAAY,MAAM,KAAK,mBAAmB,cAAc,eAAe,cAAc,EAC3F,0BACD,CAAC;AAEF,SAAO,iCAAiC,eAAe,cAAc;GACnE,kBAAkB,eAAe;GACjC;GACA,kBAAkB;GAClB,qBAAqB,eAAe;GACpC,iBAAiB;GAClB,CAAC"}