{"version":3,"file":"DidCommCredentialsModule.mjs","names":[],"sources":["../../../src/modules/credentials/DidCommCredentialsModule.ts"],"sourcesContent":["import type { AgentContext, ApiModule, Constructor, DependencyManager, Optional } from '@credo-ts/core'\nimport { DidCommFeatureRegistry } from '../../DidCommFeatureRegistry'\nimport { DidCommMessageHandlerRegistry } from '../../DidCommMessageHandlerRegistry'\nimport { DidCommProtocol } from '../../models'\nimport { DidCommCredentialsApi } from './DidCommCredentialsApi'\nimport type { DidCommCredentialsModuleConfigOptions } from './DidCommCredentialsModuleConfig'\nimport { DidCommCredentialsModuleConfig } from './DidCommCredentialsModuleConfig'\nimport type { DidCommCredentialProtocol } from './protocol/DidCommCredentialProtocol'\nimport {\n  DidCommRevocationNotificationV1Handler,\n  DidCommRevocationNotificationV2Handler,\n} from './protocol/revocation-notification/handlers'\nimport { DidCommRevocationNotificationService } from './protocol/revocation-notification/services'\nimport { DidCommCredentialV2Protocol } from './protocol/v2'\nimport { DidCommCredentialExchangeRepository } from './repository'\n\n/**\n * Default credentialProtocols that will be registered if the `credentialProtocols` property is not configured.\n */\nexport type DefaultDidCommCredentialProtocols = [DidCommCredentialV2Protocol<[]>]\n\n// CredentialsModuleOptions makes the credentialProtocols property optional from the config, as it will set it when not provided.\nexport type DidCommCredentialsModuleOptions<CredentialProtocols extends DidCommCredentialProtocol[]> = Optional<\n  DidCommCredentialsModuleConfigOptions<CredentialProtocols>,\n  'credentialProtocols'\n>\n\nexport class DidCommCredentialsModule<\n  CredentialProtocols extends DidCommCredentialProtocol[] = DefaultDidCommCredentialProtocols,\n> implements ApiModule\n{\n  public readonly config: DidCommCredentialsModuleConfig<CredentialProtocols>\n\n  // Infer Api type from the config\n  public readonly api: Constructor<DidCommCredentialsApi<CredentialProtocols>> = DidCommCredentialsApi\n\n  public constructor(config?: DidCommCredentialsModuleOptions<CredentialProtocols>) {\n    this.config = new DidCommCredentialsModuleConfig({\n      ...config,\n      // NOTE: the credentialProtocols defaults are set in the CredentialsModule rather than the CredentialsModuleConfig to\n      // avoid dependency cycles.\n      credentialProtocols: config?.credentialProtocols ?? [new DidCommCredentialV2Protocol({ credentialFormats: [] })],\n    }) as DidCommCredentialsModuleConfig<CredentialProtocols>\n  }\n\n  /**\n   * Registers the dependencies of the credentials module on the dependency manager.\n   */\n  public register(dependencyManager: DependencyManager) {\n    // Config\n    dependencyManager.registerInstance(DidCommCredentialsModuleConfig, this.config)\n\n    // Services\n    dependencyManager.registerSingleton(DidCommRevocationNotificationService)\n\n    // Repositories\n    dependencyManager.registerSingleton(DidCommCredentialExchangeRepository)\n  }\n\n  public async initialize(agentContext: AgentContext): Promise<void> {\n    const messageHandlerRegistry = agentContext.dependencyManager.resolve(DidCommMessageHandlerRegistry)\n    const featureRegistry = agentContext.dependencyManager.resolve(DidCommFeatureRegistry)\n\n    const revocationNotificationService = agentContext.resolve(DidCommRevocationNotificationService)\n\n    messageHandlerRegistry.registerMessageHandler(\n      new DidCommRevocationNotificationV1Handler(revocationNotificationService)\n    )\n    messageHandlerRegistry.registerMessageHandler(\n      new DidCommRevocationNotificationV2Handler(revocationNotificationService)\n    )\n\n    featureRegistry.register(\n      new DidCommProtocol({\n        id: 'https://didcomm.org/revocation_notification/1.0',\n        roles: ['holder'],\n      }),\n      new DidCommProtocol({\n        id: 'https://didcomm.org/revocation_notification/2.0',\n        roles: ['holder'],\n      })\n    )\n\n    // Protocol needs to register feature registry items and handlers\n    for (const credentialProtocol of this.config.credentialProtocols) {\n      credentialProtocol.register(messageHandlerRegistry, featureRegistry)\n\n      if (credentialProtocol.constructor.name === 'DidCommProofV1Protocol') {\n        agentContext.config.logger.debug(\n          \"The 'DidCommProofV1Protocol' is deprecated and will be removed in version 0.7 of Credo. You should upgrade to the 'DidCommProofV2Protocol' instead.\"\n        )\n      }\n    }\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;AA2BA,IAAa,2BAAb,MAGA;CAME,AAAO,YAAY,QAA+D;OAFlE,MAA+D;AAG7E,OAAK,SAAS,IAAI,+BAA+B;GAC/C,GAAG;GAGH,qBAAqB,QAAQ,uBAAuB,CAAC,IAAI,4BAA4B,EAAE,mBAAmB,EAAE,EAAE,CAAC,CAAC;GACjH,CAAC;;;;;CAMJ,AAAO,SAAS,mBAAsC;AAEpD,oBAAkB,iBAAiB,gCAAgC,KAAK,OAAO;AAG/E,oBAAkB,kBAAkB,qCAAqC;AAGzE,oBAAkB,kBAAkB,oCAAoC;;CAG1E,MAAa,WAAW,cAA2C;EACjE,MAAM,yBAAyB,aAAa,kBAAkB,QAAQ,8BAA8B;EACpG,MAAM,kBAAkB,aAAa,kBAAkB,QAAQ,uBAAuB;EAEtF,MAAM,gCAAgC,aAAa,QAAQ,qCAAqC;AAEhG,yBAAuB,uBACrB,IAAI,uCAAuC,8BAA8B,CAC1E;AACD,yBAAuB,uBACrB,IAAI,uCAAuC,8BAA8B,CAC1E;AAED,kBAAgB,SACd,IAAI,gBAAgB;GAClB,IAAI;GACJ,OAAO,CAAC,SAAS;GAClB,CAAC,EACF,IAAI,gBAAgB;GAClB,IAAI;GACJ,OAAO,CAAC,SAAS;GAClB,CAAC,CACH;AAGD,OAAK,MAAM,sBAAsB,KAAK,OAAO,qBAAqB;AAChE,sBAAmB,SAAS,wBAAwB,gBAAgB;AAEpE,OAAI,mBAAmB,YAAY,SAAS,yBAC1C,cAAa,OAAO,OAAO,MACzB,sJACD"}