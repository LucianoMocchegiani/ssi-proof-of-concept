{"version":3,"file":"DidCommCredentialExchangeRecord.mjs","names":[],"sources":["../../../../src/modules/credentials/repository/DidCommCredentialExchangeRecord.ts"],"sourcesContent":["import type { TagsBase } from '@credo-ts/core'\nimport { BaseRecord, CredoError, utils } from '@credo-ts/core'\nimport { Type } from 'class-transformer'\nimport type { DidCommCredentialRole } from '../models'\nimport type { DidCommAutoAcceptCredential } from '../models/DidCommCredentialAutoAcceptType'\nimport { DidCommCredentialPreviewAttribute } from '../models/DidCommCredentialPreviewAttribute'\nimport type { DidCommCredentialState } from '../models/DidCommCredentialState'\nimport { DidCommRevocationNotification } from '../models/DidCommRevocationNotification'\n\nexport interface DidCommCredentialExchangeRecordProps {\n  id?: string\n  createdAt?: Date\n  state: DidCommCredentialState\n  role: DidCommCredentialRole\n  connectionId?: string\n  threadId: string\n  parentThreadId?: string\n  protocolVersion: string\n\n  tags?: CustomDidCommCredentialExchangeTags\n  credentialAttributes?: DidCommCredentialPreviewAttribute[]\n  autoAcceptCredential?: DidCommAutoAcceptCredential\n  revocationNotification?: DidCommRevocationNotification\n  errorMessage?: string\n  credentials?: CredentialRecordBinding[]\n}\n\nexport type CustomDidCommCredentialExchangeTags = TagsBase\nexport type DefaultDidCommCredentialExchangeTags = {\n  threadId: string\n  parentThreadId?: string\n  connectionId?: string\n  state: DidCommCredentialState\n  role: DidCommCredentialRole\n  credentialIds: string[]\n}\n\nexport interface CredentialRecordBinding {\n  credentialRecordType: string\n  credentialRecordId: string\n}\n\nexport class DidCommCredentialExchangeRecord extends BaseRecord<\n  DefaultDidCommCredentialExchangeTags,\n  CustomDidCommCredentialExchangeTags\n> {\n  public connectionId?: string\n  public threadId!: string\n  public parentThreadId?: string\n  public state!: DidCommCredentialState\n  public role!: DidCommCredentialRole\n  public autoAcceptCredential?: DidCommAutoAcceptCredential\n\n  @Type(() => DidCommRevocationNotification)\n  public revocationNotification?: DidCommRevocationNotification\n  public errorMessage?: string\n  public protocolVersion!: string\n  public credentials: CredentialRecordBinding[] = []\n\n  @Type(() => DidCommCredentialPreviewAttribute)\n  public credentialAttributes?: DidCommCredentialPreviewAttribute[]\n\n  // Type is CredentialRecord on purpose (without Exchange) as this is how the record was initially called.\n  public static readonly type = 'CredentialRecord'\n  public readonly type = DidCommCredentialExchangeRecord.type\n\n  public constructor(props: DidCommCredentialExchangeRecordProps) {\n    super()\n    if (props) {\n      this.id = props.id ?? utils.uuid()\n      this.createdAt = props.createdAt ?? new Date()\n      this.state = props.state\n      this.role = props.role\n      this.connectionId = props.connectionId\n      this.threadId = props.threadId\n      this.parentThreadId = props.parentThreadId\n      this.protocolVersion = props.protocolVersion\n      this._tags = props.tags ?? {}\n\n      this.credentialAttributes = props.credentialAttributes\n      this.autoAcceptCredential = props.autoAcceptCredential\n      this.revocationNotification = props.revocationNotification\n      this.errorMessage = props.errorMessage\n      this.credentials = props.credentials || []\n    }\n  }\n\n  public getTags() {\n    const ids = this.credentials.map((c) => c.credentialRecordId)\n\n    return {\n      ...this._tags,\n      threadId: this.threadId,\n      parentThreadId: this.parentThreadId,\n      connectionId: this.connectionId,\n      state: this.state,\n      role: this.role,\n      credentialIds: ids,\n    }\n  }\n\n  public assertProtocolVersion(version: string) {\n    if (this.protocolVersion !== version) {\n      throw new CredoError(\n        `Credential record has invalid protocol version ${this.protocolVersion}. Expected version ${version}`\n      )\n    }\n  }\n\n  public assertState(expectedStates: DidCommCredentialState | DidCommCredentialState[]) {\n    if (!Array.isArray(expectedStates)) {\n      expectedStates = [expectedStates]\n    }\n\n    if (!expectedStates.includes(this.state)) {\n      throw new CredoError(\n        `Credential record is in invalid state ${this.state}. Valid states are: ${expectedStates.join(', ')}.`\n      )\n    }\n  }\n\n  public assertConnection(currentConnectionId: string) {\n    if (!this.connectionId) {\n      throw new CredoError(\n        'Credential record is not associated with any connection. This is often the case with connection-less credential exchange'\n      )\n    }\n    if (this.connectionId !== currentConnectionId) {\n      throw new CredoError(\n        `Credential record is associated with connection '${this.connectionId}'. Current connection is '${currentConnectionId}'`\n      )\n    }\n  }\n}\n"],"mappings":";;;;;;;;;AA0CA,IAAa,kCAAb,MAAa,wCAAwC,WAGnD;CAqBA,AAAO,YAAY,OAA6C;AAC9D,SAAO;OAVF,cAAyC,EAAE;OAOlC,OAAO,gCAAgC;AAIrD,MAAI,OAAO;AACT,QAAK,KAAK,MAAM,MAAM,MAAM,MAAM;AAClC,QAAK,YAAY,MAAM,6BAAa,IAAI,MAAM;AAC9C,QAAK,QAAQ,MAAM;AACnB,QAAK,OAAO,MAAM;AAClB,QAAK,eAAe,MAAM;AAC1B,QAAK,WAAW,MAAM;AACtB,QAAK,iBAAiB,MAAM;AAC5B,QAAK,kBAAkB,MAAM;AAC7B,QAAK,QAAQ,MAAM,QAAQ,EAAE;AAE7B,QAAK,uBAAuB,MAAM;AAClC,QAAK,uBAAuB,MAAM;AAClC,QAAK,yBAAyB,MAAM;AACpC,QAAK,eAAe,MAAM;AAC1B,QAAK,cAAc,MAAM,eAAe,EAAE;;;CAI9C,AAAO,UAAU;EACf,MAAM,MAAM,KAAK,YAAY,KAAK,MAAM,EAAE,mBAAmB;AAE7D,SAAO;GACL,GAAG,KAAK;GACR,UAAU,KAAK;GACf,gBAAgB,KAAK;GACrB,cAAc,KAAK;GACnB,OAAO,KAAK;GACZ,MAAM,KAAK;GACX,eAAe;GAChB;;CAGH,AAAO,sBAAsB,SAAiB;AAC5C,MAAI,KAAK,oBAAoB,QAC3B,OAAM,IAAI,WACR,kDAAkD,KAAK,gBAAgB,qBAAqB,UAC7F;;CAIL,AAAO,YAAY,gBAAmE;AACpF,MAAI,CAAC,MAAM,QAAQ,eAAe,CAChC,kBAAiB,CAAC,eAAe;AAGnC,MAAI,CAAC,eAAe,SAAS,KAAK,MAAM,CACtC,OAAM,IAAI,WACR,yCAAyC,KAAK,MAAM,sBAAsB,eAAe,KAAK,KAAK,CAAC,GACrG;;CAIL,AAAO,iBAAiB,qBAA6B;AACnD,MAAI,CAAC,KAAK,aACR,OAAM,IAAI,WACR,2HACD;AAEH,MAAI,KAAK,iBAAiB,oBACxB,OAAM,IAAI,WACR,oDAAoD,KAAK,aAAa,4BAA4B,oBAAoB,GACvH;;;gCAnEkB,OAAO;YAV7B,WAAW,8BAA8B;YAMzC,WAAW,kCAAkC"}