{"version":3,"file":"DidCommDiscoverFeaturesV1Service.mjs","names":[],"sources":["../../../../../src/modules/discover-features/protocol/v1/DidCommDiscoverFeaturesV1Service.ts"],"sourcesContent":["import { CredoError, EventEmitter, InjectionSymbols, inject, injectable, type Logger } from '@credo-ts/core'\nimport { DidCommFeatureRegistry } from '../../../../DidCommFeatureRegistry'\nimport type { DidCommMessage } from '../../../../DidCommMessage'\nimport { DidCommMessageHandlerRegistry } from '../../../../DidCommMessageHandlerRegistry'\nimport type { DidCommInboundMessageContext } from '../../../../models'\nimport { DidCommProtocol } from '../../../../models'\nimport type {\n  DidCommDiscoverFeaturesDisclosureReceivedEvent,\n  DidCommDiscoverFeaturesQueryReceivedEvent,\n} from '../../DidCommDiscoverFeaturesEvents'\nimport { DidCommDiscoverFeaturesEventTypes } from '../../DidCommDiscoverFeaturesEvents'\nimport { DidCommDiscoverFeaturesModuleConfig } from '../../DidCommDiscoverFeaturesModuleConfig'\nimport type {\n  CreateDisclosureOptions,\n  CreateQueryOptions,\n  DiscoverFeaturesProtocolMsgReturnType,\n} from '../../DidCommDiscoverFeaturesServiceOptions'\nimport { DidCommDiscoverFeaturesService } from '../../services'\n\nimport { DidCommFeaturesDiscloseMessageHandler, DidCommFeaturesQueryMessageHandler } from './handlers'\nimport {\n  DidCommFeaturesDiscloseMessage,\n  DidCommFeaturesDiscloseProtocol,\n  DidCommFeaturesQueryMessage,\n} from './messages'\n\n@injectable()\nexport class DidCommDiscoverFeaturesV1Service extends DidCommDiscoverFeaturesService {\n  public constructor(\n    featureRegistry: DidCommFeatureRegistry,\n    eventEmitter: EventEmitter,\n    @inject(InjectionSymbols.Logger) logger: Logger,\n    discoverFeaturesConfig: DidCommDiscoverFeaturesModuleConfig\n  ) {\n    super(featureRegistry, eventEmitter, logger, discoverFeaturesConfig)\n  }\n\n  /**\n   * The version of the discover features protocol this service supports\n   */\n  public readonly version = 'v1'\n\n  public register(messageHandlerRegistry: DidCommMessageHandlerRegistry) {\n    messageHandlerRegistry.registerMessageHandler(new DidCommFeaturesDiscloseMessageHandler(this))\n    messageHandlerRegistry.registerMessageHandler(new DidCommFeaturesQueryMessageHandler(this))\n  }\n\n  public async createQuery(\n    options: CreateQueryOptions\n  ): Promise<DiscoverFeaturesProtocolMsgReturnType<DidCommFeaturesQueryMessage>> {\n    if (options.queries.length > 1) {\n      throw new CredoError('Discover Features V1 only supports a single query')\n    }\n\n    if (options.queries[0].featureType !== 'protocol') {\n      throw new CredoError('Discover Features V1 only supports querying for protocol support')\n    }\n\n    const queryMessage = new DidCommFeaturesQueryMessage({\n      query: options.queries[0].match,\n      comment: options.comment,\n    })\n\n    return { message: queryMessage }\n  }\n\n  public async processQuery(\n    messageContext: DidCommInboundMessageContext<DidCommFeaturesQueryMessage>\n  ): Promise<DiscoverFeaturesProtocolMsgReturnType<DidCommMessage> | undefined> {\n    const { query, threadId } = messageContext.message\n\n    const connection = messageContext.assertReadyConnection()\n\n    this.eventEmitter.emit<DidCommDiscoverFeaturesQueryReceivedEvent>(messageContext.agentContext, {\n      type: DidCommDiscoverFeaturesEventTypes.QueryReceived,\n      payload: {\n        message: messageContext.message,\n        connection,\n        queries: [{ featureType: 'protocol', match: query }],\n        protocolVersion: this.version,\n        threadId,\n      },\n    })\n\n    // Process query and send responde automatically if configured to do so, otherwise\n    // just send the event and let controller decide\n    if (this.discoverFeaturesModuleConfig.autoAcceptQueries) {\n      return await this.createDisclosure({\n        threadId,\n        disclosureQueries: [{ featureType: 'protocol', match: query }],\n      })\n    }\n  }\n\n  public async createDisclosure(\n    options: CreateDisclosureOptions\n  ): Promise<DiscoverFeaturesProtocolMsgReturnType<DidCommFeaturesDiscloseMessage>> {\n    if (options.disclosureQueries.some((item) => item.featureType !== 'protocol')) {\n      throw new CredoError('Discover Features V1 only supports protocols')\n    }\n\n    if (!options.threadId) {\n      throw new CredoError('Thread Id is required for Discover Features V1 disclosure')\n    }\n\n    const matches = this.featureRegistry.query(...options.disclosureQueries)\n\n    const discloseMessage = new DidCommFeaturesDiscloseMessage({\n      threadId: options.threadId,\n      protocols: matches.map(\n        (item) =>\n          new DidCommFeaturesDiscloseProtocol({\n            protocolId: (item as DidCommProtocol).id,\n            roles: (item as DidCommProtocol).roles,\n          })\n      ),\n    })\n\n    return { message: discloseMessage }\n  }\n\n  public async processDisclosure(\n    messageContext: DidCommInboundMessageContext<DidCommFeaturesDiscloseMessage>\n  ): Promise<void> {\n    const { protocols, threadId } = messageContext.message\n\n    const connection = messageContext.assertReadyConnection()\n\n    this.eventEmitter.emit<DidCommDiscoverFeaturesDisclosureReceivedEvent>(messageContext.agentContext, {\n      type: DidCommDiscoverFeaturesEventTypes.DisclosureReceived,\n      payload: {\n        message: messageContext.message,\n        connection,\n        disclosures: protocols.map((item) => new DidCommProtocol({ id: item.protocolId, roles: item.roles })),\n        protocolVersion: this.version,\n        threadId,\n      },\n    })\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;AA2BO,6CAAM,yCAAyC,+BAA+B;CACnF,AAAO,YACL,iBACA,cACA,AAAiC,QACjC,wBACA;AACA,QAAM,iBAAiB,cAAc,QAAQ,uBAAuB;OAMtD,UAAU;;CAE1B,AAAO,SAAS,wBAAuD;AACrE,yBAAuB,uBAAuB,IAAI,sCAAsC,KAAK,CAAC;AAC9F,yBAAuB,uBAAuB,IAAI,mCAAmC,KAAK,CAAC;;CAG7F,MAAa,YACX,SAC6E;AAC7E,MAAI,QAAQ,QAAQ,SAAS,EAC3B,OAAM,IAAI,WAAW,oDAAoD;AAG3E,MAAI,QAAQ,QAAQ,GAAG,gBAAgB,WACrC,OAAM,IAAI,WAAW,mEAAmE;AAQ1F,SAAO,EAAE,SALY,IAAI,4BAA4B;GACnD,OAAO,QAAQ,QAAQ,GAAG;GAC1B,SAAS,QAAQ;GAClB,CAAC,EAE8B;;CAGlC,MAAa,aACX,gBAC4E;EAC5E,MAAM,EAAE,OAAO,aAAa,eAAe;EAE3C,MAAM,aAAa,eAAe,uBAAuB;AAEzD,OAAK,aAAa,KAAgD,eAAe,cAAc;GAC7F,MAAM,kCAAkC;GACxC,SAAS;IACP,SAAS,eAAe;IACxB;IACA,SAAS,CAAC;KAAE,aAAa;KAAY,OAAO;KAAO,CAAC;IACpD,iBAAiB,KAAK;IACtB;IACD;GACF,CAAC;AAIF,MAAI,KAAK,6BAA6B,kBACpC,QAAO,MAAM,KAAK,iBAAiB;GACjC;GACA,mBAAmB,CAAC;IAAE,aAAa;IAAY,OAAO;IAAO,CAAC;GAC/D,CAAC;;CAIN,MAAa,iBACX,SACgF;AAChF,MAAI,QAAQ,kBAAkB,MAAM,SAAS,KAAK,gBAAgB,WAAW,CAC3E,OAAM,IAAI,WAAW,+CAA+C;AAGtE,MAAI,CAAC,QAAQ,SACX,OAAM,IAAI,WAAW,4DAA4D;EAGnF,MAAM,UAAU,KAAK,gBAAgB,MAAM,GAAG,QAAQ,kBAAkB;AAaxE,SAAO,EAAE,SAXe,IAAI,+BAA+B;GACzD,UAAU,QAAQ;GAClB,WAAW,QAAQ,KAChB,SACC,IAAI,gCAAgC;IAClC,YAAa,KAAyB;IACtC,OAAQ,KAAyB;IAClC,CAAC,CACL;GACF,CAAC,EAEiC;;CAGrC,MAAa,kBACX,gBACe;EACf,MAAM,EAAE,WAAW,aAAa,eAAe;EAE/C,MAAM,aAAa,eAAe,uBAAuB;AAEzD,OAAK,aAAa,KAAqD,eAAe,cAAc;GAClG,MAAM,kCAAkC;GACxC,SAAS;IACP,SAAS,eAAe;IACxB;IACA,aAAa,UAAU,KAAK,SAAS,IAAI,gBAAgB;KAAE,IAAI,KAAK;KAAY,OAAO,KAAK;KAAO,CAAC,CAAC;IACrG,iBAAiB,KAAK;IACtB;IACD;GACF,CAAC;;;;CA/GL,YAAY;oBAKR,OAAO,iBAAiB,OAAO"}