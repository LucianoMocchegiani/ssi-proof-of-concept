{"version":3,"file":"DidCommDiscoverFeaturesV2Service.mjs","names":[],"sources":["../../../../../src/modules/discover-features/protocol/v2/DidCommDiscoverFeaturesV2Service.ts"],"sourcesContent":["import { EventEmitter, InjectionSymbols, inject, injectable, type Logger } from '@credo-ts/core'\nimport { DidCommFeatureRegistry } from '../../../../DidCommFeatureRegistry'\nimport { DidCommMessageHandlerRegistry } from '../../../../DidCommMessageHandlerRegistry'\nimport type { DidCommInboundMessageContext } from '../../../../models'\nimport type {\n  DidCommDiscoverFeaturesDisclosureReceivedEvent,\n  DidCommDiscoverFeaturesQueryReceivedEvent,\n} from '../../DidCommDiscoverFeaturesEvents'\nimport { DidCommDiscoverFeaturesEventTypes } from '../../DidCommDiscoverFeaturesEvents'\nimport { DidCommDiscoverFeaturesModuleConfig } from '../../DidCommDiscoverFeaturesModuleConfig'\nimport type {\n  CreateDisclosureOptions,\n  CreateQueryOptions,\n  DiscoverFeaturesProtocolMsgReturnType,\n} from '../../DidCommDiscoverFeaturesServiceOptions'\nimport { DidCommDiscoverFeaturesService } from '../../services'\n\nimport { DidCommFeaturesDisclosuresMessageHandler, DidCommFeaturesQueriesMessageHandler } from './handlers'\nimport { DidCommFeaturesDisclosuresMessage, DidCommFeaturesQueriesMessage } from './messages'\n\n@injectable()\nexport class DidCommDiscoverFeaturesV2Service extends DidCommDiscoverFeaturesService {\n  public constructor(\n    featureRegistry: DidCommFeatureRegistry,\n    eventEmitter: EventEmitter,\n    @inject(InjectionSymbols.Logger) logger: Logger,\n    discoverFeaturesModuleConfig: DidCommDiscoverFeaturesModuleConfig\n  ) {\n    super(featureRegistry, eventEmitter, logger, discoverFeaturesModuleConfig)\n  }\n\n  /**\n   * The version of the discover features protocol this service supports\n   */\n  public readonly version = 'v2'\n\n  public register(messageHandlerRegistry: DidCommMessageHandlerRegistry) {\n    messageHandlerRegistry.registerMessageHandler(new DidCommFeaturesDisclosuresMessageHandler(this))\n    messageHandlerRegistry.registerMessageHandler(new DidCommFeaturesQueriesMessageHandler(this))\n  }\n\n  public async createQuery(\n    options: CreateQueryOptions\n  ): Promise<DiscoverFeaturesProtocolMsgReturnType<DidCommFeaturesQueriesMessage>> {\n    const queryMessage = new DidCommFeaturesQueriesMessage({ queries: options.queries })\n\n    return { message: queryMessage }\n  }\n\n  public async processQuery(\n    messageContext: DidCommInboundMessageContext<DidCommFeaturesQueriesMessage>\n  ): Promise<DiscoverFeaturesProtocolMsgReturnType<DidCommFeaturesDisclosuresMessage> | undefined> {\n    const { queries, threadId } = messageContext.message\n\n    const connection = messageContext.assertReadyConnection()\n\n    this.eventEmitter.emit<DidCommDiscoverFeaturesQueryReceivedEvent>(messageContext.agentContext, {\n      type: DidCommDiscoverFeaturesEventTypes.QueryReceived,\n      payload: {\n        message: messageContext.message,\n        connection,\n        queries,\n        protocolVersion: this.version,\n        threadId,\n      },\n    })\n\n    // Process query and send responde automatically if configured to do so, otherwise\n    // just send the event and let controller decide\n    if (this.discoverFeaturesModuleConfig.autoAcceptQueries) {\n      return await this.createDisclosure({\n        threadId,\n        disclosureQueries: queries,\n      })\n    }\n  }\n\n  public async createDisclosure(\n    options: CreateDisclosureOptions\n  ): Promise<DiscoverFeaturesProtocolMsgReturnType<DidCommFeaturesDisclosuresMessage>> {\n    const matches = this.featureRegistry.query(...options.disclosureQueries)\n\n    const discloseMessage = new DidCommFeaturesDisclosuresMessage({\n      threadId: options.threadId,\n      features: matches,\n    })\n\n    return { message: discloseMessage }\n  }\n\n  public async processDisclosure(\n    messageContext: DidCommInboundMessageContext<DidCommFeaturesDisclosuresMessage>\n  ): Promise<void> {\n    const { disclosures, threadId } = messageContext.message\n\n    const connection = messageContext.assertReadyConnection()\n\n    this.eventEmitter.emit<DidCommDiscoverFeaturesDisclosureReceivedEvent>(messageContext.agentContext, {\n      type: DidCommDiscoverFeaturesEventTypes.DisclosureReceived,\n      payload: {\n        message: messageContext.message,\n        connection,\n        disclosures,\n        protocolVersion: this.version,\n        threadId,\n      },\n    })\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;AAqBO,6CAAM,yCAAyC,+BAA+B;CACnF,AAAO,YACL,iBACA,cACA,AAAiC,QACjC,8BACA;AACA,QAAM,iBAAiB,cAAc,QAAQ,6BAA6B;OAM5D,UAAU;;CAE1B,AAAO,SAAS,wBAAuD;AACrE,yBAAuB,uBAAuB,IAAI,yCAAyC,KAAK,CAAC;AACjG,yBAAuB,uBAAuB,IAAI,qCAAqC,KAAK,CAAC;;CAG/F,MAAa,YACX,SAC+E;AAG/E,SAAO,EAAE,SAFY,IAAI,8BAA8B,EAAE,SAAS,QAAQ,SAAS,CAAC,EAEpD;;CAGlC,MAAa,aACX,gBAC+F;EAC/F,MAAM,EAAE,SAAS,aAAa,eAAe;EAE7C,MAAM,aAAa,eAAe,uBAAuB;AAEzD,OAAK,aAAa,KAAgD,eAAe,cAAc;GAC7F,MAAM,kCAAkC;GACxC,SAAS;IACP,SAAS,eAAe;IACxB;IACA;IACA,iBAAiB,KAAK;IACtB;IACD;GACF,CAAC;AAIF,MAAI,KAAK,6BAA6B,kBACpC,QAAO,MAAM,KAAK,iBAAiB;GACjC;GACA,mBAAmB;GACpB,CAAC;;CAIN,MAAa,iBACX,SACmF;EACnF,MAAM,UAAU,KAAK,gBAAgB,MAAM,GAAG,QAAQ,kBAAkB;AAOxE,SAAO,EAAE,SALe,IAAI,kCAAkC;GAC5D,UAAU,QAAQ;GAClB,UAAU;GACX,CAAC,EAEiC;;CAGrC,MAAa,kBACX,gBACe;EACf,MAAM,EAAE,aAAa,aAAa,eAAe;EAEjD,MAAM,aAAa,eAAe,uBAAuB;AAEzD,OAAK,aAAa,KAAqD,eAAe,cAAc;GAClG,MAAM,kCAAkC;GACxC,SAAS;IACP,SAAS,eAAe;IACxB;IACA;IACA,iBAAiB,KAAK;IACtB;IACD;GACF,CAAC;;;;CAtFL,YAAY;oBAKR,OAAO,iBAAiB,OAAO"}