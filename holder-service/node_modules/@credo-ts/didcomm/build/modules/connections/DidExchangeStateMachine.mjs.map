{"version":3,"file":"DidExchangeStateMachine.mjs","names":[],"sources":["../../../src/modules/connections/DidExchangeStateMachine.ts"],"sourcesContent":["import { CredoError } from '@credo-ts/core'\nimport type { ParsedMessageType } from '../../util/messageType'\nimport { canHandleMessageType } from '../../util/messageType'\nimport {\n  DidCommDidExchangeCompleteMessage,\n  DidCommDidExchangeRequestMessage,\n  DidCommDidExchangeResponseMessage,\n} from './messages'\nimport { DidCommDidExchangeRole, DidCommDidExchangeState } from './models'\nimport type { DidCommConnectionRecord } from './repository'\n\n// biome-ignore lint/complexity/noStaticOnlyClass: no explanation\nexport class DidExchangeStateMachine {\n  private static createMessageStateRules = [\n    {\n      message: DidCommDidExchangeRequestMessage,\n      state: DidCommDidExchangeState.InvitationReceived,\n      role: DidCommDidExchangeRole.Requester,\n      nextState: DidCommDidExchangeState.RequestSent,\n    },\n    {\n      message: DidCommDidExchangeResponseMessage,\n      state: DidCommDidExchangeState.RequestReceived,\n      role: DidCommDidExchangeRole.Responder,\n      nextState: DidCommDidExchangeState.ResponseSent,\n    },\n    {\n      message: DidCommDidExchangeCompleteMessage,\n      state: DidCommDidExchangeState.ResponseReceived,\n      role: DidCommDidExchangeRole.Requester,\n      nextState: DidCommDidExchangeState.Completed,\n    },\n  ]\n\n  private static processMessageStateRules = [\n    {\n      message: DidCommDidExchangeRequestMessage,\n      state: DidCommDidExchangeState.InvitationSent,\n      role: DidCommDidExchangeRole.Responder,\n      nextState: DidCommDidExchangeState.RequestReceived,\n    },\n    {\n      message: DidCommDidExchangeResponseMessage,\n      state: DidCommDidExchangeState.RequestSent,\n      role: DidCommDidExchangeRole.Requester,\n      nextState: DidCommDidExchangeState.ResponseReceived,\n    },\n    {\n      message: DidCommDidExchangeCompleteMessage,\n      state: DidCommDidExchangeState.ResponseSent,\n      role: DidCommDidExchangeRole.Responder,\n      nextState: DidCommDidExchangeState.Completed,\n    },\n  ]\n\n  public static assertCreateMessageState(messageType: ParsedMessageType, record: DidCommConnectionRecord) {\n    const rule = DidExchangeStateMachine.createMessageStateRules.find((r) =>\n      canHandleMessageType(r.message, messageType)\n    )\n    if (!rule) {\n      throw new CredoError(`Could not find create message rule for ${messageType}`)\n    }\n    if (rule.state !== record.state || rule.role !== record.role) {\n      throw new CredoError(\n        `Record with role ${record.role} is in invalid state ${record.state} to create ${messageType}. Expected state for role ${rule.role} is ${rule.state}.`\n      )\n    }\n  }\n\n  public static assertProcessMessageState(messageType: ParsedMessageType, record: DidCommConnectionRecord) {\n    const rule = DidExchangeStateMachine.processMessageStateRules.find((r) =>\n      canHandleMessageType(r.message, messageType)\n    )\n    if (!rule) {\n      throw new CredoError(`Could not find create message rule for ${messageType}`)\n    }\n    if (rule.state !== record.state || rule.role !== record.role) {\n      throw new CredoError(\n        `Record with role ${record.role} is in invalid state ${record.state} to process ${messageType.messageTypeUri}. Expected state for role ${rule.role} is ${rule.state}.`\n      )\n    }\n  }\n\n  public static nextState(messageType: ParsedMessageType, record: DidCommConnectionRecord) {\n    const rule = DidExchangeStateMachine.createMessageStateRules\n      .concat(DidExchangeStateMachine.processMessageStateRules)\n      .find((r) => canHandleMessageType(r.message, messageType) && r.role === record.role)\n    if (!rule) {\n      throw new CredoError(\n        `Could not find create message rule for messageType ${messageType.messageTypeUri}, state ${record.state} and role ${record.role}`\n      )\n    }\n    return rule.nextState\n  }\n}\n"],"mappings":";;;;;;;;;;;AAYA,IAAa,0BAAb,MAAa,wBAAwB;CA2CnC,OAAc,yBAAyB,aAAgC,QAAiC;EACtG,MAAM,OAAO,wBAAwB,wBAAwB,MAAM,MACjE,qBAAqB,EAAE,SAAS,YAAY,CAC7C;AACD,MAAI,CAAC,KACH,OAAM,IAAI,WAAW,0CAA0C,cAAc;AAE/E,MAAI,KAAK,UAAU,OAAO,SAAS,KAAK,SAAS,OAAO,KACtD,OAAM,IAAI,WACR,oBAAoB,OAAO,KAAK,uBAAuB,OAAO,MAAM,aAAa,YAAY,4BAA4B,KAAK,KAAK,MAAM,KAAK,MAAM,GACrJ;;CAIL,OAAc,0BAA0B,aAAgC,QAAiC;EACvG,MAAM,OAAO,wBAAwB,yBAAyB,MAAM,MAClE,qBAAqB,EAAE,SAAS,YAAY,CAC7C;AACD,MAAI,CAAC,KACH,OAAM,IAAI,WAAW,0CAA0C,cAAc;AAE/E,MAAI,KAAK,UAAU,OAAO,SAAS,KAAK,SAAS,OAAO,KACtD,OAAM,IAAI,WACR,oBAAoB,OAAO,KAAK,uBAAuB,OAAO,MAAM,cAAc,YAAY,eAAe,4BAA4B,KAAK,KAAK,MAAM,KAAK,MAAM,GACrK;;CAIL,OAAc,UAAU,aAAgC,QAAiC;EACvF,MAAM,OAAO,wBAAwB,wBAClC,OAAO,wBAAwB,yBAAyB,CACxD,MAAM,MAAM,qBAAqB,EAAE,SAAS,YAAY,IAAI,EAAE,SAAS,OAAO,KAAK;AACtF,MAAI,CAAC,KACH,OAAM,IAAI,WACR,sDAAsD,YAAY,eAAe,UAAU,OAAO,MAAM,YAAY,OAAO,OAC5H;AAEH,SAAO,KAAK;;;wBA/EC,0BAA0B;CACvC;EACE,SAAS;EACT,OAAO,wBAAwB;EAC/B,MAAM,uBAAuB;EAC7B,WAAW,wBAAwB;EACpC;CACD;EACE,SAAS;EACT,OAAO,wBAAwB;EAC/B,MAAM,uBAAuB;EAC7B,WAAW,wBAAwB;EACpC;CACD;EACE,SAAS;EACT,OAAO,wBAAwB;EAC/B,MAAM,uBAAuB;EAC7B,WAAW,wBAAwB;EACpC;CACF;wBAEc,2BAA2B;CACxC;EACE,SAAS;EACT,OAAO,wBAAwB;EAC/B,MAAM,uBAAuB;EAC7B,WAAW,wBAAwB;EACpC;CACD;EACE,SAAS;EACT,OAAO,wBAAwB;EAC/B,MAAM,uBAAuB;EAC7B,WAAW,wBAAwB;EACpC;CACD;EACE,SAAS;EACT,OAAO,wBAAwB;EAC/B,MAAM,uBAAuB;EAC7B,WAAW,wBAAwB;EACpC;CACF"}