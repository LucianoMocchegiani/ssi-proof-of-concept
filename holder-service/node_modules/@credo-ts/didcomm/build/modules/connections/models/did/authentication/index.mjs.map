{"version":3,"file":"index.mjs","names":[],"sources":["../../../../../../src/modules/connections/models/did/authentication/index.ts"],"sourcesContent":["import { CredoError } from '@credo-ts/core'\nimport type { ClassConstructor } from 'class-transformer'\nimport { instanceToPlain, plainToInstance, Transform, TransformationType } from 'class-transformer'\n\nimport { PublicKey, publicKeyTypes } from '../publicKey'\n\nimport { Authentication } from './Authentication'\nimport { EmbeddedAuthentication } from './EmbeddedAuthentication'\nimport { ReferencedAuthentication } from './ReferencedAuthentication'\n\nexport const authenticationTypes = {\n  RsaVerificationKey2018: 'RsaSignatureAuthentication2018',\n  Ed25519VerificationKey2018: 'Ed25519SignatureAuthentication2018',\n  Secp256k1VerificationKey2018: 'Secp256k1SignatureAuthenticationKey2018',\n}\n\n/**\n * Decorator that transforms authentication json to corresponding class instances. See {@link authenticationTypes}\n *\n * @example\n * class Example {\n *   AuthenticationTransformer()\n *   private authentication: Authentication\n * }\n */\nexport function AuthenticationTransformer() {\n  return Transform(\n    ({\n      value,\n      obj,\n      type,\n    }: {\n      value: { type: string; publicKey?: string | PublicKey }[]\n      obj: { publicKey: { id: string; type: string }[] }\n      type: TransformationType\n    }) => {\n      // TODO: PLAIN_TO_PLAIN\n\n      if (type === TransformationType.PLAIN_TO_CLASS) {\n        return value.map((auth) => {\n          // referenced public key\n          if (auth.publicKey) {\n            //referenced\n            const publicKeyJson = obj.publicKey.find((publicKey) => publicKey.id === auth.publicKey)\n\n            if (!publicKeyJson) {\n              throw new CredoError(`Invalid public key referenced ${auth.publicKey}`)\n            }\n\n            // Referenced keys use other types than embedded keys.\n            const publicKeyClass = (publicKeyTypes[publicKeyJson.type] ?? PublicKey) as ClassConstructor<PublicKey>\n            const publicKey = plainToInstance<PublicKey, unknown>(publicKeyClass, publicKeyJson)\n            return new ReferencedAuthentication(publicKey, auth.type)\n          }\n          // embedded\n          const publicKeyClass = (publicKeyTypes[auth.type] ?? PublicKey) as ClassConstructor<PublicKey>\n          const publicKey = plainToInstance<PublicKey, unknown>(publicKeyClass, auth)\n          return new EmbeddedAuthentication(publicKey)\n        })\n      }\n      return value.map((auth) => (auth instanceof EmbeddedAuthentication ? instanceToPlain(auth.publicKey) : auth))\n    }\n  )\n}\n\nexport { Authentication, EmbeddedAuthentication, ReferencedAuthentication }\n"],"mappings":";;;;;;;;;AAUA,MAAa,sBAAsB;CACjC,wBAAwB;CACxB,4BAA4B;CAC5B,8BAA8B;CAC/B;;;;;;;;;;AAWD,SAAgB,4BAA4B;AAC1C,QAAO,WACJ,EACC,OACA,KACA,WAKI;AAGJ,MAAI,SAAS,mBAAmB,eAC9B,QAAO,MAAM,KAAK,SAAS;AAEzB,OAAI,KAAK,WAAW;IAElB,MAAM,gBAAgB,IAAI,UAAU,MAAM,cAAc,UAAU,OAAO,KAAK,UAAU;AAExF,QAAI,CAAC,cACH,OAAM,IAAI,WAAW,iCAAiC,KAAK,YAAY;AAMzE,WAAO,IAAI,yBADO,gBADM,eAAe,cAAc,SAAS,WACQ,cAAc,EACrC,KAAK,KAAK;;AAK3D,UAAO,IAAI,uBADO,gBADM,eAAe,KAAK,SAAS,WACiB,KAAK,CAC/B;IAC5C;AAEJ,SAAO,MAAM,KAAK,SAAU,gBAAgB,yBAAyB,gBAAgB,KAAK,UAAU,GAAG,KAAM;GAEhH"}