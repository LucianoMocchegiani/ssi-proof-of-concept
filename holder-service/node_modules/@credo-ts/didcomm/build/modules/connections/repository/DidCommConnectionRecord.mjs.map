{"version":3,"file":"DidCommConnectionRecord.mjs","names":[],"sources":["../../../../src/modules/connections/repository/DidCommConnectionRecord.ts"],"sourcesContent":["import type { TagsBase } from '@credo-ts/core'\nimport { BaseRecord, CredoError, utils } from '@credo-ts/core'\nimport { Transform } from 'class-transformer'\nimport type { DidCommConnectionType } from '../models'\nimport {\n  DidCommDidExchangeRole,\n  DidCommDidExchangeState,\n  DidCommHandshakeProtocol,\n  rfc0160StateFromDidExchangeState,\n} from '../models'\nimport type { DidCommConnectionMetadata } from './DidCommConnectionMetadataTypes'\n\nexport interface DidCommConnectionRecordProps {\n  id?: string\n  createdAt?: Date\n  did?: string\n  theirDid?: string\n  theirLabel?: string\n  state: DidCommDidExchangeState\n  role: DidCommDidExchangeRole\n  alias?: string\n  autoAcceptConnection?: boolean\n  threadId?: string\n  tags?: CustomDidCommConnectionTags\n  imageUrl?: string\n  mediatorId?: string\n  errorMessage?: string\n  protocol?: DidCommHandshakeProtocol\n  outOfBandId?: string\n  invitationDid?: string\n  connectionTypes?: Array<DidCommConnectionType | string>\n  previousDids?: Array<string>\n  previousTheirDids?: Array<string>\n}\n\nexport type CustomDidCommConnectionTags = TagsBase\nexport type DefaultDidCommConnectionTags = {\n  state: DidCommDidExchangeState\n  role: DidCommDidExchangeRole\n  threadId?: string\n  mediatorId?: string\n  did?: string\n  theirDid?: string\n  outOfBandId?: string\n  invitationDid?: string\n  connectionTypes?: Array<DidCommConnectionType | string>\n  previousDids?: Array<string>\n  previousTheirDids?: Array<string>\n}\n\nexport class DidCommConnectionRecord extends BaseRecord<\n  DefaultDidCommConnectionTags,\n  CustomDidCommConnectionTags,\n  DidCommConnectionMetadata\n> {\n  public state!: DidCommDidExchangeState\n  public role!: DidCommDidExchangeRole\n\n  public did?: string\n\n  public theirDid?: string\n  public theirLabel?: string\n\n  public alias?: string\n  public autoAcceptConnection?: boolean\n  public imageUrl?: string\n\n  public threadId?: string\n  public mediatorId?: string\n  public errorMessage?: string\n\n  // We used to store connection record using major.minor version, but we now\n  // only store the major version, storing .x for the minor version. We have this\n  // transformation so we don't have to migrate the data in the database.\n  @Transform(\n    ({ value }) => {\n      if (!value || typeof value !== 'string' || value.endsWith('.x')) return value\n      return `${value.split('.').slice(0, -1).join('.')}.x`\n    },\n\n    { toClassOnly: true }\n  )\n  public protocol?: DidCommHandshakeProtocol\n  public outOfBandId?: string\n  public invitationDid?: string\n\n  public connectionTypes: string[] = []\n  public previousDids: string[] = []\n  public previousTheirDids: string[] = []\n\n  public static readonly type = 'ConnectionRecord'\n  public readonly type = DidCommConnectionRecord.type\n\n  public readonly allowCache = DidCommConnectionRecord.allowCache\n  public static readonly allowCache: boolean = true\n\n  public constructor(props: DidCommConnectionRecordProps) {\n    super()\n\n    if (props) {\n      this.id = props.id ?? utils.uuid()\n      this.createdAt = props.createdAt ?? new Date()\n      this.did = props.did\n      this.invitationDid = props.invitationDid\n      this.theirDid = props.theirDid\n      this.theirLabel = props.theirLabel\n      this.state = props.state\n      this.role = props.role\n      this.alias = props.alias\n      this.autoAcceptConnection = props.autoAcceptConnection\n      this._tags = props.tags ?? {}\n      this.threadId = props.threadId\n      this.imageUrl = props.imageUrl\n      this.mediatorId = props.mediatorId\n      this.errorMessage = props.errorMessage\n      this.protocol = props.protocol\n      this.outOfBandId = props.outOfBandId\n      this.connectionTypes = props.connectionTypes ?? []\n      this.previousDids = props.previousDids ?? []\n      this.previousTheirDids = props.previousTheirDids ?? []\n    }\n  }\n\n  public getTags(): DefaultDidCommConnectionTags & CustomDidCommConnectionTags {\n    return {\n      ...this._tags,\n      state: this.state,\n      role: this.role,\n      threadId: this.threadId,\n      mediatorId: this.mediatorId,\n      did: this.did,\n      theirDid: this.theirDid,\n      outOfBandId: this.outOfBandId,\n      invitationDid: this.invitationDid,\n      connectionTypes: this.connectionTypes,\n      previousDids: this.previousDids,\n      previousTheirDids: this.previousTheirDids,\n    }\n  }\n\n  public get isRequester() {\n    return this.role === DidCommDidExchangeRole.Requester\n  }\n\n  public get rfc0160State() {\n    return rfc0160StateFromDidExchangeState(this.state)\n  }\n\n  public get isReady() {\n    return this.state && [DidCommDidExchangeState.Completed, DidCommDidExchangeState.ResponseSent].includes(this.state)\n  }\n\n  public assertReady() {\n    if (!this.isReady) {\n      throw new CredoError(\n        `Connection record is not ready to be used. Expected ${DidCommDidExchangeState.ResponseSent}, ${DidCommDidExchangeState.ResponseReceived} or ${DidCommDidExchangeState.Completed}, found invalid state ${this.state}`\n      )\n    }\n  }\n\n  public assertState(expectedStates: DidCommDidExchangeState | DidCommDidExchangeState[]) {\n    if (!Array.isArray(expectedStates)) {\n      expectedStates = [expectedStates]\n    }\n\n    if (!expectedStates.includes(this.state)) {\n      throw new CredoError(\n        `Connection record is in invalid state ${this.state}. Valid states are: ${expectedStates.join(', ')}.`\n      )\n    }\n  }\n\n  public assertRole(expectedRole: DidCommDidExchangeRole) {\n    if (this.role !== expectedRole) {\n      throw new CredoError(`Connection record has invalid role ${this.role}. Expected role ${expectedRole}.`)\n    }\n  }\n}\n"],"mappings":";;;;;;;;;;;;AAkDA,IAAa,0BAAb,MAAa,gCAAgC,WAI3C;CA0CA,AAAO,YAAY,OAAqC;AACtD,SAAO;OAXF,kBAA4B,EAAE;OAC9B,eAAyB,EAAE;OAC3B,oBAA8B,EAAE;OAGvB,OAAO,wBAAwB;OAE/B,aAAa,wBAAwB;AAMnD,MAAI,OAAO;AACT,QAAK,KAAK,MAAM,MAAM,MAAM,MAAM;AAClC,QAAK,YAAY,MAAM,6BAAa,IAAI,MAAM;AAC9C,QAAK,MAAM,MAAM;AACjB,QAAK,gBAAgB,MAAM;AAC3B,QAAK,WAAW,MAAM;AACtB,QAAK,aAAa,MAAM;AACxB,QAAK,QAAQ,MAAM;AACnB,QAAK,OAAO,MAAM;AAClB,QAAK,QAAQ,MAAM;AACnB,QAAK,uBAAuB,MAAM;AAClC,QAAK,QAAQ,MAAM,QAAQ,EAAE;AAC7B,QAAK,WAAW,MAAM;AACtB,QAAK,WAAW,MAAM;AACtB,QAAK,aAAa,MAAM;AACxB,QAAK,eAAe,MAAM;AAC1B,QAAK,WAAW,MAAM;AACtB,QAAK,cAAc,MAAM;AACzB,QAAK,kBAAkB,MAAM,mBAAmB,EAAE;AAClD,QAAK,eAAe,MAAM,gBAAgB,EAAE;AAC5C,QAAK,oBAAoB,MAAM,qBAAqB,EAAE;;;CAI1D,AAAO,UAAsE;AAC3E,SAAO;GACL,GAAG,KAAK;GACR,OAAO,KAAK;GACZ,MAAM,KAAK;GACX,UAAU,KAAK;GACf,YAAY,KAAK;GACjB,KAAK,KAAK;GACV,UAAU,KAAK;GACf,aAAa,KAAK;GAClB,eAAe,KAAK;GACpB,iBAAiB,KAAK;GACtB,cAAc,KAAK;GACnB,mBAAmB,KAAK;GACzB;;CAGH,IAAW,cAAc;AACvB,SAAO,KAAK,SAAS,uBAAuB;;CAG9C,IAAW,eAAe;AACxB,SAAO,iCAAiC,KAAK,MAAM;;CAGrD,IAAW,UAAU;AACnB,SAAO,KAAK,SAAS,CAAC,wBAAwB,WAAW,wBAAwB,aAAa,CAAC,SAAS,KAAK,MAAM;;CAGrH,AAAO,cAAc;AACnB,MAAI,CAAC,KAAK,QACR,OAAM,IAAI,WACR,uDAAuD,wBAAwB,aAAa,IAAI,wBAAwB,iBAAiB,MAAM,wBAAwB,UAAU,wBAAwB,KAAK,QAC/M;;CAIL,AAAO,YAAY,gBAAqE;AACtF,MAAI,CAAC,MAAM,QAAQ,eAAe,CAChC,kBAAiB,CAAC,eAAe;AAGnC,MAAI,CAAC,eAAe,SAAS,KAAK,MAAM,CACtC,OAAM,IAAI,WACR,yCAAyC,KAAK,MAAM,sBAAsB,eAAe,KAAK,KAAK,CAAC,GACrG;;CAIL,AAAO,WAAW,cAAsC;AACtD,MAAI,KAAK,SAAS,aAChB,OAAM,IAAI,WAAW,sCAAsC,KAAK,KAAK,kBAAkB,aAAa,GAAG;;;wBApFpF,OAAO;wBAIP,aAAsB;YApB5C,WACE,EAAE,YAAY;AACb,KAAI,CAAC,SAAS,OAAO,UAAU,YAAY,MAAM,SAAS,KAAK,CAAE,QAAO;AACxE,QAAO,GAAG,MAAM,MAAM,IAAI,CAAC,MAAM,GAAG,GAAG,CAAC,KAAK,IAAI,CAAC;GAGpD,EAAE,aAAa,MAAM,CACtB"}