{"version":3,"file":"DidCommConnectionInvitationMessage.mjs","names":[],"sources":["../../../../src/modules/connections/messages/DidCommConnectionInvitationMessage.ts"],"sourcesContent":["import { CredoError, JsonEncoder, JsonTransformer } from '@credo-ts/core'\nimport { Transform } from 'class-transformer'\nimport { ArrayNotEmpty, IsArray, IsOptional, IsString, IsUrl, ValidateIf } from 'class-validator'\nimport queryString from 'query-string'\nimport { DidCommMessage } from '../../../DidCommMessage'\nimport type { DidCommAttachment } from '../../../decorators/attachment/DidCommAttachment'\nimport { IsValidMessageType, parseMessageType, replaceLegacyDidSovPrefix } from '../../../util/messageType'\n\nexport interface BaseInvitationOptions {\n  id?: string\n  label: string\n  imageUrl?: string\n  appendedAttachments?: DidCommAttachment[]\n}\n\nexport interface InlineInvitationOptions {\n  recipientKeys: string[]\n  serviceEndpoint: string\n  routingKeys?: string[]\n}\n\nexport interface DIDInvitationOptions {\n  did: string\n}\n\nexport type DidCommConnectionInvitationMessageOptions = BaseInvitationOptions &\n  (DIDInvitationOptions | InlineInvitationOptions)\n\n/**\n * Message to invite another agent to create a connection\n *\n * @see https://github.com/hyperledger/aries-rfcs/blob/master/features/0160-connection-protocol/README.md#0-invitation-to-connect\n */\nexport class DidCommConnectionInvitationMessage extends DidCommMessage {\n  public readonly allowDidSovPrefix = true\n\n  /**\n   * Create new DidCommConnectionInvitationMessage instance.\n   * @param options\n   */\n  public constructor(options: DidCommConnectionInvitationMessageOptions) {\n    super()\n\n    if (options) {\n      this.id = options.id || this.generateId()\n      this.label = options.label\n      this.imageUrl = options.imageUrl\n      this.appendedAttachments = options.appendedAttachments\n\n      if (isDidInvitation(options)) {\n        this.did = options.did\n      } else {\n        this.recipientKeys = options.recipientKeys\n        this.serviceEndpoint = options.serviceEndpoint\n        this.routingKeys = options.routingKeys\n      }\n\n      // @ts-expect-error\n      if (options.did && (options.recipientKeys || options.routingKeys || options.serviceEndpoint)) {\n        throw new CredoError(\n          'either the did or the recipientKeys/serviceEndpoint/routingKeys must be set, but not both'\n        )\n      }\n    }\n  }\n\n  @IsValidMessageType(DidCommConnectionInvitationMessage.type)\n  @Transform(({ value }) => replaceLegacyDidSovPrefix(value), {\n    toClassOnly: true,\n  })\n  public readonly type = DidCommConnectionInvitationMessage.type.messageTypeUri\n  public static readonly type = parseMessageType('https://didcomm.org/connections/1.0/invitation')\n\n  @IsString()\n  public label!: string\n\n  @IsString()\n  @ValidateIf((o: DidCommConnectionInvitationMessage) => o.recipientKeys === undefined)\n  public did?: string\n\n  @IsString({\n    each: true,\n  })\n  @IsArray()\n  @ValidateIf((o: DidCommConnectionInvitationMessage) => o.did === undefined)\n  @ArrayNotEmpty()\n  public recipientKeys?: string[]\n\n  @IsString()\n  @ValidateIf((o: DidCommConnectionInvitationMessage) => o.did === undefined)\n  public serviceEndpoint?: string\n\n  @IsString({\n    each: true,\n  })\n  @ValidateIf((o: DidCommConnectionInvitationMessage) => o.did === undefined)\n  @IsOptional()\n  public routingKeys?: string[]\n\n  @IsOptional()\n  @IsUrl()\n  public imageUrl?: string\n\n  /**\n   * Create an invitation url from this instance\n   *\n   * @param domain domain name to use for invitation url\n   * @returns invitation url with base64 encoded invitation\n   */\n  public toUrl({\n    domain,\n    useDidSovPrefixWhereAllowed = false,\n  }: {\n    domain: string\n    useDidSovPrefixWhereAllowed?: boolean\n  }) {\n    const invitationJson = this.toJSON({ useDidSovPrefixWhereAllowed })\n\n    const encodedInvitation = JsonEncoder.toBase64URL(invitationJson)\n    const invitationUrl = `${domain}?c_i=${encodedInvitation}`\n\n    return invitationUrl\n  }\n\n  /**\n   * Create a `DidCommConnectionInvitationMessage` instance from the `c_i` or `d_m` parameter of an URL\n   *\n   * @param invitationUrl invitation url containing c_i or d_m parameter\n   *\n   * @throws Error when the url can not be decoded to JSON, or decoded message is not a valid 'DidCommConnectionInvitationMessage'\n   */\n  public static fromUrl(invitationUrl: string) {\n    const parsedUrl = queryString.parseUrl(invitationUrl).query\n    const encodedInvitation = parsedUrl.c_i ?? parsedUrl.d_m\n    if (typeof encodedInvitation === 'string') {\n      const invitationJson = JsonEncoder.fromBase64(encodedInvitation)\n      const invitation = JsonTransformer.fromJSON(invitationJson, DidCommConnectionInvitationMessage)\n\n      return invitation\n    }\n    throw new CredoError('InvitationUrl is invalid. Needs to be encoded with either c_i, d_m, or oob')\n  }\n}\n\n/**\n * Check whether an invitation is a `DIDInvitationData` object\n *\n * @param invitation invitation object\n */\nfunction isDidInvitation(\n  invitation: InlineInvitationOptions | DIDInvitationOptions\n): invitation is DIDInvitationOptions {\n  return (invitation as DIDInvitationOptions).did !== undefined\n}\n"],"mappings":";;;;;;;;;;;;;;;AAiCA,IAAa,qCAAb,MAAa,2CAA2C,eAAe;;;;;CAOrE,AAAO,YAAY,SAAoD;AACrE,SAAO;OAPO,oBAAoB;OAoCpB,OAAO,mCAAmC,KAAK;AA3B7D,MAAI,SAAS;AACX,QAAK,KAAK,QAAQ,MAAM,KAAK,YAAY;AACzC,QAAK,QAAQ,QAAQ;AACrB,QAAK,WAAW,QAAQ;AACxB,QAAK,sBAAsB,QAAQ;AAEnC,OAAI,gBAAgB,QAAQ,CAC1B,MAAK,MAAM,QAAQ;QACd;AACL,SAAK,gBAAgB,QAAQ;AAC7B,SAAK,kBAAkB,QAAQ;AAC/B,SAAK,cAAc,QAAQ;;AAI7B,OAAI,QAAQ,QAAQ,QAAQ,iBAAiB,QAAQ,eAAe,QAAQ,iBAC1E,OAAM,IAAI,WACR,4FACD;;;;;;;;;CAgDP,AAAO,MAAM,EACX,QACA,8BAA8B,SAI7B;EACD,MAAM,iBAAiB,KAAK,OAAO,EAAE,6BAA6B,CAAC;AAKnE,SAFsB,GAAG,OAAO,OADN,YAAY,YAAY,eAAe;;;;;;;;;CAanE,OAAc,QAAQ,eAAuB;EAC3C,MAAM,YAAY,YAAY,SAAS,cAAc,CAAC;EACtD,MAAM,oBAAoB,UAAU,OAAO,UAAU;AACrD,MAAI,OAAO,sBAAsB,UAAU;GACzC,MAAM,iBAAiB,YAAY,WAAW,kBAAkB;AAGhE,UAFmB,gBAAgB,SAAS,gBAAgB,mCAAmC;;AAIjG,QAAM,IAAI,WAAW,6EAA6E;;;mCArE7E,OAAO,iBAAiB,iDAAiD;;CAL/F,mBAAmB,mCAAmC,KAAK;CAC3D,WAAW,EAAE,YAAY,0BAA0B,MAAM,EAAE,EAC1D,aAAa,MACd,CAAC;;;YAID,UAAU;;CAGV,UAAU;CACV,YAAY,MAA0C,EAAE,kBAAkB,OAAU;;;;CAGpF,SAAS,EACR,MAAM,MACP,CAAC;CACD,SAAS;CACT,YAAY,MAA0C,EAAE,QAAQ,OAAU;CAC1E,eAAe;;;;CAGf,UAAU;CACV,YAAY,MAA0C,EAAE,QAAQ,OAAU;;;;CAG1E,SAAS,EACR,MAAM,MACP,CAAC;CACD,YAAY,MAA0C,EAAE,QAAQ,OAAU;CAC1E,YAAY;;;;CAGZ,YAAY;CACZ,OAAO;;;;;;;;AAiDV,SAAS,gBACP,YACoC;AACpC,QAAQ,WAAoC,QAAQ"}