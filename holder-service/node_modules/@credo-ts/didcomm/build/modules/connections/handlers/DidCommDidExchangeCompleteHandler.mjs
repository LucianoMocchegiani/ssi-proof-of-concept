import { DidCommHandshakeProtocol } from "../models/DidCommHandshakeProtocol.mjs";
import "../models/index.mjs";
import { DidCommDidExchangeCompleteMessage } from "../messages/DidCommDidExchangeCompleteMessage.mjs";
import "../messages/index.mjs";
import { CredoError, tryParseDid } from "@credo-ts/core";

//#region src/modules/connections/handlers/DidCommDidExchangeCompleteHandler.ts
var DidCommDidExchangeCompleteHandler = class {
	constructor(didExchangeProtocol, outOfBandService) {
		this.supportedMessages = [DidCommDidExchangeCompleteMessage];
		this.didExchangeProtocol = didExchangeProtocol;
		this.outOfBandService = outOfBandService;
	}
	async handle(messageContext) {
		const { connection: connectionRecord } = messageContext;
		if (!connectionRecord) throw new CredoError("Connection is missing in message context");
		const { protocol } = connectionRecord;
		if (protocol !== DidCommHandshakeProtocol.DidExchange) throw new CredoError(`Connection record protocol is ${protocol} but handler supports only ${DidCommHandshakeProtocol.DidExchange}.`);
		const { message } = messageContext;
		const parentThreadId = message.thread?.parentThreadId;
		if (!parentThreadId) throw new CredoError("Message does not contain pthid attribute");
		const outOfBandRecord = await this.outOfBandService.findByCreatedInvitationId(messageContext.agentContext, parentThreadId, tryParseDid(parentThreadId) ? message.threadId : void 0);
		if (!outOfBandRecord) throw new CredoError(`OutOfBand record for message ID ${message.thread?.parentThreadId} not found!`);
		await this.didExchangeProtocol.processComplete(messageContext, outOfBandRecord);
	}
};

//#endregion
export { DidCommDidExchangeCompleteHandler };
//# sourceMappingURL=DidCommDidExchangeCompleteHandler.mjs.map