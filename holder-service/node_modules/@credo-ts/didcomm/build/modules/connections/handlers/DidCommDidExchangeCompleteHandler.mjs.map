{"version":3,"file":"DidCommDidExchangeCompleteHandler.mjs","names":[],"sources":["../../../../src/modules/connections/handlers/DidCommDidExchangeCompleteHandler.ts"],"sourcesContent":["import { CredoError, tryParseDid } from '@credo-ts/core'\nimport type { DidCommMessageHandler, DidCommMessageHandlerInboundMessage } from '../../../handlers'\nimport type { DidCommOutOfBandService } from '../../oob/DidCommOutOfBandService'\nimport type { DidExchangeProtocol } from '../DidExchangeProtocol'\nimport { DidCommDidExchangeCompleteMessage } from '../messages'\nimport { DidCommHandshakeProtocol } from '../models'\n\nexport class DidCommDidExchangeCompleteHandler implements DidCommMessageHandler {\n  private didExchangeProtocol: DidExchangeProtocol\n  private outOfBandService: DidCommOutOfBandService\n  public supportedMessages = [DidCommDidExchangeCompleteMessage]\n\n  public constructor(didExchangeProtocol: DidExchangeProtocol, outOfBandService: DidCommOutOfBandService) {\n    this.didExchangeProtocol = didExchangeProtocol\n    this.outOfBandService = outOfBandService\n  }\n\n  public async handle(messageContext: DidCommMessageHandlerInboundMessage<DidCommDidExchangeCompleteHandler>) {\n    const { connection: connectionRecord } = messageContext\n\n    if (!connectionRecord) {\n      throw new CredoError('Connection is missing in message context')\n    }\n\n    const { protocol } = connectionRecord\n    if (protocol !== DidCommHandshakeProtocol.DidExchange) {\n      throw new CredoError(\n        `Connection record protocol is ${protocol} but handler supports only ${DidCommHandshakeProtocol.DidExchange}.`\n      )\n    }\n\n    const { message } = messageContext\n    const parentThreadId = message.thread?.parentThreadId\n    if (!parentThreadId) {\n      throw new CredoError('Message does not contain pthid attribute')\n    }\n    const outOfBandRecord = await this.outOfBandService.findByCreatedInvitationId(\n      messageContext.agentContext,\n      parentThreadId,\n      tryParseDid(parentThreadId) ? message.threadId : undefined\n    )\n\n    if (!outOfBandRecord) {\n      throw new CredoError(`OutOfBand record for message ID ${message.thread?.parentThreadId} not found!`)\n    }\n\n    await this.didExchangeProtocol.processComplete(messageContext, outOfBandRecord)\n\n    return undefined\n  }\n}\n"],"mappings":";;;;;;;AAOA,IAAa,oCAAb,MAAgF;CAK9E,AAAO,YAAY,qBAA0C,kBAA2C;OAFjG,oBAAoB,CAAC,kCAAkC;AAG5D,OAAK,sBAAsB;AAC3B,OAAK,mBAAmB;;CAG1B,MAAa,OAAO,gBAAwF;EAC1G,MAAM,EAAE,YAAY,qBAAqB;AAEzC,MAAI,CAAC,iBACH,OAAM,IAAI,WAAW,2CAA2C;EAGlE,MAAM,EAAE,aAAa;AACrB,MAAI,aAAa,yBAAyB,YACxC,OAAM,IAAI,WACR,iCAAiC,SAAS,6BAA6B,yBAAyB,YAAY,GAC7G;EAGH,MAAM,EAAE,YAAY;EACpB,MAAM,iBAAiB,QAAQ,QAAQ;AACvC,MAAI,CAAC,eACH,OAAM,IAAI,WAAW,2CAA2C;EAElE,MAAM,kBAAkB,MAAM,KAAK,iBAAiB,0BAClD,eAAe,cACf,gBACA,YAAY,eAAe,GAAG,QAAQ,WAAW,OAClD;AAED,MAAI,CAAC,gBACH,OAAM,IAAI,WAAW,mCAAmC,QAAQ,QAAQ,eAAe,aAAa;AAGtG,QAAM,KAAK,oBAAoB,gBAAgB,gBAAgB,gBAAgB"}