{"version":3,"file":"DidCommDidExchangeResponseHandler.mjs","names":[],"sources":["../../../../src/modules/connections/handlers/DidCommDidExchangeResponseHandler.ts"],"sourcesContent":["import type { DidResolverService } from '@credo-ts/core'\nimport { CredoError } from '@credo-ts/core'\nimport { ReturnRouteTypes } from '../../../decorators/transport/TransportDecorator'\nimport type { DidCommMessageHandler, DidCommMessageHandlerInboundMessage } from '../../../handlers'\nimport { DidCommOutboundMessageContext } from '../../../models'\nimport type { DidCommOutOfBandService } from '../../oob/DidCommOutOfBandService'\nimport { DidCommOutOfBandState } from '../../oob/domain/DidCommOutOfBandState'\nimport type { DidCommConnectionsModuleConfig, DidExchangeProtocol } from '..'\nimport { DidCommDidExchangeResponseMessage } from '../messages'\nimport { DidCommDidExchangeRole, DidCommHandshakeProtocol } from '../models'\nimport type { DidCommConnectionService } from '../services'\n\nexport class DidCommDidExchangeResponseHandler implements DidCommMessageHandler {\n  private didExchangeProtocol: DidExchangeProtocol\n  private outOfBandService: DidCommOutOfBandService\n  private connectionService: DidCommConnectionService\n  private didResolverService: DidResolverService\n  private connectionsModuleConfig: DidCommConnectionsModuleConfig\n  public supportedMessages = [DidCommDidExchangeResponseMessage]\n\n  public constructor(\n    didExchangeProtocol: DidExchangeProtocol,\n    outOfBandService: DidCommOutOfBandService,\n    connectionService: DidCommConnectionService,\n    didResolverService: DidResolverService,\n    connectionsModuleConfig: DidCommConnectionsModuleConfig\n  ) {\n    this.didExchangeProtocol = didExchangeProtocol\n    this.outOfBandService = outOfBandService\n    this.connectionService = connectionService\n    this.didResolverService = didResolverService\n    this.connectionsModuleConfig = connectionsModuleConfig\n  }\n\n  public async handle(messageContext: DidCommMessageHandlerInboundMessage<DidCommDidExchangeResponseHandler>) {\n    const { agentContext, recipientKey, senderKey, message } = messageContext\n\n    if (!recipientKey || !senderKey) {\n      throw new CredoError('Unable to process connection response without sender key or recipient key')\n    }\n\n    const connectionRecord = await this.connectionService.getByRoleAndThreadId(\n      agentContext,\n      DidCommDidExchangeRole.Requester,\n      message.threadId\n    )\n    if (!connectionRecord) {\n      throw new CredoError(`Connection for thread ID ${message.threadId} not found!`)\n    }\n\n    if (!connectionRecord.did) {\n      throw new CredoError(`Connection record ${connectionRecord.id} has no 'did'`)\n    }\n\n    const ourDidDocument = await this.didResolverService.resolveDidDocument(agentContext, connectionRecord.did)\n    if (!ourDidDocument) {\n      throw new CredoError(`Did document for did ${connectionRecord.did} was not resolved`)\n    }\n\n    // Validate if recipient key is included in recipient keys of the did document resolved by\n    // connection record did\n    if (!ourDidDocument.recipientKeys.find((key) => key.fingerprint === recipientKey.fingerprint)) {\n      throw new CredoError(`Recipient key ${recipientKey.fingerprint} not found in did document recipient keys.`)\n    }\n\n    const { protocol } = connectionRecord\n    if (protocol !== DidCommHandshakeProtocol.DidExchange) {\n      throw new CredoError(\n        `Connection record protocol is ${protocol} but handler supports only ${DidCommHandshakeProtocol.DidExchange}.`\n      )\n    }\n\n    if (!connectionRecord.outOfBandId) {\n      throw new CredoError(`Connection ${connectionRecord.id} does not have outOfBandId!`)\n    }\n\n    const outOfBandRecord = await this.outOfBandService.findById(agentContext, connectionRecord.outOfBandId)\n\n    if (!outOfBandRecord) {\n      throw new CredoError(\n        `OutOfBand record for connection ${connectionRecord.id} with outOfBandId ${connectionRecord.outOfBandId} not found!`\n      )\n    }\n\n    // TODO\n    //\n    // A connection request message is the only case when I can use the connection record found\n    // only based on recipient key without checking that `theirKey` is equal to sender key.\n    //\n    // The question is if we should do it here in this way or rather somewhere else to keep\n    // responsibility of all handlers aligned.\n    //\n    messageContext.connection = connectionRecord\n    const connection = await this.didExchangeProtocol.processResponse(messageContext, outOfBandRecord)\n\n    if (!outOfBandRecord.reusable) {\n      await this.outOfBandService.updateState(agentContext, outOfBandRecord, DidCommOutOfBandState.Done)\n    }\n\n    // TODO: should we only send complete message in case of autoAcceptConnection or always?\n    // In AATH we have a separate step to send the complete. So for now we'll only do it\n    // if auto accept is enabled\n    if (connection.autoAcceptConnection ?? this.connectionsModuleConfig.autoAcceptConnections) {\n      const message = await this.didExchangeProtocol.createComplete(agentContext, connection, outOfBandRecord)\n      // Disable return routing as we don't want to receive a response for this message over the same channel\n      // This has led to long timeouts as not all clients actually close an http socket if there is no response message\n      message.setReturnRouting(ReturnRouteTypes.none)\n\n      return new DidCommOutboundMessageContext(message, { agentContext, connection })\n    }\n  }\n}\n"],"mappings":";;;;;;;;;;;;AAYA,IAAa,oCAAb,MAAgF;CAQ9E,AAAO,YACL,qBACA,kBACA,mBACA,oBACA,yBACA;OARK,oBAAoB,CAAC,kCAAkC;AAS5D,OAAK,sBAAsB;AAC3B,OAAK,mBAAmB;AACxB,OAAK,oBAAoB;AACzB,OAAK,qBAAqB;AAC1B,OAAK,0BAA0B;;CAGjC,MAAa,OAAO,gBAAwF;EAC1G,MAAM,EAAE,cAAc,cAAc,WAAW,YAAY;AAE3D,MAAI,CAAC,gBAAgB,CAAC,UACpB,OAAM,IAAI,WAAW,4EAA4E;EAGnG,MAAM,mBAAmB,MAAM,KAAK,kBAAkB,qBACpD,cACA,uBAAuB,WACvB,QAAQ,SACT;AACD,MAAI,CAAC,iBACH,OAAM,IAAI,WAAW,4BAA4B,QAAQ,SAAS,aAAa;AAGjF,MAAI,CAAC,iBAAiB,IACpB,OAAM,IAAI,WAAW,qBAAqB,iBAAiB,GAAG,eAAe;EAG/E,MAAM,iBAAiB,MAAM,KAAK,mBAAmB,mBAAmB,cAAc,iBAAiB,IAAI;AAC3G,MAAI,CAAC,eACH,OAAM,IAAI,WAAW,wBAAwB,iBAAiB,IAAI,mBAAmB;AAKvF,MAAI,CAAC,eAAe,cAAc,MAAM,QAAQ,IAAI,gBAAgB,aAAa,YAAY,CAC3F,OAAM,IAAI,WAAW,iBAAiB,aAAa,YAAY,4CAA4C;EAG7G,MAAM,EAAE,aAAa;AACrB,MAAI,aAAa,yBAAyB,YACxC,OAAM,IAAI,WACR,iCAAiC,SAAS,6BAA6B,yBAAyB,YAAY,GAC7G;AAGH,MAAI,CAAC,iBAAiB,YACpB,OAAM,IAAI,WAAW,cAAc,iBAAiB,GAAG,6BAA6B;EAGtF,MAAM,kBAAkB,MAAM,KAAK,iBAAiB,SAAS,cAAc,iBAAiB,YAAY;AAExG,MAAI,CAAC,gBACH,OAAM,IAAI,WACR,mCAAmC,iBAAiB,GAAG,oBAAoB,iBAAiB,YAAY,aACzG;AAWH,iBAAe,aAAa;EAC5B,MAAM,aAAa,MAAM,KAAK,oBAAoB,gBAAgB,gBAAgB,gBAAgB;AAElG,MAAI,CAAC,gBAAgB,SACnB,OAAM,KAAK,iBAAiB,YAAY,cAAc,iBAAiB,sBAAsB,KAAK;AAMpG,MAAI,WAAW,wBAAwB,KAAK,wBAAwB,uBAAuB;GACzF,MAAM,UAAU,MAAM,KAAK,oBAAoB,eAAe,cAAc,YAAY,gBAAgB;AAGxG,WAAQ,iBAAiB,iBAAiB,KAAK;AAE/C,UAAO,IAAI,8BAA8B,SAAS;IAAE;IAAc;IAAY,CAAC"}