{"version":3,"file":"DidCommBasicMessageService.mjs","names":[],"sources":["../../../../src/modules/basic-messages/services/DidCommBasicMessageService.ts"],"sourcesContent":["import type { AgentContext, Query, QueryOptions } from '@credo-ts/core'\nimport { EventEmitter, injectable } from '@credo-ts/core'\nimport type { DidCommInboundMessageContext } from '../../../models'\nimport { DidCommConnectionRecord } from '../../connections'\nimport type { DidCommBasicMessageStateChangedEvent } from '../DidCommBasicMessageEvents'\nimport { DidCommBasicMessageEventTypes } from '../DidCommBasicMessageEvents'\nimport { DidCommBasicMessageRole } from '../DidCommBasicMessageRole'\nimport { DidCommBasicMessage } from '../messages'\nimport { DidCommBasicMessageRecord, DidCommBasicMessageRepository } from '../repository'\n\n@injectable()\nexport class DidCommBasicMessageService {\n  private basicMessageRepository: DidCommBasicMessageRepository\n  private eventEmitter: EventEmitter\n\n  public constructor(basicMessageRepository: DidCommBasicMessageRepository, eventEmitter: EventEmitter) {\n    this.basicMessageRepository = basicMessageRepository\n    this.eventEmitter = eventEmitter\n  }\n\n  public async createMessage(\n    agentContext: AgentContext,\n    message: string,\n    connectionRecord: DidCommConnectionRecord,\n    parentThreadId?: string\n  ) {\n    const basicMessage = new DidCommBasicMessage({ content: message })\n\n    // If no parentThreadid is defined, there is no need to explicitly send a thread decorator\n    if (parentThreadId) {\n      basicMessage.setThread({ parentThreadId })\n    }\n\n    const basicMessageRecord = new DidCommBasicMessageRecord({\n      sentTime: basicMessage.sentTime.toISOString(),\n      content: basicMessage.content,\n      connectionId: connectionRecord.id,\n      role: DidCommBasicMessageRole.Sender,\n      threadId: basicMessage.threadId,\n      parentThreadId,\n    })\n\n    await this.basicMessageRepository.save(agentContext, basicMessageRecord)\n    this.emitStateChangedEvent(agentContext, basicMessageRecord, basicMessage)\n\n    return { message: basicMessage, record: basicMessageRecord }\n  }\n\n  /**\n   * @todo use connection from message context\n   */\n  public async save(\n    { message, agentContext }: DidCommInboundMessageContext<DidCommBasicMessage>,\n    connection: DidCommConnectionRecord\n  ) {\n    const basicMessageRecord = new DidCommBasicMessageRecord({\n      sentTime: message.sentTime.toISOString(),\n      content: message.content,\n      connectionId: connection.id,\n      role: DidCommBasicMessageRole.Receiver,\n      threadId: message.threadId,\n      parentThreadId: message.thread?.parentThreadId,\n    })\n\n    await this.basicMessageRepository.save(agentContext, basicMessageRecord)\n    this.emitStateChangedEvent(agentContext, basicMessageRecord, message)\n  }\n\n  private emitStateChangedEvent(\n    agentContext: AgentContext,\n    basicMessageRecord: DidCommBasicMessageRecord,\n    basicMessage: DidCommBasicMessage\n  ) {\n    this.eventEmitter.emit<DidCommBasicMessageStateChangedEvent>(agentContext, {\n      type: DidCommBasicMessageEventTypes.DidCommBasicMessageStateChanged,\n      payload: { message: basicMessage, basicMessageRecord: basicMessageRecord.clone() },\n    })\n  }\n\n  public async findAllByQuery(\n    agentContext: AgentContext,\n    query: Query<DidCommBasicMessageRecord>,\n    queryOptions?: QueryOptions\n  ) {\n    return this.basicMessageRepository.findByQuery(agentContext, query, queryOptions)\n  }\n\n  public async getById(agentContext: AgentContext, basicMessageRecordId: string) {\n    return this.basicMessageRepository.getById(agentContext, basicMessageRecordId)\n  }\n\n  public async getByThreadId(agentContext: AgentContext, threadId: string) {\n    return this.basicMessageRepository.getSingleByQuery(agentContext, { threadId })\n  }\n\n  public async findAllByParentThreadId(agentContext: AgentContext, parentThreadId: string) {\n    return this.basicMessageRepository.findByQuery(agentContext, { parentThreadId })\n  }\n\n  public async deleteById(agentContext: AgentContext, basicMessageRecordId: string) {\n    const basicMessageRecord = await this.getById(agentContext, basicMessageRecordId)\n    return this.basicMessageRepository.delete(agentContext, basicMessageRecord)\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;AAWO,uCAAM,2BAA2B;CAItC,AAAO,YAAY,wBAAuD,cAA4B;AACpG,OAAK,yBAAyB;AAC9B,OAAK,eAAe;;CAGtB,MAAa,cACX,cACA,SACA,kBACA,gBACA;EACA,MAAM,eAAe,IAAI,oBAAoB,EAAE,SAAS,SAAS,CAAC;AAGlE,MAAI,eACF,cAAa,UAAU,EAAE,gBAAgB,CAAC;EAG5C,MAAM,qBAAqB,IAAI,0BAA0B;GACvD,UAAU,aAAa,SAAS,aAAa;GAC7C,SAAS,aAAa;GACtB,cAAc,iBAAiB;GAC/B,MAAM,wBAAwB;GAC9B,UAAU,aAAa;GACvB;GACD,CAAC;AAEF,QAAM,KAAK,uBAAuB,KAAK,cAAc,mBAAmB;AACxE,OAAK,sBAAsB,cAAc,oBAAoB,aAAa;AAE1E,SAAO;GAAE,SAAS;GAAc,QAAQ;GAAoB;;;;;CAM9D,MAAa,KACX,EAAE,SAAS,gBACX,YACA;EACA,MAAM,qBAAqB,IAAI,0BAA0B;GACvD,UAAU,QAAQ,SAAS,aAAa;GACxC,SAAS,QAAQ;GACjB,cAAc,WAAW;GACzB,MAAM,wBAAwB;GAC9B,UAAU,QAAQ;GAClB,gBAAgB,QAAQ,QAAQ;GACjC,CAAC;AAEF,QAAM,KAAK,uBAAuB,KAAK,cAAc,mBAAmB;AACxE,OAAK,sBAAsB,cAAc,oBAAoB,QAAQ;;CAGvE,AAAQ,sBACN,cACA,oBACA,cACA;AACA,OAAK,aAAa,KAA2C,cAAc;GACzE,MAAM,8BAA8B;GACpC,SAAS;IAAE,SAAS;IAAc,oBAAoB,mBAAmB,OAAO;IAAE;GACnF,CAAC;;CAGJ,MAAa,eACX,cACA,OACA,cACA;AACA,SAAO,KAAK,uBAAuB,YAAY,cAAc,OAAO,aAAa;;CAGnF,MAAa,QAAQ,cAA4B,sBAA8B;AAC7E,SAAO,KAAK,uBAAuB,QAAQ,cAAc,qBAAqB;;CAGhF,MAAa,cAAc,cAA4B,UAAkB;AACvE,SAAO,KAAK,uBAAuB,iBAAiB,cAAc,EAAE,UAAU,CAAC;;CAGjF,MAAa,wBAAwB,cAA4B,gBAAwB;AACvF,SAAO,KAAK,uBAAuB,YAAY,cAAc,EAAE,gBAAgB,CAAC;;CAGlF,MAAa,WAAW,cAA4B,sBAA8B;EAChF,MAAM,qBAAqB,MAAM,KAAK,QAAQ,cAAc,qBAAqB;AACjF,SAAO,KAAK,uBAAuB,OAAO,cAAc,mBAAmB;;;yCA3F9E,YAAY"}