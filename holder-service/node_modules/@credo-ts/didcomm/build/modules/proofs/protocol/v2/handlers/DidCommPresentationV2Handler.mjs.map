{"version":3,"file":"DidCommPresentationV2Handler.mjs","names":[],"sources":["../../../../../../src/modules/proofs/protocol/v2/handlers/DidCommPresentationV2Handler.ts"],"sourcesContent":["import { getOutboundDidCommMessageContext } from '../../../../../getDidCommOutboundMessageContext'\nimport type { DidCommMessageHandler, DidCommMessageHandlerInboundMessage } from '../../../../../handlers'\nimport { DidCommMessageRepository, DidCommMessageRole } from '../../../../../repository'\nimport type { DidCommProofExchangeRecord } from '../../../repository'\nimport type { DidCommProofV2Protocol } from '../DidCommProofV2Protocol'\nimport { DidCommPresentationV2Message, DidCommRequestPresentationV2Message } from '../messages'\n\nexport class DidCommPresentationV2Handler implements DidCommMessageHandler {\n  private proofProtocol: DidCommProofV2Protocol\n  public supportedMessages = [DidCommPresentationV2Message]\n\n  public constructor(proofProtocol: DidCommProofV2Protocol) {\n    this.proofProtocol = proofProtocol\n  }\n\n  public async handle(messageContext: DidCommMessageHandlerInboundMessage<DidCommPresentationV2Handler>) {\n    const proofRecord = await this.proofProtocol.processPresentation(messageContext)\n\n    const shouldAutoRespond = await this.proofProtocol.shouldAutoRespondToPresentation(messageContext.agentContext, {\n      proofRecord,\n      presentationMessage: messageContext.message,\n    })\n\n    if (shouldAutoRespond) {\n      return await this.acceptPresentation(proofRecord, messageContext)\n    }\n  }\n\n  private async acceptPresentation(\n    proofRecord: DidCommProofExchangeRecord,\n    messageContext: DidCommMessageHandlerInboundMessage<DidCommPresentationV2Handler>\n  ) {\n    messageContext.agentContext.config.logger.info('Automatically sending acknowledgement with autoAccept')\n\n    const { message } = await this.proofProtocol.acceptPresentation(messageContext.agentContext, {\n      proofRecord,\n    })\n\n    const didCommMessageRepository = messageContext.agentContext.dependencyManager.resolve(DidCommMessageRepository)\n    const requestMessage = await didCommMessageRepository.getAgentMessage(messageContext.agentContext, {\n      associatedRecordId: proofRecord.id,\n      messageClass: DidCommRequestPresentationV2Message,\n      role: DidCommMessageRole.Sender,\n    })\n\n    return getOutboundDidCommMessageContext(messageContext.agentContext, {\n      connectionRecord: messageContext.connection,\n      message,\n      associatedRecord: proofRecord,\n      lastReceivedMessage: messageContext.message,\n      lastSentMessage: requestMessage,\n    })\n  }\n}\n"],"mappings":";;;;;;;;;AAOA,IAAa,+BAAb,MAA2E;CAIzE,AAAO,YAAY,eAAuC;OAFnD,oBAAoB,CAAC,6BAA6B;AAGvD,OAAK,gBAAgB;;CAGvB,MAAa,OAAO,gBAAmF;EACrG,MAAM,cAAc,MAAM,KAAK,cAAc,oBAAoB,eAAe;AAOhF,MAL0B,MAAM,KAAK,cAAc,gCAAgC,eAAe,cAAc;GAC9G;GACA,qBAAqB,eAAe;GACrC,CAAC,CAGA,QAAO,MAAM,KAAK,mBAAmB,aAAa,eAAe;;CAIrE,MAAc,mBACZ,aACA,gBACA;AACA,iBAAe,aAAa,OAAO,OAAO,KAAK,wDAAwD;EAEvG,MAAM,EAAE,YAAY,MAAM,KAAK,cAAc,mBAAmB,eAAe,cAAc,EAC3F,aACD,CAAC;EAGF,MAAM,iBAAiB,MADU,eAAe,aAAa,kBAAkB,QAAQ,yBAAyB,CAC1D,gBAAgB,eAAe,cAAc;GACjG,oBAAoB,YAAY;GAChC,cAAc;GACd,MAAM,mBAAmB;GAC1B,CAAC;AAEF,SAAO,iCAAiC,eAAe,cAAc;GACnE,kBAAkB,eAAe;GACjC;GACA,kBAAkB;GAClB,qBAAqB,eAAe;GACpC,iBAAiB;GAClB,CAAC"}