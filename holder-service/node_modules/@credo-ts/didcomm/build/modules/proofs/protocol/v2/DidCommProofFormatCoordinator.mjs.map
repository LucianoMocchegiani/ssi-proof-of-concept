{"version":3,"file":"DidCommProofFormatCoordinator.mjs","names":[],"sources":["../../../../../src/modules/proofs/protocol/v2/DidCommProofFormatCoordinator.ts"],"sourcesContent":["import type { AgentContext } from '@credo-ts/core'\nimport { CredoError } from '@credo-ts/core'\nimport type { DidCommAttachment } from '../../../../decorators/attachment/DidCommAttachment'\nimport { DidCommMessageRepository, DidCommMessageRole } from '../../../../repository'\nimport type {\n  DidCommProofFormatCredentialForRequestPayload,\n  DidCommProofFormatPayload,\n  DidCommProofFormatService,\n  ExtractProofFormats,\n} from '../../formats'\nimport type { DidCommProofFormatSpec } from '../../models/DidCommProofFormatSpec'\nimport type { DidCommProofExchangeRecord } from '../../repository'\n\nimport {\n  DidCommPresentationV2Message,\n  DidCommProposePresentationV2Message,\n  DidCommRequestPresentationV2Message,\n} from './messages'\n\nexport class DidCommProofFormatCoordinator<PFs extends DidCommProofFormatService[]> {\n  /**\n   * Create a {@link DidCommProposePresentationV2Message}.\n   *\n   * @param options\n   * @returns The created {@link DidCommProposePresentationV2Message}\n   *\n   */\n  public async createProposal(\n    agentContext: AgentContext,\n    {\n      proofFormats,\n      formatServices,\n      proofRecord,\n      comment,\n      goalCode,\n      goal,\n    }: {\n      formatServices: DidCommProofFormatService[]\n      proofFormats: DidCommProofFormatPayload<ExtractProofFormats<PFs>, 'createProposal'>\n      proofRecord: DidCommProofExchangeRecord\n      comment?: string\n      goalCode?: string\n      goal?: string\n    }\n  ): Promise<DidCommProposePresentationV2Message> {\n    const didCommMessageRepository = agentContext.dependencyManager.resolve(DidCommMessageRepository)\n\n    // create message. there are two arrays in each message, one for formats the other for attachments\n    const formats: DidCommProofFormatSpec[] = []\n    const proposalAttachments: DidCommAttachment[] = []\n\n    for (const formatService of formatServices) {\n      const { format, attachment } = await formatService.createProposal(agentContext, {\n        proofFormats,\n        proofRecord,\n      })\n\n      proposalAttachments.push(attachment)\n      formats.push(format)\n    }\n\n    const message = new DidCommProposePresentationV2Message({\n      id: proofRecord.threadId,\n      formats,\n      proposalAttachments,\n      comment: comment,\n      goalCode,\n      goal,\n    })\n\n    message.setThread({ threadId: proofRecord.threadId, parentThreadId: proofRecord.parentThreadId })\n\n    await didCommMessageRepository.saveOrUpdateAgentMessage(agentContext, {\n      agentMessage: message,\n      role: DidCommMessageRole.Sender,\n      associatedRecordId: proofRecord.id,\n    })\n\n    return message\n  }\n\n  public async processProposal(\n    agentContext: AgentContext,\n    {\n      proofRecord,\n      message,\n      formatServices,\n    }: {\n      proofRecord: DidCommProofExchangeRecord\n      message: DidCommProposePresentationV2Message\n      formatServices: DidCommProofFormatService[]\n    }\n  ) {\n    const didCommMessageRepository = agentContext.dependencyManager.resolve(DidCommMessageRepository)\n\n    for (const formatService of formatServices) {\n      const attachment = this.getAttachmentForService(formatService, message.formats, message.proposalAttachments)\n\n      await formatService.processProposal(agentContext, {\n        attachment,\n        proofRecord,\n      })\n    }\n\n    await didCommMessageRepository.saveOrUpdateAgentMessage(agentContext, {\n      agentMessage: message,\n      role: DidCommMessageRole.Receiver,\n      associatedRecordId: proofRecord.id,\n    })\n  }\n\n  public async acceptProposal(\n    agentContext: AgentContext,\n    {\n      proofRecord,\n      proofFormats,\n      formatServices,\n      comment,\n      goalCode,\n      goal,\n      presentMultiple,\n      willConfirm,\n    }: {\n      proofRecord: DidCommProofExchangeRecord\n      proofFormats?: DidCommProofFormatPayload<ExtractProofFormats<PFs>, 'acceptProposal'>\n      formatServices: DidCommProofFormatService[]\n      comment?: string\n      goalCode?: string\n      goal?: string\n      presentMultiple?: boolean\n      willConfirm?: boolean\n    }\n  ) {\n    const didCommMessageRepository = agentContext.dependencyManager.resolve(DidCommMessageRepository)\n\n    // create message. there are two arrays in each message, one for formats the other for attachments\n    const formats: DidCommProofFormatSpec[] = []\n    const requestAttachments: DidCommAttachment[] = []\n\n    const proposalMessage = await didCommMessageRepository.getAgentMessage(agentContext, {\n      associatedRecordId: proofRecord.id,\n      messageClass: DidCommProposePresentationV2Message,\n      role: DidCommMessageRole.Receiver,\n    })\n\n    for (const formatService of formatServices) {\n      const proposalAttachment = this.getAttachmentForService(\n        formatService,\n        proposalMessage.formats,\n        proposalMessage.proposalAttachments\n      )\n\n      const { attachment, format } = await formatService.acceptProposal(agentContext, {\n        proofRecord,\n        proofFormats,\n        proposalAttachment,\n      })\n\n      requestAttachments.push(attachment)\n      formats.push(format)\n    }\n\n    const message = new DidCommRequestPresentationV2Message({\n      formats,\n      requestAttachments,\n      comment,\n      goalCode,\n      goal,\n      presentMultiple,\n      willConfirm,\n    })\n\n    message.setThread({ threadId: proofRecord.threadId, parentThreadId: proofRecord.parentThreadId })\n\n    await didCommMessageRepository.saveOrUpdateAgentMessage(agentContext, {\n      agentMessage: message,\n      associatedRecordId: proofRecord.id,\n      role: DidCommMessageRole.Sender,\n    })\n\n    return message\n  }\n\n  /**\n   * Create a {@link DidCommRequestPresentationV2Message}.\n   *\n   * @param options\n   * @returns The created {@link DidCommRequestPresentationV2Message}\n   *\n   */\n  public async createRequest(\n    agentContext: AgentContext,\n    {\n      proofFormats,\n      formatServices,\n      proofRecord,\n      comment,\n      goalCode,\n      goal,\n      presentMultiple,\n      willConfirm,\n    }: {\n      formatServices: DidCommProofFormatService[]\n      proofFormats: DidCommProofFormatPayload<ExtractProofFormats<PFs>, 'createRequest'>\n      proofRecord: DidCommProofExchangeRecord\n      comment?: string\n      goalCode?: string\n      goal?: string\n      presentMultiple?: boolean\n      willConfirm?: boolean\n    }\n  ): Promise<DidCommRequestPresentationV2Message> {\n    const didCommMessageRepository = agentContext.dependencyManager.resolve(DidCommMessageRepository)\n\n    // create message. there are two arrays in each message, one for formats the other for attachments\n    const formats: DidCommProofFormatSpec[] = []\n    const requestAttachments: DidCommAttachment[] = []\n\n    for (const formatService of formatServices) {\n      const { format, attachment } = await formatService.createRequest(agentContext, {\n        proofFormats,\n        proofRecord,\n      })\n\n      requestAttachments.push(attachment)\n      formats.push(format)\n    }\n\n    const message = new DidCommRequestPresentationV2Message({\n      formats,\n      comment,\n      requestAttachments,\n      goalCode,\n      goal,\n      presentMultiple,\n      willConfirm,\n    })\n\n    message.setThread({ threadId: proofRecord.threadId, parentThreadId: proofRecord.parentThreadId })\n\n    await didCommMessageRepository.saveOrUpdateAgentMessage(agentContext, {\n      agentMessage: message,\n      role: DidCommMessageRole.Sender,\n      associatedRecordId: proofRecord.id,\n    })\n\n    return message\n  }\n\n  public async processRequest(\n    agentContext: AgentContext,\n    {\n      proofRecord,\n      message,\n      formatServices,\n    }: {\n      proofRecord: DidCommProofExchangeRecord\n      message: DidCommRequestPresentationV2Message\n      formatServices: DidCommProofFormatService[]\n    }\n  ) {\n    const didCommMessageRepository = agentContext.dependencyManager.resolve(DidCommMessageRepository)\n\n    for (const formatService of formatServices) {\n      const attachment = this.getAttachmentForService(formatService, message.formats, message.requestAttachments)\n\n      await formatService.processRequest(agentContext, {\n        attachment,\n        proofRecord,\n      })\n    }\n\n    await didCommMessageRepository.saveOrUpdateAgentMessage(agentContext, {\n      agentMessage: message,\n      role: DidCommMessageRole.Receiver,\n      associatedRecordId: proofRecord.id,\n    })\n  }\n\n  public async acceptRequest(\n    agentContext: AgentContext,\n    {\n      proofRecord,\n      proofFormats,\n      formatServices,\n      comment,\n      lastPresentation,\n      goalCode,\n      goal,\n    }: {\n      proofRecord: DidCommProofExchangeRecord\n      proofFormats?: DidCommProofFormatPayload<ExtractProofFormats<PFs>, 'acceptRequest'>\n      formatServices: DidCommProofFormatService[]\n      comment?: string\n      lastPresentation?: boolean\n      goalCode?: string\n      goal?: string\n    }\n  ) {\n    const didCommMessageRepository = agentContext.dependencyManager.resolve(DidCommMessageRepository)\n\n    const requestMessage = await didCommMessageRepository.getAgentMessage(agentContext, {\n      associatedRecordId: proofRecord.id,\n      messageClass: DidCommRequestPresentationV2Message,\n      role: DidCommMessageRole.Receiver,\n    })\n\n    const proposalMessage = await didCommMessageRepository.findAgentMessage(agentContext, {\n      associatedRecordId: proofRecord.id,\n      messageClass: DidCommProposePresentationV2Message,\n      role: DidCommMessageRole.Receiver,\n    })\n\n    // create message. there are two arrays in each message, one for formats the other for attachments\n    const formats: DidCommProofFormatSpec[] = []\n    const presentationAttachments: DidCommAttachment[] = []\n\n    for (const formatService of formatServices) {\n      const requestAttachment = this.getAttachmentForService(\n        formatService,\n        requestMessage.formats,\n        requestMessage.requestAttachments\n      )\n\n      const proposalAttachment = proposalMessage\n        ? this.getAttachmentForService(formatService, proposalMessage.formats, proposalMessage.proposalAttachments)\n        : undefined\n\n      const { attachment, format } = await formatService.acceptRequest(agentContext, {\n        requestAttachment,\n        proposalAttachment,\n        proofRecord,\n        proofFormats,\n      })\n\n      presentationAttachments.push(attachment)\n      formats.push(format)\n    }\n\n    const message = new DidCommPresentationV2Message({\n      formats,\n      presentationAttachments,\n      comment,\n      lastPresentation,\n      goalCode,\n      goal,\n    })\n\n    message.setThread({ threadId: proofRecord.threadId, parentThreadId: proofRecord.parentThreadId })\n    message.setPleaseAck()\n\n    await didCommMessageRepository.saveOrUpdateAgentMessage(agentContext, {\n      agentMessage: message,\n      associatedRecordId: proofRecord.id,\n      role: DidCommMessageRole.Sender,\n    })\n\n    return message\n  }\n\n  public async getCredentialsForRequest(\n    agentContext: AgentContext,\n    {\n      proofRecord,\n      proofFormats,\n      formatServices,\n    }: {\n      proofRecord: DidCommProofExchangeRecord\n      proofFormats?: DidCommProofFormatCredentialForRequestPayload<\n        ExtractProofFormats<PFs>,\n        'getCredentialsForRequest',\n        'input'\n      >\n      formatServices: DidCommProofFormatService[]\n    }\n  ): Promise<\n    DidCommProofFormatCredentialForRequestPayload<ExtractProofFormats<PFs>, 'getCredentialsForRequest', 'output'>\n  > {\n    const didCommMessageRepository = agentContext.dependencyManager.resolve(DidCommMessageRepository)\n\n    const requestMessage = await didCommMessageRepository.getAgentMessage(agentContext, {\n      associatedRecordId: proofRecord.id,\n      messageClass: DidCommRequestPresentationV2Message,\n      role: DidCommMessageRole.Receiver,\n    })\n\n    const proposalMessage = await didCommMessageRepository.findAgentMessage(agentContext, {\n      associatedRecordId: proofRecord.id,\n      messageClass: DidCommProposePresentationV2Message,\n      role: DidCommMessageRole.Receiver,\n    })\n\n    const credentialsForRequest: Record<string, unknown> = {}\n\n    for (const formatService of formatServices) {\n      const requestAttachment = this.getAttachmentForService(\n        formatService,\n        requestMessage.formats,\n        requestMessage.requestAttachments\n      )\n\n      const proposalAttachment = proposalMessage\n        ? this.getAttachmentForService(formatService, proposalMessage.formats, proposalMessage.proposalAttachments)\n        : undefined\n\n      const credentialsForFormat = await formatService.getCredentialsForRequest(agentContext, {\n        requestAttachment,\n        proposalAttachment,\n        proofRecord,\n        proofFormats,\n      })\n\n      credentialsForRequest[formatService.formatKey] = credentialsForFormat\n    }\n\n    return credentialsForRequest as DidCommProofFormatCredentialForRequestPayload<\n      ExtractProofFormats<PFs>,\n      'getCredentialsForRequest',\n      'output'\n    >\n  }\n\n  public async selectCredentialsForRequest(\n    agentContext: AgentContext,\n    {\n      proofRecord,\n      proofFormats,\n      formatServices,\n    }: {\n      proofRecord: DidCommProofExchangeRecord\n      proofFormats?: DidCommProofFormatCredentialForRequestPayload<\n        ExtractProofFormats<PFs>,\n        'selectCredentialsForRequest',\n        'input'\n      >\n      formatServices: DidCommProofFormatService[]\n    }\n  ): Promise<\n    DidCommProofFormatCredentialForRequestPayload<ExtractProofFormats<PFs>, 'selectCredentialsForRequest', 'output'>\n  > {\n    const didCommMessageRepository = agentContext.dependencyManager.resolve(DidCommMessageRepository)\n\n    const requestMessage = await didCommMessageRepository.getAgentMessage(agentContext, {\n      associatedRecordId: proofRecord.id,\n      messageClass: DidCommRequestPresentationV2Message,\n      role: DidCommMessageRole.Receiver,\n    })\n\n    const proposalMessage = await didCommMessageRepository.findAgentMessage(agentContext, {\n      associatedRecordId: proofRecord.id,\n      messageClass: DidCommProposePresentationV2Message,\n      role: DidCommMessageRole.Receiver,\n    })\n\n    const credentialsForRequest: Record<string, unknown> = {}\n\n    for (const formatService of formatServices) {\n      const requestAttachment = this.getAttachmentForService(\n        formatService,\n        requestMessage.formats,\n        requestMessage.requestAttachments\n      )\n\n      const proposalAttachment = proposalMessage\n        ? this.getAttachmentForService(formatService, proposalMessage.formats, proposalMessage.proposalAttachments)\n        : undefined\n\n      const credentialsForFormat = await formatService.selectCredentialsForRequest(agentContext, {\n        requestAttachment,\n        proposalAttachment,\n        proofRecord,\n        proofFormats,\n      })\n\n      credentialsForRequest[formatService.formatKey] = credentialsForFormat\n    }\n\n    return credentialsForRequest as DidCommProofFormatCredentialForRequestPayload<\n      ExtractProofFormats<PFs>,\n      'selectCredentialsForRequest',\n      'output'\n    >\n  }\n\n  public async processPresentation(\n    agentContext: AgentContext,\n    {\n      proofRecord,\n      message,\n      requestMessage,\n      formatServices,\n    }: {\n      proofRecord: DidCommProofExchangeRecord\n      message: DidCommPresentationV2Message\n      requestMessage: DidCommRequestPresentationV2Message\n      formatServices: DidCommProofFormatService[]\n    }\n  ): Promise<{ isValid: true; message: undefined } | { isValid: false; message: string }> {\n    const didCommMessageRepository = agentContext.dependencyManager.resolve(DidCommMessageRepository)\n\n    const formatVerificationResults: boolean[] = []\n\n    for (const formatService of formatServices) {\n      const attachment = this.getAttachmentForService(formatService, message.formats, message.presentationAttachments)\n      const requestAttachment = this.getAttachmentForService(\n        formatService,\n        requestMessage.formats,\n        requestMessage.requestAttachments\n      )\n\n      try {\n        // TODO: this should return a more complex object explaining why it is invalid\n        const isValid = await formatService.processPresentation(agentContext, {\n          attachment,\n          requestAttachment,\n          proofRecord,\n        })\n\n        formatVerificationResults.push(isValid)\n      } catch (error) {\n        return {\n          message: error.message,\n          isValid: false,\n        }\n      }\n    }\n\n    await didCommMessageRepository.saveOrUpdateAgentMessage(agentContext, {\n      agentMessage: message,\n      role: DidCommMessageRole.Receiver,\n      associatedRecordId: proofRecord.id,\n    })\n\n    const isValid = formatVerificationResults.every((isValid) => isValid === true)\n\n    if (isValid) {\n      return {\n        isValid,\n        message: undefined,\n      }\n    }\n    return {\n      isValid,\n      message: 'Not all presentations are valid',\n    }\n  }\n\n  public getAttachmentForService(\n    credentialFormatService: DidCommProofFormatService,\n    formats: DidCommProofFormatSpec[],\n    attachments: DidCommAttachment[]\n  ) {\n    const attachmentId = this.getAttachmentIdForService(credentialFormatService, formats)\n    const attachment = attachments.find((attachment) => attachment.id === attachmentId)\n\n    if (!attachment) {\n      throw new CredoError(`DidCommAttachment with id ${attachmentId} not found in attachments.`)\n    }\n\n    return attachment\n  }\n\n  private getAttachmentIdForService(\n    credentialFormatService: DidCommProofFormatService,\n    formats: DidCommProofFormatSpec[]\n  ) {\n    const format = formats.find((format) => credentialFormatService.supportsFormat(format.format))\n\n    if (!format) throw new CredoError(`No attachment found for service ${credentialFormatService.formatKey}`)\n\n    return format.attachmentId\n  }\n}\n"],"mappings":"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"}