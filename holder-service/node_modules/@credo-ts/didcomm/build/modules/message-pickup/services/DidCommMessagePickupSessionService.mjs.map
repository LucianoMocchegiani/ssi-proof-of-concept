{"version":3,"file":"DidCommMessagePickupSessionService.mjs","names":[],"sources":["../../../../src/modules/message-pickup/services/DidCommMessagePickupSessionService.ts"],"sourcesContent":["import type { AgentContext } from '@credo-ts/core'\nimport { EventEmitter, InjectionSymbols, injectable, utils } from '@credo-ts/core'\nimport { type Subject, takeUntil } from 'rxjs'\nimport type { DidCommTransportSessionRemovedEvent } from '../../../transport'\nimport { DidCommTransportEventTypes } from '../../../transport'\nimport type {\n  DidCommMessagePickupLiveSessionSavedEvent,\n  MessagePickupLiveSessionRemovedEvent,\n} from '../DidCommMessagePickupEvents'\nimport { DidCommMessagePickupEventTypes } from '../DidCommMessagePickupEvents'\nimport type { DidCommMessagePickupSession, DidCommMessagePickupSessionRole } from '../DidCommMessagePickupSession'\n\n/**\n * @internal\n * The Message Pickup session service keeps track of all {@link DidCommMessagePickupSession}\n *\n * It is initially intended for Message Holder/Mediator role, where only Live Mode sessions are\n * considered.\n */\n@injectable()\nexport class DidCommMessagePickupSessionService {\n  private sessions: DidCommMessagePickupSession[]\n\n  public constructor() {\n    this.sessions = []\n  }\n\n  public start(agentContext: AgentContext) {\n    const stop$ = agentContext.dependencyManager.resolve<Subject<boolean>>(InjectionSymbols.Stop$)\n    const eventEmitter = agentContext.dependencyManager.resolve(EventEmitter)\n    this.sessions = []\n\n    eventEmitter\n      .observable<DidCommTransportSessionRemovedEvent>(DidCommTransportEventTypes.DidCommTransportSessionRemoved)\n      .pipe(takeUntil(stop$))\n      .subscribe({\n        next: (e) => {\n          // Find the live mode session that matches the transport session being removed\n          const liveModeSession = this.sessions.find((session) => session.transportSessionId === e.payload.session.id)\n          if (liveModeSession) this.removeLiveSession(agentContext, { connectionId: liveModeSession.connectionId })\n        },\n      })\n  }\n\n  public getLiveSession(_agentContext: AgentContext, sessionId: string) {\n    return this.sessions.find((session) => session.id === sessionId)\n  }\n\n  public getLiveSessionByConnectionId(\n    _agentContext: AgentContext,\n    options: { connectionId: string; role?: DidCommMessagePickupSessionRole }\n  ) {\n    const { connectionId, role } = options\n\n    return this.sessions.find(\n      (session) => session.connectionId === connectionId && (role === undefined || role === session.role)\n    )\n  }\n\n  public saveLiveSession(\n    agentContext: AgentContext,\n    options: {\n      connectionId: string\n      protocolVersion: string\n      role: DidCommMessagePickupSessionRole\n      transportSessionId: string\n    }\n  ) {\n    const { connectionId, protocolVersion, role, transportSessionId } = options\n\n    // First remove any live session for the given connection Id\n    this.removeLiveSession(agentContext, { connectionId })\n\n    const session: DidCommMessagePickupSession = {\n      id: utils.uuid(),\n      connectionId,\n      protocolVersion,\n      role,\n      transportSessionId,\n    }\n\n    this.sessions.push(session)\n\n    const eventEmitter = agentContext.dependencyManager.resolve(EventEmitter)\n    eventEmitter.emit<DidCommMessagePickupLiveSessionSavedEvent>(agentContext, {\n      type: DidCommMessagePickupEventTypes.LiveSessionSaved,\n      payload: {\n        session,\n      },\n    })\n  }\n\n  public removeLiveSession(agentContext: AgentContext, options: { connectionId: string }) {\n    const itemIndex = this.sessions.findIndex((session) => session.connectionId === options.connectionId)\n\n    if (itemIndex > -1) {\n      const [session] = this.sessions.splice(itemIndex, 1)\n      const eventEmitter = agentContext.dependencyManager.resolve(EventEmitter)\n\n      eventEmitter.emit<MessagePickupLiveSessionRemovedEvent>(agentContext, {\n        type: DidCommMessagePickupEventTypes.LiveSessionRemoved,\n        payload: {\n          session,\n        },\n      })\n    }\n  }\n}\n"],"mappings":";;;;;;;;;AAoBO,+CAAM,mCAAmC;CAG9C,AAAO,cAAc;AACnB,OAAK,WAAW,EAAE;;CAGpB,AAAO,MAAM,cAA4B;EACvC,MAAM,QAAQ,aAAa,kBAAkB,QAA0B,iBAAiB,MAAM;EAC9F,MAAM,eAAe,aAAa,kBAAkB,QAAQ,aAAa;AACzE,OAAK,WAAW,EAAE;AAElB,eACG,WAAgD,2BAA2B,+BAA+B,CAC1G,KAAK,UAAU,MAAM,CAAC,CACtB,UAAU,EACT,OAAO,MAAM;GAEX,MAAM,kBAAkB,KAAK,SAAS,MAAM,YAAY,QAAQ,uBAAuB,EAAE,QAAQ,QAAQ,GAAG;AAC5G,OAAI,gBAAiB,MAAK,kBAAkB,cAAc,EAAE,cAAc,gBAAgB,cAAc,CAAC;KAE5G,CAAC;;CAGN,AAAO,eAAe,eAA6B,WAAmB;AACpE,SAAO,KAAK,SAAS,MAAM,YAAY,QAAQ,OAAO,UAAU;;CAGlE,AAAO,6BACL,eACA,SACA;EACA,MAAM,EAAE,cAAc,SAAS;AAE/B,SAAO,KAAK,SAAS,MAClB,YAAY,QAAQ,iBAAiB,iBAAiB,SAAS,UAAa,SAAS,QAAQ,MAC/F;;CAGH,AAAO,gBACL,cACA,SAMA;EACA,MAAM,EAAE,cAAc,iBAAiB,MAAM,uBAAuB;AAGpE,OAAK,kBAAkB,cAAc,EAAE,cAAc,CAAC;EAEtD,MAAM,UAAuC;GAC3C,IAAI,MAAM,MAAM;GAChB;GACA;GACA;GACA;GACD;AAED,OAAK,SAAS,KAAK,QAAQ;AAG3B,EADqB,aAAa,kBAAkB,QAAQ,aAAa,CAC5D,KAAgD,cAAc;GACzE,MAAM,+BAA+B;GACrC,SAAS,EACP,SACD;GACF,CAAC;;CAGJ,AAAO,kBAAkB,cAA4B,SAAmC;EACtF,MAAM,YAAY,KAAK,SAAS,WAAW,YAAY,QAAQ,iBAAiB,QAAQ,aAAa;AAErG,MAAI,YAAY,IAAI;GAClB,MAAM,CAAC,WAAW,KAAK,SAAS,OAAO,WAAW,EAAE;AAGpD,GAFqB,aAAa,kBAAkB,QAAQ,aAAa,CAE5D,KAA2C,cAAc;IACpE,MAAM,+BAA+B;IACrC,SAAS,EACP,SACD;IACF,CAAC;;;;iDArFP,YAAY"}