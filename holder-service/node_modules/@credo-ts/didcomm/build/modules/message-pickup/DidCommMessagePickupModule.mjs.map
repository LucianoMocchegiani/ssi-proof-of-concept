{"version":3,"file":"DidCommMessagePickupModule.mjs","names":[],"sources":["../../../src/modules/message-pickup/DidCommMessagePickupModule.ts"],"sourcesContent":["import type { AgentContext, ApiModule, Constructor, DependencyManager, Optional } from '@credo-ts/core'\nimport { DidCommFeatureRegistry } from '../../DidCommFeatureRegistry'\nimport { DidCommMessageHandlerRegistry } from '../../DidCommMessageHandlerRegistry'\nimport { DidCommMessagePickupApi } from './DidCommMessagePickupApi'\nimport type { DidCommMessagePickupModuleConfigOptions } from './DidCommMessagePickupModuleConfig'\nimport { DidCommMessagePickupModuleConfig } from './DidCommMessagePickupModuleConfig'\nimport { DidCommMessagePickupV1Protocol, DidCommMessagePickupV2Protocol } from './protocol'\nimport type { DidCommMessagePickupProtocol } from './protocol/DidCommMessagePickupProtocol'\nimport { DidCommMessagePickupSessionService } from './services'\n\n/**\n * Default protocols that will be registered if the `protocols` property is not configured.\n */\nexport type DefaultDidCommMessagePickupProtocols = [DidCommMessagePickupV1Protocol, DidCommMessagePickupV2Protocol]\n\n// MessagePickupModuleOptions makes the protocols property optional from the config, as it will set it when not provided.\nexport type DidCommMessagePickupModuleOptions<MessagePickupProtocols extends DidCommMessagePickupProtocol[]> = Optional<\n  DidCommMessagePickupModuleConfigOptions<MessagePickupProtocols>,\n  'protocols'\n>\n\nexport class DidCommMessagePickupModule<\n  MessagePickupProtocols extends DidCommMessagePickupProtocol[] = DefaultDidCommMessagePickupProtocols,\n> implements ApiModule\n{\n  public readonly config: DidCommMessagePickupModuleConfig<MessagePickupProtocols>\n\n  // Infer Api type from the config\n  public readonly api: Constructor<DidCommMessagePickupApi<MessagePickupProtocols>> = DidCommMessagePickupApi\n\n  public constructor(config?: DidCommMessagePickupModuleOptions<MessagePickupProtocols>) {\n    this.config = new DidCommMessagePickupModuleConfig({\n      ...config,\n      protocols: config?.protocols ?? [new DidCommMessagePickupV1Protocol(), new DidCommMessagePickupV2Protocol()],\n    }) as DidCommMessagePickupModuleConfig<MessagePickupProtocols>\n  }\n\n  /**\n   * Registers the dependencies of the message pickup answer module on the dependency manager.\n   */\n  public register(dependencyManager: DependencyManager) {\n    // Config\n    dependencyManager.registerInstance(DidCommMessagePickupModuleConfig, this.config)\n\n    // Services\n    dependencyManager.registerSingleton(DidCommMessagePickupSessionService)\n  }\n\n  public async initialize(agentContext: AgentContext): Promise<void> {\n    // Protocol needs to register feature registry items and handlers\n    const messageHandlerRegistry = agentContext.dependencyManager.resolve(DidCommMessageHandlerRegistry)\n    const featureRegistry = agentContext.dependencyManager.resolve(DidCommFeatureRegistry)\n\n    for (const protocol of this.config.protocols) {\n      protocol.register(messageHandlerRegistry, featureRegistry)\n    }\n  }\n\n  public async onInitializeContext(agentContext: AgentContext): Promise<void> {\n    // We only support initialization of message pickup for the root agent\n    if (!agentContext.isRootAgentContext) return\n\n    // FIXME: this does not take into account multi-tenant agents, need to think how to separate based on context\n    const messagePickupSessionService = agentContext.dependencyManager.resolve(DidCommMessagePickupSessionService)\n    messagePickupSessionService.start(agentContext)\n  }\n}\n"],"mappings":";;;;;;;;;;;AAqBA,IAAa,6BAAb,MAGA;CAME,AAAO,YAAY,QAAoE;OAFvE,MAAoE;AAGlF,OAAK,SAAS,IAAI,iCAAiC;GACjD,GAAG;GACH,WAAW,QAAQ,aAAa,CAAC,IAAI,gCAAgC,EAAE,IAAI,gCAAgC,CAAC;GAC7G,CAAC;;;;;CAMJ,AAAO,SAAS,mBAAsC;AAEpD,oBAAkB,iBAAiB,kCAAkC,KAAK,OAAO;AAGjF,oBAAkB,kBAAkB,mCAAmC;;CAGzE,MAAa,WAAW,cAA2C;EAEjE,MAAM,yBAAyB,aAAa,kBAAkB,QAAQ,8BAA8B;EACpG,MAAM,kBAAkB,aAAa,kBAAkB,QAAQ,uBAAuB;AAEtF,OAAK,MAAM,YAAY,KAAK,OAAO,UACjC,UAAS,SAAS,wBAAwB,gBAAgB;;CAI9D,MAAa,oBAAoB,cAA2C;AAE1E,MAAI,CAAC,aAAa,mBAAoB;AAItC,EADoC,aAAa,kBAAkB,QAAQ,mCAAmC,CAClF,MAAM,aAAa"}