{"version":3,"file":"DidCommMessagePickupV1Protocol.mjs","names":[],"sources":["../../../../../src/modules/message-pickup/protocol/v1/DidCommMessagePickupV1Protocol.ts"],"sourcesContent":["import type { AgentContext } from '@credo-ts/core'\nimport { CredoError, EventEmitter, injectable } from '@credo-ts/core'\nimport type { DidCommMessageReceivedEvent } from '../../../../DidCommEvents'\nimport { DidCommEventTypes } from '../../../../DidCommEvents'\nimport type { DidCommFeatureRegistry } from '../../../../DidCommFeatureRegistry'\nimport type { DidCommMessage } from '../../../../DidCommMessage'\nimport type { DidCommMessageHandlerRegistry } from '../../../../DidCommMessageHandlerRegistry'\nimport { DidCommModuleConfig } from '../../../../DidCommModuleConfig'\nimport type { DidCommInboundMessageContext } from '../../../../models'\nimport { DidCommOutboundMessageContext, DidCommProtocol } from '../../../../models'\nimport type { MessagePickupCompletedEvent } from '../../DidCommMessagePickupEvents'\nimport { DidCommMessagePickupEventTypes } from '../../DidCommMessagePickupEvents'\nimport { DidCommMessagePickupModuleConfig } from '../../DidCommMessagePickupModuleConfig'\nimport { DidCommBaseMessagePickupProtocol } from '../DidCommBaseMessagePickupProtocol'\nimport type {\n  DeliverMessagesProtocolOptions,\n  DeliverMessagesProtocolReturnType,\n  PickupMessagesProtocolOptions,\n  PickupMessagesProtocolReturnType,\n  SetLiveDeliveryModeProtocolReturnType,\n} from '../DidCommMessagePickupProtocolOptions'\nimport { DidCommBatchHandler, DidCommBatchPickupHandler } from './handlers'\nimport { DidCommBatchMessage, DidCommBatchMessageMessage, DidCommBatchPickupMessage } from './messages'\n\n@injectable()\nexport class DidCommMessagePickupV1Protocol extends DidCommBaseMessagePickupProtocol {\n  /**\n   * The version of the message pickup protocol this class supports\n   */\n  public readonly version = 'v1' as const\n\n  /**\n   * Registers the protocol implementation (handlers, feature registry) on the agent.\n   */\n  public register(\n    messageHandlerRegistry: DidCommMessageHandlerRegistry,\n    featureRegistry: DidCommFeatureRegistry\n  ): void {\n    messageHandlerRegistry.registerMessageHandlers([new DidCommBatchPickupHandler(this), new DidCommBatchHandler(this)])\n\n    featureRegistry.register(\n      new DidCommProtocol({\n        id: 'https://didcomm.org/messagepickup/1.0',\n        roles: ['message_holder', 'recipient', 'batch_sender', 'batch_recipient'],\n      })\n    )\n  }\n\n  public async createPickupMessage(\n    agentContext: AgentContext,\n    options: PickupMessagesProtocolOptions\n  ): Promise<PickupMessagesProtocolReturnType<DidCommMessage>> {\n    const { connectionRecord, batchSize } = options\n    connectionRecord.assertReady()\n\n    const config = agentContext.dependencyManager.resolve(DidCommMessagePickupModuleConfig)\n    const message = new DidCommBatchPickupMessage({\n      batchSize: batchSize ?? config.maximumBatchSize,\n    })\n\n    return { message }\n  }\n\n  public async createDeliveryMessage(\n    agentContext: AgentContext,\n    options: DeliverMessagesProtocolOptions\n  ): Promise<DeliverMessagesProtocolReturnType<DidCommMessage> | undefined> {\n    const { connectionRecord, batchSize, messages } = options\n    connectionRecord.assertReady()\n\n    const queueTransportRepository =\n      agentContext.dependencyManager.resolve(DidCommModuleConfig).queueTransportRepository\n\n    const messagesToDeliver =\n      messages ??\n      (await queueTransportRepository.takeFromQueue(agentContext, {\n        connectionId: connectionRecord.id,\n        limit: batchSize, // TODO: Define as config parameter for message holder side\n        deleteMessages: true,\n      }))\n\n    const batchMessages = messagesToDeliver.map(\n      (msg) =>\n        new DidCommBatchMessageMessage({\n          id: msg.id,\n          message: msg.encryptedMessage,\n        })\n    )\n\n    if (messagesToDeliver.length > 0) {\n      const message = new DidCommBatchMessage({\n        messages: batchMessages,\n      })\n\n      return { message }\n    }\n  }\n\n  public async setLiveDeliveryMode(): Promise<SetLiveDeliveryModeProtocolReturnType<DidCommMessage>> {\n    throw new CredoError('Live Delivery mode not supported in Message Pickup V1 protocol')\n  }\n\n  public async processBatchPickup(messageContext: DidCommInboundMessageContext<DidCommBatchPickupMessage>) {\n    // Assert ready connection\n    const connection = messageContext.assertReadyConnection()\n\n    const { message, agentContext } = messageContext\n\n    const queueTransportRepository =\n      agentContext.dependencyManager.resolve(DidCommModuleConfig).queueTransportRepository\n\n    const messages = await queueTransportRepository.takeFromQueue(agentContext, {\n      connectionId: connection.id,\n      limit: message.batchSize,\n      deleteMessages: true,\n    })\n\n    const batchMessages = messages.map(\n      (msg) =>\n        new DidCommBatchMessageMessage({\n          id: msg.id,\n          message: msg.encryptedMessage,\n        })\n    )\n\n    const batchMessage = new DidCommBatchMessage({\n      messages: batchMessages,\n      threadId: message.threadId,\n    })\n\n    return new DidCommOutboundMessageContext(batchMessage, { agentContext: messageContext.agentContext, connection })\n  }\n\n  public async processBatch(messageContext: DidCommInboundMessageContext<DidCommBatchMessage>) {\n    const { message: batchMessage, agentContext } = messageContext\n    const { messages } = batchMessage\n\n    const connection = messageContext.assertReadyConnection()\n\n    const eventEmitter = messageContext.agentContext.dependencyManager.resolve(EventEmitter)\n\n    for (const message of messages) {\n      eventEmitter.emit<DidCommMessageReceivedEvent>(messageContext.agentContext, {\n        type: DidCommEventTypes.DidCommMessageReceived,\n        payload: {\n          message: message.message,\n          contextCorrelationId: messageContext.agentContext.contextCorrelationId,\n        },\n      })\n    }\n\n    // A Batch message without messages at all means that we are done with the\n    // message pickup process (Note: this is not optimal since we'll always doing an extra\n    // Batch Pickup. However, it is safer and should be faster than waiting an entire loop\n    // interval to retrieve more messages)\n    if (messages.length === 0) {\n      eventEmitter.emit<MessagePickupCompletedEvent>(messageContext.agentContext, {\n        type: DidCommMessagePickupEventTypes.MessagePickupCompleted,\n        payload: {\n          connection,\n          threadId: batchMessage.threadId,\n        },\n      })\n      return null\n    }\n\n    return (await this.createPickupMessage(agentContext, { connectionRecord: connection })).message\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;AAyBO,2CAAM,uCAAuC,iCAAiC;;;OAInE,UAAU;;;;;CAK1B,AAAO,SACL,wBACA,iBACM;AACN,yBAAuB,wBAAwB,CAAC,IAAI,0BAA0B,KAAK,EAAE,IAAI,oBAAoB,KAAK,CAAC,CAAC;AAEpH,kBAAgB,SACd,IAAI,gBAAgB;GAClB,IAAI;GACJ,OAAO;IAAC;IAAkB;IAAa;IAAgB;IAAkB;GAC1E,CAAC,CACH;;CAGH,MAAa,oBACX,cACA,SAC2D;EAC3D,MAAM,EAAE,kBAAkB,cAAc;AACxC,mBAAiB,aAAa;EAE9B,MAAM,SAAS,aAAa,kBAAkB,QAAQ,iCAAiC;AAKvF,SAAO,EAAE,SAJO,IAAI,0BAA0B,EAC5C,WAAW,aAAa,OAAO,kBAChC,CAAC,EAEgB;;CAGpB,MAAa,sBACX,cACA,SACwE;EACxE,MAAM,EAAE,kBAAkB,WAAW,aAAa;AAClD,mBAAiB,aAAa;EAE9B,MAAM,2BACJ,aAAa,kBAAkB,QAAQ,oBAAoB,CAAC;EAE9D,MAAM,oBACJ,YACC,MAAM,yBAAyB,cAAc,cAAc;GAC1D,cAAc,iBAAiB;GAC/B,OAAO;GACP,gBAAgB;GACjB,CAAC;EAEJ,MAAM,gBAAgB,kBAAkB,KACrC,QACC,IAAI,2BAA2B;GAC7B,IAAI,IAAI;GACR,SAAS,IAAI;GACd,CAAC,CACL;AAED,MAAI,kBAAkB,SAAS,EAK7B,QAAO,EAAE,SAJO,IAAI,oBAAoB,EACtC,UAAU,eACX,CAAC,EAEgB;;CAItB,MAAa,sBAAsF;AACjG,QAAM,IAAI,WAAW,iEAAiE;;CAGxF,MAAa,mBAAmB,gBAAyE;EAEvG,MAAM,aAAa,eAAe,uBAAuB;EAEzD,MAAM,EAAE,SAAS,iBAAiB;AAwBlC,SAAO,IAAI,8BALU,IAAI,oBAAoB;GAC3C,WAfe,MAFf,aAAa,kBAAkB,QAAQ,oBAAoB,CAAC,yBAEd,cAAc,cAAc;IAC1E,cAAc,WAAW;IACzB,OAAO,QAAQ;IACf,gBAAgB;IACjB,CAAC,EAE6B,KAC5B,QACC,IAAI,2BAA2B;IAC7B,IAAI,IAAI;IACR,SAAS,IAAI;IACd,CAAC,CACL;GAIC,UAAU,QAAQ;GACnB,CAAC,EAEqD;GAAE,cAAc,eAAe;GAAc;GAAY,CAAC;;CAGnH,MAAa,aAAa,gBAAmE;EAC3F,MAAM,EAAE,SAAS,cAAc,iBAAiB;EAChD,MAAM,EAAE,aAAa;EAErB,MAAM,aAAa,eAAe,uBAAuB;EAEzD,MAAM,eAAe,eAAe,aAAa,kBAAkB,QAAQ,aAAa;AAExF,OAAK,MAAM,WAAW,SACpB,cAAa,KAAkC,eAAe,cAAc;GAC1E,MAAM,kBAAkB;GACxB,SAAS;IACP,SAAS,QAAQ;IACjB,sBAAsB,eAAe,aAAa;IACnD;GACF,CAAC;AAOJ,MAAI,SAAS,WAAW,GAAG;AACzB,gBAAa,KAAkC,eAAe,cAAc;IAC1E,MAAM,+BAA+B;IACrC,SAAS;KACP;KACA,UAAU,aAAa;KACxB;IACF,CAAC;AACF,UAAO;;AAGT,UAAQ,MAAM,KAAK,oBAAoB,cAAc,EAAE,kBAAkB,YAAY,CAAC,EAAE;;;6CA9I3F,YAAY"}