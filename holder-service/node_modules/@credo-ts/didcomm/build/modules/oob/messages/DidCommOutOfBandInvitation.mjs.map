{"version":3,"file":"DidCommOutOfBandInvitation.mjs","names":[],"sources":["../../../../src/modules/oob/messages/DidCommOutOfBandInvitation.ts"],"sourcesContent":["import { CredoError, IsStringOrInstance, JsonEncoder, JsonTransformer } from '@credo-ts/core'\nimport { Exclude, Expose, Transform, TransformationType, Type } from 'class-transformer'\nimport { ArrayNotEmpty, IsArray, IsInstance, IsOptional, IsUrl, ValidateNested } from 'class-validator'\nimport queryString from 'query-string'\nimport { DidCommMessage } from '../../../DidCommMessage'\nimport { DidCommAttachment, DidCommAttachmentData } from '../../../decorators/attachment/DidCommAttachment'\nimport type { DidCommPlaintextMessage } from '../../../types'\nimport { IsValidMessageType, parseMessageType, replaceLegacyDidSovPrefix } from '../../../util/messageType'\nimport { OutOfBandDidCommService } from '../domain/OutOfBandDidCommService'\nimport { outOfBandServiceToNumAlgo2Did } from '../helpers'\n\n/**\n * The original invitation an out of band invitation was derived from.\n */\nexport enum DidCommInvitationType {\n  OutOfBand = 'out-of-band/1.x',\n  Connection = 'connections/1.x',\n  Connectionless = 'connectionless',\n}\n\nexport interface DidCommOutOfBandInvitationOptions {\n  id?: string\n  label?: string\n  goalCode?: string\n  goal?: string\n  accept?: string[]\n  handshakeProtocols?: string[]\n  services: Array<OutOfBandDidCommService | string>\n  imageUrl?: string\n  appendedAttachments?: DidCommAttachment[]\n}\n\nexport class DidCommOutOfBandInvitation extends DidCommMessage {\n  public constructor(options: DidCommOutOfBandInvitationOptions) {\n    super()\n\n    if (options) {\n      this.id = options.id ?? this.generateId()\n      this.label = options.label\n      this.goalCode = options.goalCode\n      this.goal = options.goal\n      this.accept = options.accept\n      this.handshakeProtocols = options.handshakeProtocols\n      this.services = options.services\n      this.imageUrl = options.imageUrl\n      this.appendedAttachments = options.appendedAttachments\n    }\n  }\n\n  /**\n   * The original type of the invitation. This is not part of the RFC, but allows to identify\n   * from what the oob invitation was originally created (e.g. legacy connectionless invitation).\n   */\n  @Exclude()\n  public invitationType?: DidCommInvitationType\n\n  public addRequest(message: DidCommMessage) {\n    if (!this.requests) this.requests = []\n    const requestAttachment = new DidCommAttachment({\n      id: this.generateId(),\n      mimeType: 'application/json',\n      data: new DidCommAttachmentData({\n        base64: JsonEncoder.toBase64(message.toJSON()),\n      }),\n    })\n    this.requests.push(requestAttachment)\n  }\n\n  public getRequests(): DidCommPlaintextMessage[] | undefined {\n    return this.requests?.map((request) => request.getDataAsJson())\n  }\n\n  public toUrl({ domain }: { domain: string }) {\n    const invitationJson = this.toJSON()\n    const encodedInvitation = JsonEncoder.toBase64URL(invitationJson)\n    const invitationUrl = `${domain}?oob=${encodedInvitation}`\n    return invitationUrl\n  }\n\n  public static fromUrl(invitationUrl: string) {\n    const parsedUrl = queryString.parseUrl(invitationUrl).query\n    const encodedInvitation = parsedUrl.oob\n    if (typeof encodedInvitation === 'string') {\n      const invitationJson = JsonEncoder.fromBase64(encodedInvitation)\n      const invitation = DidCommOutOfBandInvitation.fromJson(invitationJson)\n\n      return invitation\n    }\n    throw new CredoError(\n      'InvitationUrl is invalid. It needs to contain one, and only one, of the following parameters; `oob`'\n    )\n  }\n\n  public static fromJson(json: Record<string, unknown>) {\n    return JsonTransformer.fromJSON(json, DidCommOutOfBandInvitation)\n  }\n\n  public get invitationDids() {\n    const dids = this.getServices().map((didOrService) => {\n      if (typeof didOrService === 'string') {\n        return didOrService\n      }\n      return outOfBandServiceToNumAlgo2Did(didOrService)\n    })\n    return dids\n  }\n\n  // shorthand for services without the need to deal with the String DIDs\n\n  public getServices(): Array<OutOfBandDidCommService | string> {\n    return this.services.map((service) => {\n      if (service instanceof String) return service.toString()\n      return service\n    })\n  }\n  public getDidServices(): Array<string> {\n    return this.getServices().filter((service): service is string => typeof service === 'string')\n  }\n\n  public getInlineServices(): Array<OutOfBandDidCommService> {\n    return this.getServices().filter((service): service is OutOfBandDidCommService => typeof service !== 'string')\n  }\n\n  @Transform(({ value }) => replaceLegacyDidSovPrefix(value), {\n    toClassOnly: true,\n  })\n  @IsValidMessageType(DidCommOutOfBandInvitation.type)\n  public readonly type = DidCommOutOfBandInvitation.type.messageTypeUri\n  public static readonly type = parseMessageType('https://didcomm.org/out-of-band/1.1/invitation')\n\n  public readonly label?: string\n\n  @Expose({ name: 'goal_code' })\n  public readonly goalCode?: string\n\n  public readonly goal?: string\n\n  public readonly accept?: string[]\n  @Transform(({ value }) => value?.map(replaceLegacyDidSovPrefix), { toClassOnly: true })\n  @Expose({ name: 'handshake_protocols' })\n  public handshakeProtocols?: string[]\n\n  @Expose({ name: 'requests~attach' })\n  @Type(() => DidCommAttachment)\n  @IsArray()\n  @ValidateNested({\n    each: true,\n  })\n  @IsInstance(DidCommAttachment, { each: true })\n  @IsOptional()\n  private requests?: DidCommAttachment[]\n\n  @IsArray()\n  @ArrayNotEmpty()\n  @OutOfBandServiceTransformer()\n  @IsStringOrInstance(OutOfBandDidCommService, { each: true })\n  private services!: Array<OutOfBandDidCommService | string | string>\n\n  /**\n   * Custom property. It is not part of the RFC.\n   */\n  @IsOptional()\n  @IsUrl()\n  public readonly imageUrl?: string\n}\n\n/**\n * Decorator that transforms services json to corresponding class instances\n * @note Because of ValidateNested limitation, this produces instances of String for DID services except plain js string\n */\nfunction OutOfBandServiceTransformer() {\n  return Transform(({ value, type }: { value: Array<string | { type: string }>; type: TransformationType }) => {\n    if (type === TransformationType.PLAIN_TO_CLASS) {\n      return value.map((service) => {\n        // did\n        if (typeof service === 'string') return new String(service)\n\n        // inline didcomm service\n        return JsonTransformer.fromJSON(service, OutOfBandDidCommService)\n      })\n    }\n    if (type === TransformationType.CLASS_TO_PLAIN) {\n      return value.map((service) =>\n        typeof service === 'string' || service instanceof String ? service.toString() : JsonTransformer.toJSON(service)\n      )\n    }\n\n    // PLAIN_TO_PLAIN\n    return value\n  })\n}\n"],"mappings":"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"}