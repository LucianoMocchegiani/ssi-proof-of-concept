{"version":3,"file":"OutOfBandDidCommService.mjs","names":[],"sources":["../../../../src/modules/oob/domain/OutOfBandDidCommService.ts"],"sourcesContent":["import type { ResolvedDidCommService } from '@credo-ts/core'\nimport { CredoError, DidDocumentService, DidKey, IsUri, isDid, Kms } from '@credo-ts/core'\nimport type { ValidationOptions } from 'class-validator'\nimport { ArrayNotEmpty, buildMessage, IsOptional, IsString, isString, ValidateBy } from 'class-validator'\n\nexport class OutOfBandDidCommService extends DidDocumentService {\n  public constructor(options: {\n    id: string\n    serviceEndpoint: string\n    recipientKeys: string[]\n    routingKeys?: string[]\n    accept?: string[]\n  }) {\n    super({ ...options, type: OutOfBandDidCommService.type })\n\n    if (options) {\n      this.recipientKeys = options.recipientKeys\n      this.routingKeys = options.routingKeys\n      this.accept = options.accept\n    }\n  }\n\n  public static type = 'did-communication'\n\n  @IsString()\n  @IsUri()\n  public serviceEndpoint!: string\n\n  @ArrayNotEmpty()\n  @IsDidKeyString({ each: true })\n  public recipientKeys!: string[]\n\n  @IsDidKeyString({ each: true })\n  @IsOptional()\n  public routingKeys?: string[]\n\n  @IsString({ each: true })\n  @IsOptional()\n  public accept?: string[]\n\n  public get resolvedDidCommService(): ResolvedDidCommService {\n    return {\n      id: this.id,\n      recipientKeys: this.recipientKeys.map((didKey) => {\n        const publicJwk = DidKey.fromDid(didKey).publicJwk\n        if (!publicJwk.is(Kms.Ed25519PublicJwk)) {\n          throw new CredoError('Expected recipient key for didcomm service to be of type Ed25519')\n        }\n\n        return publicJwk\n      }),\n      routingKeys:\n        this.routingKeys?.map((didKey) => {\n          const publicJwk = DidKey.fromDid(didKey).publicJwk\n          if (!publicJwk.is(Kms.Ed25519PublicJwk)) {\n            throw new CredoError('Expected recipient key for didcomm service to be of type Ed25519')\n          }\n\n          return publicJwk\n        }) ?? [],\n      serviceEndpoint: this.serviceEndpoint,\n    }\n  }\n\n  public static fromResolvedDidCommService(service: ResolvedDidCommService) {\n    return new OutOfBandDidCommService({\n      id: service.id,\n      recipientKeys: service.recipientKeys.map((key) => new DidKey(key).did),\n      routingKeys: service.routingKeys.map((key) => new DidKey(key).did),\n      serviceEndpoint: service.serviceEndpoint,\n    })\n  }\n}\n\n/**\n * Checks if a given value is a did:key did string\n */\nfunction IsDidKeyString(validationOptions?: ValidationOptions): PropertyDecorator {\n  return ValidateBy(\n    {\n      name: 'isDidKeyString',\n      validator: {\n        validate: (value): boolean => isString(value) && isDid(value, 'key'),\n        defaultMessage: buildMessage(\n          (eachPrefix) => `${eachPrefix}$property must be a did:key string`,\n          validationOptions\n        ),\n      },\n    },\n    validationOptions\n  )\n}\n"],"mappings":";;;;;;AAKA,IAAa,0BAAb,MAAa,gCAAgC,mBAAmB;CAC9D,AAAO,YAAY,SAMhB;AACD,QAAM;GAAE,GAAG;GAAS,MAAM,wBAAwB;GAAM,CAAC;AAEzD,MAAI,SAAS;AACX,QAAK,gBAAgB,QAAQ;AAC7B,QAAK,cAAc,QAAQ;AAC3B,QAAK,SAAS,QAAQ;;;CAsB1B,IAAW,yBAAiD;AAC1D,SAAO;GACL,IAAI,KAAK;GACT,eAAe,KAAK,cAAc,KAAK,WAAW;IAChD,MAAM,YAAY,OAAO,QAAQ,OAAO,CAAC;AACzC,QAAI,CAAC,UAAU,GAAG,IAAI,iBAAiB,CACrC,OAAM,IAAI,WAAW,mEAAmE;AAG1F,WAAO;KACP;GACF,aACE,KAAK,aAAa,KAAK,WAAW;IAChC,MAAM,YAAY,OAAO,QAAQ,OAAO,CAAC;AACzC,QAAI,CAAC,UAAU,GAAG,IAAI,iBAAiB,CACrC,OAAM,IAAI,WAAW,mEAAmE;AAG1F,WAAO;KACP,IAAI,EAAE;GACV,iBAAiB,KAAK;GACvB;;CAGH,OAAc,2BAA2B,SAAiC;AACxE,SAAO,IAAI,wBAAwB;GACjC,IAAI,QAAQ;GACZ,eAAe,QAAQ,cAAc,KAAK,QAAQ,IAAI,OAAO,IAAI,CAAC,IAAI;GACtE,aAAa,QAAQ,YAAY,KAAK,QAAQ,IAAI,OAAO,IAAI,CAAC,IAAI;GAClE,iBAAiB,QAAQ;GAC1B,CAAC;;;wBAhDU,OAAO;;CAEpB,UAAU;CACV,OAAO;;;;CAGP,eAAe;CACf,eAAe,EAAE,MAAM,MAAM,CAAC;;;;CAG9B,eAAe,EAAE,MAAM,MAAM,CAAC;CAC9B,YAAY;;;;CAGZ,SAAS,EAAE,MAAM,MAAM,CAAC;CACxB,YAAY;;;;;;AAwCf,SAAS,eAAe,mBAA0D;AAChF,QAAO,WACL;EACE,MAAM;EACN,WAAW;GACT,WAAW,UAAmB,SAAS,MAAM,IAAI,MAAM,OAAO,MAAM;GACpE,gBAAgB,cACb,eAAe,GAAG,WAAW,qCAC9B,kBACD;GACF;EACF,EACD,kBACD"}