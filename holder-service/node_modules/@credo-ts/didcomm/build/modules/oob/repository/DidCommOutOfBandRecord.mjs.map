{"version":3,"file":"DidCommOutOfBandRecord.mjs","names":[],"sources":["../../../../src/modules/oob/repository/DidCommOutOfBandRecord.ts"],"sourcesContent":["import type { TagsBase } from '@credo-ts/core'\nimport { BaseRecord, CredoError, utils } from '@credo-ts/core'\nimport { Type } from 'class-transformer'\nimport { getThreadIdFromPlainTextMessage } from '../../../util/thread'\nimport type { DidCommOutOfBandRole } from '../domain/DidCommOutOfBandRole'\nimport type { DidCommOutOfBandState } from '../domain/DidCommOutOfBandState'\nimport { DidCommOutOfBandInvitation } from '../messages'\nimport type { DidCommOutOfBandRecordMetadata } from './outOfBandRecordMetadataTypes'\n\nexport interface DidCommOutOfBandInlineServiceKey {\n  recipientKeyFingerprint: string\n  kmsKeyId: string\n}\n\ntype DefaultDidCommOutOfBandRecordTags = {\n  role: DidCommOutOfBandRole\n  state: DidCommOutOfBandState\n  invitationId: string\n  threadId?: string\n  /**\n   * The thread ids from the attached request messages from the out\n   * of band invitation.\n   */\n  invitationRequestsThreadIds?: string[]\n}\n\ninterface CustomDidCommOutOfBandRecordTags extends TagsBase {\n  /**\n   * The fingerprints of the recipient keys from the out of band invitation.\n   * When we created the invitation this will be our keys, when we received this\n   * invitation it will be the other parties' keys.\n   */\n  recipientKeyFingerprints: string[]\n\n  /**\n   * The fingerprint from the {@link OutOfBandRecordMetadataKeys.RecipientRouting} recipient key.\n   *\n   * This will always be a key from our recipient\n   */\n  recipientRoutingKeyFingerprint?: string\n}\n\nexport interface DidCommOutOfBandRecordProps {\n  id?: string\n  createdAt?: Date\n  updatedAt?: Date\n  tags?: CustomDidCommOutOfBandRecordTags\n  outOfBandInvitation: DidCommOutOfBandInvitation\n  role: DidCommOutOfBandRole\n  state: DidCommOutOfBandState\n  alias?: string\n  autoAcceptConnection?: boolean\n  reusable?: boolean\n  mediatorId?: string\n  reuseConnectionId?: string\n  threadId?: string\n\n  /**\n   * The keys associated with the inline services of the out of band invitation\n   */\n  invitationInlineServiceKeys?: DidCommOutOfBandInlineServiceKey[]\n}\n\nexport class DidCommOutOfBandRecord extends BaseRecord<\n  DefaultDidCommOutOfBandRecordTags,\n  CustomDidCommOutOfBandRecordTags,\n  DidCommOutOfBandRecordMetadata\n> {\n  @Type(() => DidCommOutOfBandInvitation)\n  public outOfBandInvitation!: DidCommOutOfBandInvitation\n  public role!: DidCommOutOfBandRole\n  public state!: DidCommOutOfBandState\n  public alias?: string\n  public reusable!: boolean\n  public autoAcceptConnection?: boolean\n  public mediatorId?: string\n  public reuseConnectionId?: string\n\n  /**\n   * The keys associated with the inline services of the out of band invitation\n   */\n  invitationInlineServiceKeys?: Array<DidCommOutOfBandInlineServiceKey>\n\n  public static readonly type = 'OutOfBandRecord'\n  public readonly type = DidCommOutOfBandRecord.type\n\n  public constructor(props: DidCommOutOfBandRecordProps) {\n    super()\n\n    if (props) {\n      this.id = props.id ?? utils.uuid()\n      this.createdAt = props.createdAt ?? new Date()\n      this.outOfBandInvitation = props.outOfBandInvitation\n      this.role = props.role\n      this.state = props.state\n      this.alias = props.alias\n      this.autoAcceptConnection = props.autoAcceptConnection\n      this.reusable = props.reusable ?? false\n      this.mediatorId = props.mediatorId\n      this.reuseConnectionId = props.reuseConnectionId\n      this.invitationInlineServiceKeys = props.invitationInlineServiceKeys\n      this._tags = props.tags ?? { recipientKeyFingerprints: [] }\n    }\n  }\n\n  public getTags() {\n    return {\n      ...this._tags,\n      role: this.role,\n      state: this.state,\n      invitationId: this.outOfBandInvitation.id,\n      threadId: this.outOfBandInvitation.threadId,\n      invitationRequestsThreadIds: this.outOfBandInvitation\n        .getRequests()\n        ?.map((r) => getThreadIdFromPlainTextMessage(r)),\n    }\n  }\n\n  public assertRole(expectedRole: DidCommOutOfBandRole) {\n    if (this.role !== expectedRole) {\n      throw new CredoError(`Invalid out-of-band record role ${this.role}, expected is ${expectedRole}.`)\n    }\n  }\n\n  public assertState(expectedStates: DidCommOutOfBandState | DidCommOutOfBandState[]) {\n    if (!Array.isArray(expectedStates)) {\n      expectedStates = [expectedStates]\n    }\n\n    if (!expectedStates.includes(this.state)) {\n      throw new CredoError(\n        `Invalid out-of-band record state ${this.state}, valid states are: ${expectedStates.join(', ')}.`\n      )\n    }\n  }\n}\n"],"mappings":";;;;;;;;;;AA+DA,IAAa,yBAAb,MAAa,+BAA+B,WAI1C;CAmBA,AAAO,YAAY,OAAoC;AACrD,SAAO;OAHO,OAAO,uBAAuB;AAK5C,MAAI,OAAO;AACT,QAAK,KAAK,MAAM,MAAM,MAAM,MAAM;AAClC,QAAK,YAAY,MAAM,6BAAa,IAAI,MAAM;AAC9C,QAAK,sBAAsB,MAAM;AACjC,QAAK,OAAO,MAAM;AAClB,QAAK,QAAQ,MAAM;AACnB,QAAK,QAAQ,MAAM;AACnB,QAAK,uBAAuB,MAAM;AAClC,QAAK,WAAW,MAAM,YAAY;AAClC,QAAK,aAAa,MAAM;AACxB,QAAK,oBAAoB,MAAM;AAC/B,QAAK,8BAA8B,MAAM;AACzC,QAAK,QAAQ,MAAM,QAAQ,EAAE,0BAA0B,EAAE,EAAE;;;CAI/D,AAAO,UAAU;AACf,SAAO;GACL,GAAG,KAAK;GACR,MAAM,KAAK;GACX,OAAO,KAAK;GACZ,cAAc,KAAK,oBAAoB;GACvC,UAAU,KAAK,oBAAoB;GACnC,6BAA6B,KAAK,oBAC/B,aAAa,EACZ,KAAK,MAAM,gCAAgC,EAAE,CAAC;GACnD;;CAGH,AAAO,WAAW,cAAoC;AACpD,MAAI,KAAK,SAAS,aAChB,OAAM,IAAI,WAAW,mCAAmC,KAAK,KAAK,gBAAgB,aAAa,GAAG;;CAItG,AAAO,YAAY,gBAAiE;AAClF,MAAI,CAAC,MAAM,QAAQ,eAAe,CAChC,kBAAiB,CAAC,eAAe;AAGnC,MAAI,CAAC,eAAe,SAAS,KAAK,MAAM,CACtC,OAAM,IAAI,WACR,oCAAoC,KAAK,MAAM,sBAAsB,eAAe,KAAK,KAAK,CAAC,GAChG;;;uBAjDkB,OAAO;YAf7B,WAAW,2BAA2B"}