{"version":3,"file":"converters.mjs","names":[],"sources":["../../../src/modules/oob/converters.ts"],"sourcesContent":["import {\n  DidCommV1Service,\n  DidDocumentBuilder,\n  DidKey,\n  didDocumentToNumAlgo4Did,\n  didKeyToVerkey,\n  verkeyToDidKey,\n} from '@credo-ts/core'\nimport {\n  DidCommConnectionInvitationMessage,\n  type DidCommConnectionInvitationMessageOptions,\n} from '../connections/messages/DidCommConnectionInvitationMessage'\nimport { OutOfBandDidCommService } from './domain/OutOfBandDidCommService'\nimport type { DidCommOutOfBandInvitationOptions } from './messages'\nimport { DidCommInvitationType, DidCommOutOfBandInvitation } from './messages/DidCommOutOfBandInvitation'\n\nexport function convertToNewInvitation(oldInvitation: DidCommConnectionInvitationMessage) {\n  let service: string | OutOfBandDidCommService\n\n  if (oldInvitation.did) {\n    service = oldInvitation.did\n  } else if (oldInvitation.serviceEndpoint && oldInvitation.recipientKeys && oldInvitation.recipientKeys.length > 0) {\n    service = new OutOfBandDidCommService({\n      id: '#inline',\n      recipientKeys: oldInvitation.recipientKeys?.map(verkeyToDidKey),\n      routingKeys: oldInvitation.routingKeys?.map(verkeyToDidKey),\n      serviceEndpoint: oldInvitation.serviceEndpoint,\n    })\n  } else {\n    throw new Error('Missing required serviceEndpoint, routingKeys and/or did fields in connection invitation')\n  }\n\n  const options: DidCommOutOfBandInvitationOptions = {\n    id: oldInvitation.id,\n    label: oldInvitation.label,\n    imageUrl: oldInvitation.imageUrl,\n    appendedAttachments: oldInvitation.appendedAttachments,\n    accept: ['didcomm/aip1', 'didcomm/aip2;env=rfc19'],\n    services: [service],\n    // NOTE: we hardcode it to 1.0, we won't see support for newer versions of the protocol\n    // and we also can process 1.0 if we support newer versions\n    handshakeProtocols: ['https://didcomm.org/connections/1.0'],\n  }\n\n  const outOfBandInvitation = new DidCommOutOfBandInvitation(options)\n  outOfBandInvitation.invitationType = DidCommInvitationType.Connection\n  return outOfBandInvitation\n}\n\nexport function convertToOldInvitation(newInvitation: DidCommOutOfBandInvitation) {\n  // Taking first service, as we can only include one service in a legacy invitation.\n  const [service] = newInvitation.getServices()\n\n  let options: DidCommConnectionInvitationMessageOptions\n  if (typeof service === 'string') {\n    options = {\n      id: newInvitation.id,\n      // label is optional\n      label: newInvitation.label ?? '',\n      did: service,\n      imageUrl: newInvitation.imageUrl,\n      appendedAttachments: newInvitation.appendedAttachments,\n    }\n  } else {\n    options = {\n      id: newInvitation.id,\n      // label is optional\n      label: newInvitation.label ?? '',\n      recipientKeys: service.recipientKeys.map(didKeyToVerkey),\n      routingKeys: service.routingKeys?.map(didKeyToVerkey),\n      serviceEndpoint: service.serviceEndpoint,\n      imageUrl: newInvitation.imageUrl,\n      appendedAttachments: newInvitation.appendedAttachments,\n    }\n  }\n\n  const connectionInvitationMessage = new DidCommConnectionInvitationMessage(options)\n  return connectionInvitationMessage\n}\n\nexport function outOfBandServiceToNumAlgo4Did(service: OutOfBandDidCommService) {\n  // FIXME: add the key entries for the recipientKeys to the did document.\n  const didDocument = new DidDocumentBuilder('')\n    .addService(\n      new DidCommV1Service({\n        id: service.id,\n        serviceEndpoint: service.serviceEndpoint,\n        accept: service.accept,\n        // FIXME: this should actually be local key references, not did:key:123#456 references\n        recipientKeys: service.recipientKeys.map((recipientKey) => {\n          const did = DidKey.fromDid(recipientKey)\n          return `${did.did}#${did.publicJwk.fingerprint}`\n        }),\n        // Map did:key:xxx to actual did:key:xxx#123\n        routingKeys: service.routingKeys?.map((routingKey) => {\n          const did = DidKey.fromDid(routingKey)\n          return `${did.did}#${did.publicJwk.fingerprint}`\n        }),\n      })\n    )\n    .build()\n\n  return didDocumentToNumAlgo4Did(didDocument)\n}\n"],"mappings":";;;;;;AAgBA,SAAgB,uBAAuB,eAAmD;CACxF,IAAI;AAEJ,KAAI,cAAc,IAChB,WAAU,cAAc;UACf,cAAc,mBAAmB,cAAc,iBAAiB,cAAc,cAAc,SAAS,EAC9G,WAAU,IAAI,wBAAwB;EACpC,IAAI;EACJ,eAAe,cAAc,eAAe,IAAI,eAAe;EAC/D,aAAa,cAAc,aAAa,IAAI,eAAe;EAC3D,iBAAiB,cAAc;EAChC,CAAC;KAEF,OAAM,IAAI,MAAM,2FAA2F;CAe7G,MAAM,sBAAsB,IAAI,2BAZmB;EACjD,IAAI,cAAc;EAClB,OAAO,cAAc;EACrB,UAAU,cAAc;EACxB,qBAAqB,cAAc;EACnC,QAAQ,CAAC,gBAAgB,yBAAyB;EAClD,UAAU,CAAC,QAAQ;EAGnB,oBAAoB,CAAC,sCAAsC;EAC5D,CAEkE;AACnE,qBAAoB,iBAAiB,sBAAsB;AAC3D,QAAO;;AAGT,SAAgB,uBAAuB,eAA2C;CAEhF,MAAM,CAAC,WAAW,cAAc,aAAa;CAE7C,IAAI;AACJ,KAAI,OAAO,YAAY,SACrB,WAAU;EACR,IAAI,cAAc;EAElB,OAAO,cAAc,SAAS;EAC9B,KAAK;EACL,UAAU,cAAc;EACxB,qBAAqB,cAAc;EACpC;KAED,WAAU;EACR,IAAI,cAAc;EAElB,OAAO,cAAc,SAAS;EAC9B,eAAe,QAAQ,cAAc,IAAI,eAAe;EACxD,aAAa,QAAQ,aAAa,IAAI,eAAe;EACrD,iBAAiB,QAAQ;EACzB,UAAU,cAAc;EACxB,qBAAqB,cAAc;EACpC;AAIH,QADoC,IAAI,mCAAmC,QAAQ"}