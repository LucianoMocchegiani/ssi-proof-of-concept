{"version":3,"file":"DidCommMediatorRoutingRecord.mjs","names":[],"sources":["../../../../src/modules/routing/repository/DidCommMediatorRoutingRecord.ts"],"sourcesContent":["import type { TagsBase } from '@credo-ts/core'\n\nimport { BaseRecord, CredoError, Kms, TypedArrayEncoder, utils } from '@credo-ts/core'\n\nexport interface DidCommMediatorRoutingRecordProps {\n  id?: string\n  createdAt?: Date\n  routingKeys?: DidCommMediatorRoutingRecordRoutingKey[]\n  tags?: TagsBase\n}\n\nexport interface DidCommMediatorRoutingRecordRoutingKey {\n  /**\n   * The routing key fingerprint\n   */\n  routingKeyFingerprint: string\n\n  /**\n   * The key id in the KMS\n   */\n  kmsKeyId: string\n}\n\nexport type DefaultDidCommMediatorRoutingRecordTags = {\n  routingKeyFingerprints: string[]\n}\n\nexport class DidCommMediatorRoutingRecord extends BaseRecord<DefaultDidCommMediatorRoutingRecordTags> {\n  // TODO: update routing keys here to a did, so we can just point to a did here\n  // and reuse all the key management logic we already have in place for dids\n\n  // String values are base58 encoded keys, previously used\n  // The array of objects is the new format, including a key id\n  public routingKeys!: Array<string | DidCommMediatorRoutingRecordRoutingKey>\n\n  public static readonly type = 'MediatorRoutingRecord'\n  public readonly type = DidCommMediatorRoutingRecord.type\n\n  public static readonly allowCache = true\n  public readonly allowCache = true\n\n  public constructor(props: DidCommMediatorRoutingRecordProps) {\n    super()\n\n    if (props) {\n      this.id = props.id ?? utils.uuid()\n      this.createdAt = props.createdAt ?? new Date()\n      this.routingKeys = props.routingKeys || []\n    }\n  }\n\n  public get routingKeysWithKeyId() {\n    return this.routingKeys.map((routingKey) => {\n      // routing keys in base58 format use the legacy key id\n      if (typeof routingKey === 'string') {\n        const publicJwk = Kms.PublicJwk.fromPublicKey({\n          kty: 'OKP',\n          crv: 'Ed25519',\n          publicKey: TypedArrayEncoder.fromBase58(routingKey),\n        })\n        publicJwk.keyId = publicJwk.legacyKeyId\n\n        return publicJwk\n      }\n\n      // routing keys using new structure, have a key id defined\n      const publicJwk = Kms.PublicJwk.fromFingerprint(routingKey.routingKeyFingerprint)\n      publicJwk.keyId = routingKey.kmsKeyId\n\n      if (!publicJwk.is(Kms.Ed25519PublicJwk)) {\n        throw new CredoError('Expected mediator routing record key to be of type Ed25519.')\n      }\n      return publicJwk\n    })\n  }\n\n  public getTags() {\n    return {\n      ...this._tags,\n      routingKeyFingerprints: this.routingKeys.map((routingKey) =>\n        typeof routingKey === 'string'\n          ? Kms.PublicJwk.fromPublicKey({\n              kty: 'OKP',\n              crv: 'Ed25519',\n              publicKey: TypedArrayEncoder.fromBase58(routingKey),\n            }).fingerprint\n          : routingKey.routingKeyFingerprint\n      ),\n    }\n  }\n}\n"],"mappings":";;;AA2BA,IAAa,+BAAb,MAAa,qCAAqC,WAAoD;CAcpG,AAAO,YAAY,OAA0C;AAC3D,SAAO;OANO,OAAO,6BAA6B;OAGpC,aAAa;AAK3B,MAAI,OAAO;AACT,QAAK,KAAK,MAAM,MAAM,MAAM,MAAM;AAClC,QAAK,YAAY,MAAM,6BAAa,IAAI,MAAM;AAC9C,QAAK,cAAc,MAAM,eAAe,EAAE;;;CAI9C,IAAW,uBAAuB;AAChC,SAAO,KAAK,YAAY,KAAK,eAAe;AAE1C,OAAI,OAAO,eAAe,UAAU;IAClC,MAAM,YAAY,IAAI,UAAU,cAAc;KAC5C,KAAK;KACL,KAAK;KACL,WAAW,kBAAkB,WAAW,WAAW;KACpD,CAAC;AACF,cAAU,QAAQ,UAAU;AAE5B,WAAO;;GAIT,MAAM,YAAY,IAAI,UAAU,gBAAgB,WAAW,sBAAsB;AACjF,aAAU,QAAQ,WAAW;AAE7B,OAAI,CAAC,UAAU,GAAG,IAAI,iBAAiB,CACrC,OAAM,IAAI,WAAW,8DAA8D;AAErF,UAAO;IACP;;CAGJ,AAAO,UAAU;AACf,SAAO;GACL,GAAG,KAAK;GACR,wBAAwB,KAAK,YAAY,KAAK,eAC5C,OAAO,eAAe,WAClB,IAAI,UAAU,cAAc;IAC1B,KAAK;IACL,KAAK;IACL,WAAW,kBAAkB,WAAW,WAAW;IACpD,CAAC,CAAC,cACH,WAAW,sBAChB;GACF;;;6BArDoB,OAAO;6BAGP,aAAa"}