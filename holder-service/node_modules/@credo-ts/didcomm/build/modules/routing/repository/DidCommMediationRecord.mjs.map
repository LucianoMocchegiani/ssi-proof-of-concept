{"version":3,"file":"DidCommMediationRecord.mjs","names":[],"sources":["../../../../src/modules/routing/repository/DidCommMediationRecord.ts"],"sourcesContent":["import { BaseRecord, CredoError, utils } from '@credo-ts/core'\nimport { Transform } from 'class-transformer'\nimport { DidCommMediatorPickupStrategy } from '../DidCommMediatorPickupStrategy'\nimport type { DidCommMediationRole } from '../models/DidCommMediationRole'\nimport { DidCommMediationState } from '../models/DidCommMediationState'\n\nexport interface DidCommMediationRecordProps {\n  id?: string\n  state: DidCommMediationState\n  role: DidCommMediationRole\n  createdAt?: Date\n  connectionId: string\n  threadId: string\n  endpoint?: string\n  recipientKeys?: string[]\n  routingKeys?: string[]\n  pickupStrategy?: DidCommMediatorPickupStrategy\n  tags?: CustomDidCommMediationTags\n}\n\nexport type CustomDidCommMediationTags = {\n  // TODO: we should make this part of the record rather than just a tag\n  default?: boolean\n}\n\nexport type DefaultDidCommMediationTags = {\n  role: DidCommMediationRole\n  connectionId: string\n  state: DidCommMediationState\n  threadId: string\n}\n\nexport class DidCommMediationRecord\n  extends BaseRecord<DefaultDidCommMediationTags, CustomDidCommMediationTags>\n  implements DidCommMediationRecordProps\n{\n  public state!: DidCommMediationState\n  public role!: DidCommMediationRole\n  public connectionId!: string\n  public threadId!: string\n  public endpoint?: string\n\n  /**\n   * Base58 encoded recipient keys\n   */\n  public recipientKeys!: string[]\n\n  /**\n   * Base58 encoded routing keys\n   */\n  public routingKeys!: string[]\n\n  @Transform(({ value }) => {\n    if (value === 'Explicit') {\n      return DidCommMediatorPickupStrategy.PickUpV1\n    }\n    return value\n  })\n  public pickupStrategy?: DidCommMediatorPickupStrategy\n\n  public static readonly type = 'MediationRecord'\n  public readonly type = DidCommMediationRecord.type\n\n  public static readonly allowCache = true\n  public readonly allowCache = true\n\n  public constructor(props: DidCommMediationRecordProps) {\n    super()\n\n    if (props) {\n      this.id = props.id ?? utils.uuid()\n      this.createdAt = props.createdAt ?? new Date()\n      this.connectionId = props.connectionId\n      this.threadId = props.threadId\n      this.recipientKeys = props.recipientKeys || []\n      this.routingKeys = props.routingKeys || []\n      this.state = props.state\n      this.role = props.role\n      this.endpoint = props.endpoint ?? undefined\n      this.pickupStrategy = props.pickupStrategy\n      this._tags = props.tags ?? {}\n    }\n  }\n\n  public getTags() {\n    return {\n      ...this._tags,\n      state: this.state,\n      role: this.role,\n      connectionId: this.connectionId,\n      threadId: this.threadId,\n      recipientKeys: this.recipientKeys,\n    }\n  }\n\n  public addRecipientKey(recipientKey: string) {\n    this.recipientKeys.push(recipientKey)\n  }\n\n  public removeRecipientKey(recipientKey: string): boolean {\n    const index = this.recipientKeys.indexOf(recipientKey, 0)\n    if (index > -1) {\n      this.recipientKeys.splice(index, 1)\n      return true\n    }\n\n    return false\n  }\n\n  public get isReady() {\n    return this.state === DidCommMediationState.Granted\n  }\n\n  public assertReady() {\n    if (!this.isReady) {\n      throw new CredoError(\n        `Mediation record is not ready to be used. Expected ${DidCommMediationState.Granted}, found invalid state ${this.state}`\n      )\n    }\n  }\n\n  public assertState(expectedStates: DidCommMediationState | DidCommMediationState[]) {\n    if (!Array.isArray(expectedStates)) {\n      expectedStates = [expectedStates]\n    }\n\n    if (!expectedStates.includes(this.state)) {\n      throw new CredoError(\n        `Mediation record is in invalid state ${this.state}. Valid states are: ${expectedStates.join(', ')}.`\n      )\n    }\n  }\n\n  public assertRole(expectedRole: DidCommMediationRole) {\n    if (this.role !== expectedRole) {\n      throw new CredoError(`Mediation record has invalid role ${this.role}. Expected role ${expectedRole}.`)\n    }\n  }\n}\n"],"mappings":";;;;;;;;;AAgCA,IAAa,yBAAb,MAAa,+BACH,WAEV;CA+BE,AAAO,YAAY,OAAoC;AACrD,SAAO;OANO,OAAO,uBAAuB;OAG9B,aAAa;AAK3B,MAAI,OAAO;AACT,QAAK,KAAK,MAAM,MAAM,MAAM,MAAM;AAClC,QAAK,YAAY,MAAM,6BAAa,IAAI,MAAM;AAC9C,QAAK,eAAe,MAAM;AAC1B,QAAK,WAAW,MAAM;AACtB,QAAK,gBAAgB,MAAM,iBAAiB,EAAE;AAC9C,QAAK,cAAc,MAAM,eAAe,EAAE;AAC1C,QAAK,QAAQ,MAAM;AACnB,QAAK,OAAO,MAAM;AAClB,QAAK,WAAW,MAAM,YAAY;AAClC,QAAK,iBAAiB,MAAM;AAC5B,QAAK,QAAQ,MAAM,QAAQ,EAAE;;;CAIjC,AAAO,UAAU;AACf,SAAO;GACL,GAAG,KAAK;GACR,OAAO,KAAK;GACZ,MAAM,KAAK;GACX,cAAc,KAAK;GACnB,UAAU,KAAK;GACf,eAAe,KAAK;GACrB;;CAGH,AAAO,gBAAgB,cAAsB;AAC3C,OAAK,cAAc,KAAK,aAAa;;CAGvC,AAAO,mBAAmB,cAA+B;EACvD,MAAM,QAAQ,KAAK,cAAc,QAAQ,cAAc,EAAE;AACzD,MAAI,QAAQ,IAAI;AACd,QAAK,cAAc,OAAO,OAAO,EAAE;AACnC,UAAO;;AAGT,SAAO;;CAGT,IAAW,UAAU;AACnB,SAAO,KAAK,UAAU,sBAAsB;;CAG9C,AAAO,cAAc;AACnB,MAAI,CAAC,KAAK,QACR,OAAM,IAAI,WACR,sDAAsD,sBAAsB,QAAQ,wBAAwB,KAAK,QAClH;;CAIL,AAAO,YAAY,gBAAiE;AAClF,MAAI,CAAC,MAAM,QAAQ,eAAe,CAChC,kBAAiB,CAAC,eAAe;AAGnC,MAAI,CAAC,eAAe,SAAS,KAAK,MAAM,CACtC,OAAM,IAAI,WACR,wCAAwC,KAAK,MAAM,sBAAsB,eAAe,KAAK,KAAK,CAAC,GACpG;;CAIL,AAAO,WAAW,cAAoC;AACpD,MAAI,KAAK,SAAS,aAChB,OAAM,IAAI,WAAW,qCAAqC,KAAK,KAAK,kBAAkB,aAAa,GAAG;;;uBA3EnF,OAAO;uBAGP,aAAa;YAXnC,WAAW,EAAE,YAAY;AACxB,KAAI,UAAU,WACZ,QAAO,8BAA8B;AAEvC,QAAO;EACP"}