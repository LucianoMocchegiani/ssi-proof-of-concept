{"version":3,"file":"DidCommMediatorModule.mjs","names":[],"sources":["../../../src/modules/routing/DidCommMediatorModule.ts"],"sourcesContent":["import type { AgentContext, DependencyManager, Module } from '@credo-ts/core'\nimport { DidCommFeatureRegistry } from '../../DidCommFeatureRegistry'\nimport { DidCommMessageHandlerRegistry } from '../../DidCommMessageHandlerRegistry'\nimport { DidCommProtocol } from '../../models'\nimport { DidCommMediatorApi } from './DidCommMediatorApi'\nimport type { DidCommMediatorModuleConfigOptions } from './DidCommMediatorModuleConfig'\nimport { DidCommMediatorModuleConfig } from './DidCommMediatorModuleConfig'\nimport { DidCommForwardHandler } from './handlers/DidCommForwardHandler'\nimport { DidCommKeylistUpdateHandler } from './handlers/DidCommKeylistUpdateHandler'\nimport { DidCommMediationRequestHandler } from './handlers/DidCommMediationRequestHandler'\nimport { DidCommMediationRole } from './models'\nimport { DidCommMediationRepository, DidCommMediatorRoutingRepository } from './repository'\nimport { DidCommMediatorService } from './services'\n\nexport class DidCommMediatorModule implements Module {\n  public readonly config: DidCommMediatorModuleConfig\n  public readonly api = DidCommMediatorApi\n\n  public constructor(config?: DidCommMediatorModuleConfigOptions) {\n    this.config = new DidCommMediatorModuleConfig(config)\n  }\n\n  /**\n   * Registers the dependencies of the question answer module on the dependency manager.\n   */\n  public register(dependencyManager: DependencyManager) {\n    // Config\n    dependencyManager.registerInstance(DidCommMediatorModuleConfig, this.config)\n\n    // Services\n    dependencyManager.registerSingleton(DidCommMediatorService)\n\n    // Repositories\n    dependencyManager.registerSingleton(DidCommMediationRepository)\n    dependencyManager.registerSingleton(DidCommMediatorRoutingRepository)\n  }\n\n  public async initialize(agentContext: AgentContext): Promise<void> {\n    const featureRegistry = agentContext.dependencyManager.resolve(DidCommFeatureRegistry)\n    const messageHandlerRegistry = agentContext.resolve(DidCommMessageHandlerRegistry)\n    const mediatorService = agentContext.resolve(DidCommMediatorService)\n\n    messageHandlerRegistry.registerMessageHandler(new DidCommKeylistUpdateHandler(mediatorService))\n    messageHandlerRegistry.registerMessageHandler(new DidCommForwardHandler(mediatorService))\n    messageHandlerRegistry.registerMessageHandler(new DidCommMediationRequestHandler(mediatorService, this.config))\n\n    featureRegistry.register(\n      new DidCommProtocol({\n        id: 'https://didcomm.org/coordinate-mediation/1.0',\n        roles: [DidCommMediationRole.Mediator],\n      })\n    )\n  }\n\n  public async onInitializeContext(agentContext: AgentContext): Promise<void> {\n    // Mediator initialization only supported for root agent\n    if (!agentContext.isRootAgentContext) return\n\n    const mediatorService = agentContext.dependencyManager.resolve(DidCommMediatorService)\n    agentContext.config.logger.debug('Mediator routing record not loaded yet, retrieving from storage')\n    const routingRecord = await mediatorService.findMediatorRoutingRecord(agentContext)\n\n    // If we don't have a routing record yet for this tenant, create it\n    if (!routingRecord) {\n      agentContext.config.logger.debug('Mediator routing record does not exist yet, creating routing keys and record')\n      await mediatorService.createMediatorRoutingRecord(agentContext)\n    }\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;AAcA,IAAa,wBAAb,MAAqD;CAInD,AAAO,YAAY,QAA6C;OAFhD,MAAM;AAGpB,OAAK,SAAS,IAAI,4BAA4B,OAAO;;;;;CAMvD,AAAO,SAAS,mBAAsC;AAEpD,oBAAkB,iBAAiB,6BAA6B,KAAK,OAAO;AAG5E,oBAAkB,kBAAkB,uBAAuB;AAG3D,oBAAkB,kBAAkB,2BAA2B;AAC/D,oBAAkB,kBAAkB,iCAAiC;;CAGvE,MAAa,WAAW,cAA2C;EACjE,MAAM,kBAAkB,aAAa,kBAAkB,QAAQ,uBAAuB;EACtF,MAAM,yBAAyB,aAAa,QAAQ,8BAA8B;EAClF,MAAM,kBAAkB,aAAa,QAAQ,uBAAuB;AAEpE,yBAAuB,uBAAuB,IAAI,4BAA4B,gBAAgB,CAAC;AAC/F,yBAAuB,uBAAuB,IAAI,sBAAsB,gBAAgB,CAAC;AACzF,yBAAuB,uBAAuB,IAAI,+BAA+B,iBAAiB,KAAK,OAAO,CAAC;AAE/G,kBAAgB,SACd,IAAI,gBAAgB;GAClB,IAAI;GACJ,OAAO,CAAC,qBAAqB,SAAS;GACvC,CAAC,CACH;;CAGH,MAAa,oBAAoB,cAA2C;AAE1E,MAAI,CAAC,aAAa,mBAAoB;EAEtC,MAAM,kBAAkB,aAAa,kBAAkB,QAAQ,uBAAuB;AACtF,eAAa,OAAO,OAAO,MAAM,kEAAkE;AAInG,MAAI,CAHkB,MAAM,gBAAgB,0BAA0B,aAAa,EAG/D;AAClB,gBAAa,OAAO,OAAO,MAAM,+EAA+E;AAChH,SAAM,gBAAgB,4BAA4B,aAAa"}