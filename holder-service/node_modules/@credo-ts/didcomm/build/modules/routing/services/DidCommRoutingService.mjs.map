{"version":3,"file":"DidCommRoutingService.mjs","names":[],"sources":["../../../../src/modules/routing/services/DidCommRoutingService.ts"],"sourcesContent":["import type { AgentContext } from '@credo-ts/core'\nimport { EventEmitter, injectable, Kms } from '@credo-ts/core'\nimport { DidCommModuleConfig } from '../../../DidCommModuleConfig'\nimport type { DidCommRouting } from '../../../models'\nimport type { DidCommRoutingCreatedEvent } from '../DidCommRoutingEvents'\nimport { DidCommRoutingEventTypes } from '../DidCommRoutingEvents'\n\nimport { DidCommMediationRecipientService } from './DidCommMediationRecipientService'\n\n@injectable()\nexport class DidCommRoutingService {\n  private mediationRecipientService: DidCommMediationRecipientService\n\n  private eventEmitter: EventEmitter\n\n  public constructor(mediationRecipientService: DidCommMediationRecipientService, eventEmitter: EventEmitter) {\n    this.mediationRecipientService = mediationRecipientService\n\n    this.eventEmitter = eventEmitter\n  }\n\n  public async getRouting(\n    agentContext: AgentContext,\n    { mediatorId, useDefaultMediator = true }: GetRoutingOptions = {}\n  ): Promise<DidCommRouting> {\n    const kms = agentContext.resolve(Kms.KeyManagementApi)\n    const didcommConfig = agentContext.resolve(DidCommModuleConfig)\n\n    // Create and store new key\n    const recipientKey = await kms.createKey({ type: { kty: 'OKP', crv: 'Ed25519' } })\n\n    let routing: DidCommRouting = {\n      endpoints: didcommConfig.endpoints,\n      routingKeys: [],\n      recipientKey: Kms.PublicJwk.fromPublicJwk(recipientKey.publicJwk),\n    }\n\n    // Extend routing with mediator keys (if applicable)\n    routing = await this.mediationRecipientService.addMediationRouting(agentContext, routing, {\n      mediatorId,\n      useDefaultMediator,\n    })\n\n    // Emit event so other parts of the framework can react on keys created\n    this.eventEmitter.emit<DidCommRoutingCreatedEvent>(agentContext, {\n      type: DidCommRoutingEventTypes.RoutingCreatedEvent,\n      payload: {\n        routing,\n      },\n    })\n\n    return routing\n  }\n\n  public async removeRouting(agentContext: AgentContext, options: RemoveRoutingOptions) {\n    await this.mediationRecipientService.removeMediationRouting(agentContext, options)\n  }\n}\n\nexport interface GetRoutingOptions {\n  /**\n   * Identifier of the mediator to use when setting up routing\n   */\n  mediatorId?: string\n\n  /**\n   * Whether to use the default mediator if available and `mediatorId` has not been provided\n   * @default true\n   */\n  useDefaultMediator?: boolean\n}\n\nexport interface RemoveRoutingOptions {\n  /**\n   * Keys to remove routing from\n   */\n  recipientKeys: Kms.PublicJwk<Kms.Ed25519PublicJwk>[]\n\n  /**\n   * Identifier of the mediator used when routing has been set up\n   */\n  mediatorId: string\n}\n"],"mappings":";;;;;;;;;AAUO,kCAAM,sBAAsB;CAKjC,AAAO,YAAY,2BAA6D,cAA4B;AAC1G,OAAK,4BAA4B;AAEjC,OAAK,eAAe;;CAGtB,MAAa,WACX,cACA,EAAE,YAAY,qBAAqB,SAA4B,EAAE,EACxC;EACzB,MAAM,MAAM,aAAa,QAAQ,IAAI,iBAAiB;EACtD,MAAM,gBAAgB,aAAa,QAAQ,oBAAoB;EAG/D,MAAM,eAAe,MAAM,IAAI,UAAU,EAAE,MAAM;GAAE,KAAK;GAAO,KAAK;GAAW,EAAE,CAAC;EAElF,IAAI,UAA0B;GAC5B,WAAW,cAAc;GACzB,aAAa,EAAE;GACf,cAAc,IAAI,UAAU,cAAc,aAAa,UAAU;GAClE;AAGD,YAAU,MAAM,KAAK,0BAA0B,oBAAoB,cAAc,SAAS;GACxF;GACA;GACD,CAAC;AAGF,OAAK,aAAa,KAAiC,cAAc;GAC/D,MAAM,yBAAyB;GAC/B,SAAS,EACP,SACD;GACF,CAAC;AAEF,SAAO;;CAGT,MAAa,cAAc,cAA4B,SAA+B;AACpF,QAAM,KAAK,0BAA0B,uBAAuB,cAAc,QAAQ;;;oCA9CrF,YAAY"}