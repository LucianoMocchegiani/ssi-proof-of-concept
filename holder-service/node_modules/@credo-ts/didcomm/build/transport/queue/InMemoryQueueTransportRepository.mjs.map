{"version":3,"file":"InMemoryQueueTransportRepository.mjs","names":[],"sources":["../../../src/transport/queue/InMemoryQueueTransportRepository.ts"],"sourcesContent":["import { AgentContext, injectable, utils } from '@credo-ts/core'\nimport type { DidCommQueueTransportRepository } from './DidCommQueueTransportRepository'\nimport type { QueuedDidCommMessage } from './QueuedDidCommMessage'\nimport type {\n  AddMessageOptions,\n  GetAvailableMessageCountOptions,\n  RemoveMessagesOptions,\n  TakeFromQueueOptions,\n} from './QueueTransportRepositoryOptions'\n\ninterface InMemoryQueuedMessage extends QueuedDidCommMessage {\n  connectionId: string\n  recipientDids: string[]\n  state: 'pending' | 'sending'\n}\n\n@injectable()\nexport class InMemoryQueueTransportRepository implements DidCommQueueTransportRepository {\n  private messages: InMemoryQueuedMessage[]\n\n  public constructor() {\n    this.messages = []\n  }\n\n  public getAvailableMessageCount(\n    _agentContext: AgentContext,\n    options: GetAvailableMessageCountOptions\n  ): number | Promise<number> {\n    const { connectionId, recipientDid } = options\n\n    const messages = this.messages.filter(\n      (msg) =>\n        msg.connectionId === connectionId &&\n        (recipientDid === undefined || msg.recipientDids.includes(recipientDid)) &&\n        msg.state === 'pending'\n    )\n    return messages.length\n  }\n\n  public takeFromQueue(agentContext: AgentContext, options: TakeFromQueueOptions): QueuedDidCommMessage[] {\n    const { connectionId, recipientDid, limit, deleteMessages } = options\n\n    let messages = this.messages.filter(\n      (msg) =>\n        msg.connectionId === connectionId &&\n        msg.state === 'pending' &&\n        (recipientDid === undefined || msg.recipientDids.includes(recipientDid))\n    )\n\n    const messagesToTake = limit ?? messages.length\n\n    messages = messages.slice(0, messagesToTake)\n\n    agentContext.config.logger.debug(`Taking ${messagesToTake} messages from queue for connection ${connectionId}`)\n\n    // Mark taken messages in order to prevent them of being retrieved again\n    for (const msg of messages) {\n      const index = this.messages.findIndex((item) => item.id === msg.id)\n      if (index !== -1) this.messages[index].state = 'sending'\n    }\n\n    if (deleteMessages) {\n      this.removeMessages(agentContext, { connectionId, messageIds: messages.map((msg) => msg.id) })\n    }\n\n    return messages\n  }\n\n  public addMessage(_agentContext: AgentContext, options: AddMessageOptions) {\n    const { connectionId, recipientDids, payload } = options\n\n    const id = utils.uuid()\n    this.messages.push({\n      id,\n      receivedAt: options.receivedAt ?? new Date(),\n      connectionId,\n      encryptedMessage: payload,\n      recipientDids,\n      state: 'pending',\n    })\n\n    return id\n  }\n\n  public removeMessages(_agentContext: AgentContext, options: RemoveMessagesOptions) {\n    const { messageIds } = options\n\n    for (const messageId of messageIds) {\n      const messageIndex = this.messages.findIndex((item) => item.id === messageId)\n      if (messageIndex > -1) this.messages.splice(messageIndex, 1)\n    }\n  }\n}\n"],"mappings":";;;;;AAiBO,6CAAM,iCAA4E;CAGvF,AAAO,cAAc;AACnB,OAAK,WAAW,EAAE;;CAGpB,AAAO,yBACL,eACA,SAC0B;EAC1B,MAAM,EAAE,cAAc,iBAAiB;AAQvC,SANiB,KAAK,SAAS,QAC5B,QACC,IAAI,iBAAiB,iBACpB,iBAAiB,UAAa,IAAI,cAAc,SAAS,aAAa,KACvE,IAAI,UAAU,UACjB,CACe;;CAGlB,AAAO,cAAc,cAA4B,SAAuD;EACtG,MAAM,EAAE,cAAc,cAAc,OAAO,mBAAmB;EAE9D,IAAI,WAAW,KAAK,SAAS,QAC1B,QACC,IAAI,iBAAiB,gBACrB,IAAI,UAAU,cACb,iBAAiB,UAAa,IAAI,cAAc,SAAS,aAAa,EAC1E;EAED,MAAM,iBAAiB,SAAS,SAAS;AAEzC,aAAW,SAAS,MAAM,GAAG,eAAe;AAE5C,eAAa,OAAO,OAAO,MAAM,UAAU,eAAe,sCAAsC,eAAe;AAG/G,OAAK,MAAM,OAAO,UAAU;GAC1B,MAAM,QAAQ,KAAK,SAAS,WAAW,SAAS,KAAK,OAAO,IAAI,GAAG;AACnE,OAAI,UAAU,GAAI,MAAK,SAAS,OAAO,QAAQ;;AAGjD,MAAI,eACF,MAAK,eAAe,cAAc;GAAE;GAAc,YAAY,SAAS,KAAK,QAAQ,IAAI,GAAG;GAAE,CAAC;AAGhG,SAAO;;CAGT,AAAO,WAAW,eAA6B,SAA4B;EACzE,MAAM,EAAE,cAAc,eAAe,YAAY;EAEjD,MAAM,KAAK,MAAM,MAAM;AACvB,OAAK,SAAS,KAAK;GACjB;GACA,YAAY,QAAQ,8BAAc,IAAI,MAAM;GAC5C;GACA,kBAAkB;GAClB;GACA,OAAO;GACR,CAAC;AAEF,SAAO;;CAGT,AAAO,eAAe,eAA6B,SAAgC;EACjF,MAAM,EAAE,eAAe;AAEvB,OAAK,MAAM,aAAa,YAAY;GAClC,MAAM,eAAe,KAAK,SAAS,WAAW,SAAS,KAAK,OAAO,UAAU;AAC7E,OAAI,eAAe,GAAI,MAAK,SAAS,OAAO,cAAc,EAAE;;;;+CAzEjE,YAAY"}